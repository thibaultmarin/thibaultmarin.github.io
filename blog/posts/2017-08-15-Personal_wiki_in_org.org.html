<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.54 in css mode. -->
<html>
  <head>
    <title>2017-08-15-Personal_wiki_in_org.org</title>
    <style type="text/css">
    <!--
      body {
        color: #657b83;
        background-color: #fdf6e3;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #483d8b;
      }
      .comment {
        /* font-lock-comment-face */
        color: #b22222;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #b22222;
      }
      .constant {
        /* font-lock-constant-face */
        color: #008b8b;
      }
      .css-property {
        /* css-property */
        color: #a0522d;
      }
      .css-selector {
        /* css-selector */
        color: #0000ff;
      }
      .custom {
        /* (:strike-through t) */
        text-decoration: line-through;
      }
      .custom-1 {
        /* (:background "#FFA500") */
        background-color: #FFA500;
      }
      .custom-2 {
        /* (:background "#FFFF00") */
        background-color: #FFFF00;
      }
      .custom-3 {
        /* (:foreground "black") */
        color: #000000;
      }
      .doc {
        /* font-lock-doc-face */
        color: #8b2252;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #0000ff;
      }
      .italic {
        /* italic */
        font-style: italic;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #a020f0;
      }
      .negation-char {
      }
      .org-block {
        /* org-block */
        color: #7f7f7f;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #b22222;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #b22222;
      }
      .org-code {
        /* org-code */
        color: #7f7f7f;
      }
      .org-document-info {
        /* org-document-info */
        color: #191970;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #7f7f7f;
      }
      .org-document-title {
        /* org-document-title */
        color: #191970;
        font-weight: bold;
      }
      .org-done {
        /* org-done */
        color: #228b22;
        font-weight: bold;
      }
      .org-latex-and-related {
        /* org-latex-and-related */
        color: #8b4513;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #0000ff;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #a0522d;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #a020f0;
      }
      .org-link {
        /* org-link */
        color: #3a5fcd;
        text-decoration: underline;
      }
      .org-list-dt {
        /* org-list-dt */
        font-weight: bold;
      }
      .org-macro {
        /* org-macro */
        color: #8b4513;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #b22222;
      }
      .org-property-value {
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #a020f0;
      }
      .org-target {
        /* org-target */
        text-decoration: underline;
      }
      .org-verbatim {
        /* org-verbatim */
        color: #7f7f7f;
      }
      .regexp-grouping-backslash {
        /* font-lock-regexp-grouping-backslash */
        font-weight: bold;
      }
      .regexp-grouping-construct {
        /* font-lock-regexp-grouping-construct */
        font-weight: bold;
      }
      .sh-quoted-exec {
        /* sh-quoted-exec */
        color: #ff00ff;
      }
      .string {
        /* font-lock-string-face */
        color: #8b2252;
      }
      .type {
        /* font-lock-type-face */
        color: #228b22;
      }
      .underline {
        /* underline */
        text-decoration: underline;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #a0522d;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+include: ../source-blocks.org</span>
<span class="org-meta-line">#+setupfile: ../setup.org</span>
<span class="org-document-info-keyword">#+title:</span> <span class="org-document-title">Personal wiki in org
</span><span class="org-document-info-keyword">#+date:</span> <span class="org-document-info">&lt;2017-08-15 Tue&gt;
</span><span class="org-meta-line">#+todo: TODO REVIEW | DONE DEFERRED ABANDONED</span>
<span class="org-meta-line">#+property: COOKIE_DATA todo recursive</span>
<span class="org-meta-line">#+property: header-args :eval no-export :results silent :exports code</span>
<span class="org-meta-line">#+property: header-args+ :comments link</span>
<span class="org-meta-line">#+startup: hideblocks</span>
<span class="org-meta-line">#+macro: tt \nbsp{}</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Introduction</span>

This post describes the setup to generate a personal wiki in org.  It elaborates
on this <span class="org-link"><a href="file:2016-11-13-Personal_website_in_org.org">previous post</a></span> describing the generation of this website.  Generally, the
wiki setup is a simplified version of the website, with a few additions:

- search functionality (implemented client side using <span class="org-link"><a href="#wiki-search">jQuery and Lunr</a></span>),
- support link to <span class="org-link"><a href="http://www.refbase.net">refbase</a></span> instance (bibliography manager).

Compared to other wiki software (e.g. <span class="org-link"><a href="https://www.mediawiki.org/wiki/MediaWiki">MediaWiki</a></span>), this does not include user
management or the ability to edit pages and upload files from the webpage.  On
the other hand, it is fully text-based which allows the use of version control.


<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Requirements</span>

The wiki currently uses the following versions of emacs and org-mode:

<span class="org-meta-line">#+name: el-version</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results replace value :exports results
</span><span class="org-block">(print (format </span><span class="org-block"><span class="string">"%s\n%s"</span></span><span class="org-block">
               (replace-regexp-in-string </span><span class="org-block"><span class="string">"@ .*org-mode"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"@ .../org-mode"</span></span><span class="org-block">
                                         (org-version nil t))
               (emacs-version)))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+results: el-version</span>
<span class="org-code">: Org mode version 9.1.3 (release_9.1.3-206-g1bb9cf @ .../org-mode/lisp/)
: GNU Emacs 25.2.2 (x86_64-pc-linux-gnu, GTK+ Version 3.22.20)
:  of 2017-09-11, modified by Debian
</span>
The emacs-side setup only requires the <span class="org-verbatim">=htmlize=</span> package used during HTML
publishing.

The main requirements for the published wiki are <span class="org-link"><a href="#wiki-js-libs">javascript modules</a></span>:
- <span class="org-link"><span class="org-list-dt"><a href="https://jquery.com">jQuery</a></span></span><span class="org-list-dt"> ::</span> used to <span class="org-link"><a href="#search-js-index-download">asynchronously download the search index from the server</a></span>,
     submit search requests to Lunr and <span class="org-link"><a href="#search-js-display">display the results</a></span>,
- <span class="org-link"><span class="org-list-dt"><a href="https://lunrjs.com">Lunr</a></span></span><span class="org-list-dt"> ::</span> used by the <span class="org-link"><a href="#search-js-search">search tool</a></span>,
- <span class="org-link"><span class="org-list-dt"><a href="https://markjs.io/">=mark.js=</a></span></span><span class="org-list-dt"> ::</span> used to <span class="org-link"><a href="#search-js-highlight">highlight search results</a></span>,
- <span class="org-link"><span class="org-list-dt"><a href="http://www.mathjax.org">MathJax</a></span></span><span class="org-list-dt"> ::</span> used to render equations,
- <span class="org-link"><span class="org-list-dt"><a href="http://orgmode.org/worg/code/org-info-js">=org-info.js=</a></span></span><span class="org-list-dt"> ::</span> org-mode navigation library, used for menus.

The wiki originally relied on <span class="org-link"><a href="https://github.com/caiorss/org-wiki">org-wiki</a></span>, but since my needs are much simpler, it
is no longer used.

Bibliographic citations rely on a <span class="org-link"><a href="http://www.refbase.net">refbase</a></span> instance.  Refbase must be installed
and setup for it to be useful.


<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Org setup</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle my-org-wiki.el</span>
<span class="org-special-keyword">:END:</span>

This section defines the main functions used to maintain the wiki.  When
tangled, it creates the <span class="org-verbatim">=my-org-wiki.el=</span> file, which can then be <span class="org-link"><a href="#dotfiles-org-wiki">loaded and
further configured</a></span> from <span class="org-verbatim">=.emacs=</span>.

<span class="org-meta-line">#+name: el-org-wiki-header</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">my-org-wiki.el --- Personal wiki configuration
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">Commentary:
</span></span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Defines functions for publishing a static wiki.  This file was produced
</span></span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">automatically by wiki.org.  See the wiki.org file for a full description.
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">Code:
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Dependencies
</span></span><span class="org-block">(</span><span class="org-block"><span class="keyword">require</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">htmlize</span></span><span class="org-block">)
(</span><span class="org-block"><span class="keyword">require</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">org</span></span><span class="org-block">)
(</span><span class="org-block"><span class="keyword">require</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">my-refbase</span></span><span class="org-block"> nil t)
(</span><span class="org-block"><span class="keyword">require</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">cl</span></span><span class="org-block"> nil t)
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Custom parameters</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">org-wiki-params</span>
<span class="org-special-keyword">:END:</span>

The wiki can be configured via the following variables:
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-loc)">~org-wiki-location~</a></span></span><span class="org-list-dt"> ::</span> path to wiki (with both <span class="org-verbatim">=.org=</span> and <span class="org-verbatim">=.html=</span> files),
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-index-level)">~org-wiki-index-level-max~</a></span></span><span class="org-list-dt"> ::</span> maximum level for <span class="org-link"><a href="#org-wiki-index">index generation</a></span> (this
     controls the granularity of the search results),
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-index-file)">~org-wiki-index-file~</a></span></span><span class="org-list-dt"> ::</span> filename for search <span class="org-link"><a href="#org-wiki-index">index</a></span> (stored in <span class="org-verbatim">=json=</span> format),
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-preamble)">~org-wiki-preamble~</a></span></span><span class="org-list-dt"> ::</span> <span class="org-link"><a href="el-dotfiles-org-wiki">HTML preamble</a></span> for published HTML pages (defines the
     navigation bar, header and a widget to browse search results, hidden when
     no search is active).
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-ignored)">~org-wiki-ignored-files~</a></span></span><span class="org-list-dt"> ::</span> List of files ignored during generation of index
     page table.
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-index-marker)">~org-wiki-index-page-marker~</a></span></span><span class="org-list-dt"> ::</span> Special string <span class="org-link"><a href="#org-wiki-index-page">automatically replaced</a></span> by a
     list of wiki pages when added to the <span class="org-link"><a href="#wiki-page-index">=index.org=</a></span> page.  Its default value
     is:
<span class="org-meta-line">     #+name: el-index-marker</span>
     <span class="org-code">: #%AUTO-INDEX%#
</span>- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-conf-index-regexp)">~org-wiki-index-regexp-list~</a></span></span><span class="org-list-dt"> ::</span> List of
     regular expression / replacement pairs applied to the content of the index
     sections.  This is used to split strings such as <span class="org-code">~</span><span class="org-link"><span class="org-code"><a href="refbase:Author2000">refbase:Author2000</a></span></span><span class="org-code">~</span> to
     <span class="org-code">~refbase: Author 2000~</span> to allow searches on author names.

<span class="org-meta-line">#+name: el-setup-config</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)" :noweb yes
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Parameters
</span></span><span class="org-block">
(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-location</span></span><span class="org-block"> </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-loc)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"Base directory of wiki."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'org-wiki
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'string)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-index-level-max</span></span><span class="org-block"> 3 </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-index-level)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"Maximum depth for index."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'org-wiki
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'integer)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-index-file</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-index-file)
</span></span><span class="org-block">  </span><span class="org-block"><span class="string">"_resources/wiki.json"</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"Location of lunr index file (relative to `</span></span><span class="org-block"><span class="doc"><span class="constant">org-wiki-location</span></span></span><span class="org-block"><span class="doc">')."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'org-wiki
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'string)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-preamble</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-preamble)
</span></span><span class="org-block">  </span><span class="org-block"><span class="string">"&lt;div class='topnav'&gt;
      &lt;ul&gt;
            &lt;li&gt;&lt;a href='index.html'&gt;Home&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href='search.html'&gt;Search&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href='demo.html' target='_blank'&gt;Help&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
  &lt;/div&gt;

  &lt;div class=\"foreword\"&gt;
      [(last updated: %C) Press &lt;kbd&gt;?&lt;/kbd&gt; for navigation help]
  &lt;/div&gt;

  &lt;div id='searchbar'&gt;
      &lt;input id='searchbar_search' type='text' /&gt; &lt;br/&gt;
      &lt;input type='button' id='searchbar_prev' class='footer-button'
             value='&amp;uarr;' onClick='searchbar_next(false)' /&gt;
      &lt;input type='button' id='searchbar_next' class='footer-button'
             value='&amp;darr;' onClick='searchbar_next(true)' /&gt;
      &lt;input type='button' id='searchbar_clear' class='footer-button'
             value='x' onClick='searchbar_clear()'/&gt;
  &lt;/div&gt;"</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"HTML preamble for all published files."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'org-wiki
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'string)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-ignored-files</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-ignored)
</span></span><span class="org-block">  '(</span><span class="org-block"><span class="string">"setup.org"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"sitemap.org"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"source-blocks.org"</span></span><span class="org-block">)
  </span><span class="org-block"><span class="doc">"List of non-wiki org files."</span></span><span class="org-block">)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-index-page-marker</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-index-marker)
</span></span><span class="org-block">  </span><span class="org-block"><span class="string">"&lt;&lt;el-index-marker()&gt;&gt;"</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"String marker replaced by index table during publishing."</span></span><span class="org-block">)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-wiki-index-regexp-list</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-conf-index-regexp)
</span></span><span class="org-block">  '((</span><span class="org-block"><span class="string">"refbase:</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string"><a href=":alpha:">[[:alpha:]]</a>+</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"refbase: \\1 "</span></span><span class="org-block">)
    (</span><span class="org-block"><span class="string">"file:"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"file: "</span></span><span class="org-block">))
  </span><span class="org-block"><span class="doc">"List of string replacement pairs applied to json index."</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: el-get-index-json</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results value :exports none :eval yes :tangle no
</span><span class="org-block">org-wiki-index-file
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Publishing function</span>

The wiki is updated by running the <span class="org-link"><a href="(org-wiki-publish)">~org-wiki-publish~</a></span> function.  It is a simple
wrapper around <span class="org-code">~org-publish~</span> setting common options.

More specifically, this function performs the following:
- add common <span class="org-link"><a href="#org-wiki-org-setup">org-mode setup</a></span> to every page (via a <span class="org-link"><a href="(org-wiki-publish-setup)">preprocessing hook</a></span>),
- automatically add a <span class="org-link"><a href="#org-wiki-index-page">list of pages</a></span> (by category) to the index page (also using
  a <span class="org-link"><a href="(org-wiki-publish-index-table)">preprocessing hook</a></span>)
- <span class="org-link"><a href="(org-wiki-publish-index)">generate the search index</a></span> file,
- add the <span class="org-link"><a href="(org-wiki-publish-preamble)">HTML preamble</a></span> to every page.

<span class="org-meta-line">#+name: el-setup-publish-function</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)"
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Publishing function
</span></span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">org-wiki-publish</span></span><span class="org-block"> () </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-publish)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"Publish org files to html."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">interactive</span></span><span class="org-block">)
  </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Add preprocessing hook to add #+INCLUDE/#+SETUP lines
</span></span><span class="org-block">  (add-hook 'org-export-before-processing-hook </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-publish-setup)
</span></span><span class="org-block">            '&#8482;/org-wiki-add-setup)
  (add-hook 'org-export-before-processing-hook </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-publish-index-table)
</span></span><span class="org-block">            '&#8482;/org-wiki-insert-index)
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((&#8482;/org-wiki-index-category-list
         </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Create category index table and json search index
</span></span><span class="org-block">         (org-wiki-index (concat </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-publish-index)
</span></span><span class="org-block">                          (expand-file-name org-wiki-location)
                          </span><span class="org-block"><span class="string">"/"</span></span><span class="org-block"> org-wiki-index-file)))
        (pub-plist
         `(</span><span class="org-block"><span class="string">"html"</span></span><span class="org-block">
           </span><span class="org-block"><span class="builtin">:base-directory</span></span><span class="org-block"> ,org-wiki-location
           </span><span class="org-block"><span class="builtin">:base-extension</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"org"</span></span><span class="org-block">
           </span><span class="org-block"><span class="builtin">:publishing-directory</span></span><span class="org-block"> ,org-wiki-location
           </span><span class="org-block"><span class="builtin">:publishing-function</span></span><span class="org-block"> org-html-publish-to-html
           </span><span class="org-block"><span class="builtin">:exclude</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"setup\\.org</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">source-blocks\\.org"</span></span><span class="org-block">
           </span><span class="org-block"><span class="builtin">:html-preamble</span></span><span class="org-block"> ,org-wiki-preamble </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-publish-preamble)
</span></span><span class="org-block">           </span><span class="org-block"><span class="builtin">:auto-sitemap</span></span><span class="org-block"> t
           </span><span class="org-block"><span class="builtin">:html-postamble</span></span><span class="org-block"> nil
           </span><span class="org-block"><span class="builtin">:htmlized-source</span></span><span class="org-block"> t
           </span><span class="org-block"><span class="builtin">:html-link-home</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"index.html"</span></span><span class="org-block">
           </span><span class="org-block"><span class="builtin">:with-sub-superscript</span></span><span class="org-block"> nil)))
    (org-publish pub-plist t))
  </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Remove preprocessing hook
</span></span><span class="org-block">  (remove-hook 'org-export-before-processing-hook
               '&#8482;/org-wiki-add-setup)
  (remove-hook 'org-export-before-processing-hook
               '&#8482;/org-wiki-insert-index))
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Insertion of org header</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">org-wiki-org-setup</span>
<span class="org-special-keyword">:END:</span>

The following function inserts common org-mode lines to every page.  It is run
during publishing.  The actual functionality added by these lines is described
<span class="org-link"><a href="#wiki-setup-org">here</a></span>.

<span class="org-meta-line">#+name: el-setup-org-header</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">&#8482;/org-wiki-add-setup</span></span><span class="org-block"> (backend)
  </span><span class="org-block"><span class="doc">"Add source-blocks.org and setup.org to org file when BACKEND is html."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (org-export-derived-backend-p backend 'html)
    (</span><span class="org-block"><span class="keyword">save-excursion</span></span><span class="org-block">
      (</span><span class="org-block"><span class="keyword">save-restriction</span></span><span class="org-block">
        (widen)
        (show-all)
        (goto-char (point-min))
        (insert </span><span class="org-block"><span class="string">"#+INCLUDE: source-blocks.org\n"</span></span><span class="org-block">)
        (insert </span><span class="org-block"><span class="string">"#+SETUPFILE: setup.org\n"</span></span><span class="org-block">)))))
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Automatic id generation</span>

To simplify linking between wikipages, the <span class="org-link"><a href="(org-wiki-set-id)">~org-wiki-set-id~ function</a></span> can be
used to automatically generate <span class="org-code">~CUSTOM_ID~</span> properties for each heading in org
files (up to the maximum heading level defined by <span class="org-link"><a href="(org-wiki-conf-index-level)">~org-wiki-index-level-max~</a></span>).

The function ensures unique <span class="org-code">~CUSTOM_ID~</span> entries for a given org file.  It does
so by using the full headline lineage as <span class="org-code">~CUSTOM_ID~</span>.  This require the custom
<span class="org-code">~&#8482;/org-element-title-lineage~</span> function (see <span class="org-link"><a href="el-setup-title-lineage">here</a></span>).

<span class="org-meta-line">#+name: el-setup-set-id-helper</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)"
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">org-wiki-set-id</span></span><span class="org-block"> (</span><span class="org-block"><span class="type">&amp;optional</span></span><span class="org-block"> force) </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-set-id)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"Set :CUSTOM_ID property on all headings.
Leave existing properties unchanged if FORCE evaluates to nil."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">interactive</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"P"</span></span><span class="org-block">)
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((tree (org-element-parse-buffer))
        (id-list (list))
        (insert-list (list)))
    (org-element-map
        tree 'headline
      (</span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> (el)
        (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((title (mapconcat 'identity
                                (reverse
                                 (&#8482;/org-element-title-lineage el))
                                </span><span class="org-block"><span class="string">"/"</span></span><span class="org-block">))
              (begin (org-element-property </span><span class="org-block"><span class="builtin">:begin</span></span><span class="org-block"> el))
              (level (org-element-property </span><span class="org-block"><span class="builtin">:level</span></span><span class="org-block"> el))
              (customid (org-element-property </span><span class="org-block"><span class="builtin">:CUSTOM_ID</span></span><span class="org-block"> el)))
          (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (&lt;= level org-wiki-index-level-max)
            (</span><span class="org-block"><span class="keyword">cond</span></span><span class="org-block"> ((</span><span class="org-block"><span class="keyword">and</span></span><span class="org-block"> (&lt;= level org-wiki-index-level-max)
                        (</span><span class="org-block"><span class="keyword">or</span></span><span class="org-block"> force (not customid) (member customid id-list)))
                   (org-element-put-property el </span><span class="org-block"><span class="builtin">:key</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"CUSTOM_ID"</span></span><span class="org-block">)
                   (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((cid (org-wiki-make-id title id-list)))
                     (add-to-list 'insert-list `(,begin . ,cid))
                     (add-to-list 'id-list cid t)))
                  (customid (add-to-list 'id-list customid t)))))))
    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (insert insert-list)
      (goto-char (car insert))
      (org-entry-put (point) </span><span class="org-block"><span class="string">"CUSTOM_ID"</span></span><span class="org-block"> (cdr insert)))))
</span><span class="org-block-end-line">#+end_src
</span>
This function can be run manually for each new wikipage or added as a
preprocessing hook.

The <span class="org-link"><a href="(org-wiki-set-id)">~org-wiki-set-id~ function</a></span> replaces non-ascii characters by reasonable ascii
equivalents defined in the following function.

<span class="org-meta-line">#+name: el-setup-set-id</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Create unique id from title and current list
</span></span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">org-wiki-make-id</span></span><span class="org-block"> (title cid_list)
  </span><span class="org-block"><span class="doc">"Form CUSTOM_ID from TITLE appending an index if TITLE is in CID_LIST."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((rep-list '((</span><span class="org-block"><span class="string">"<a href=":space:">[[:space:]]</a>+"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"[/+=!?()'\",;:-]"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#225;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#224;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#226;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#228;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#257;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#462;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#227;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#229;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#261;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"a"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#233;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#232;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#234;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#235;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#275;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#283;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#281;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"e"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#237;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#236;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#238;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#239;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#299;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#464;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"i"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#243;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#242;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#244;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#246;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#245;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#466;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#248;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#333;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"o"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#250;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#249;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#251;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#252;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#363;"</span></span><span class="org-block">     . </span><span class="org-block"><span class="string">"u"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#221;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#253;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#255;"</span></span><span class="org-block">     . </span><span class="org-block"><span class="string">"y"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#231;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#269;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#263;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"c"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#271;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#240;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"d"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#318;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#314;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#322;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"l"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#241;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#328;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#324;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"n"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#254;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"th"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#223;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"ss"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#230;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"ae"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#353;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#347;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"s"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#357;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"t"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#345;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#341;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"r"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&#382;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#378;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">&#380;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"z"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"<a href=":nonascii:">[[:nonascii:]]</a>"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"^_"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">""</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"_$"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">""</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"_+"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block">)))
        (cid (downcase title)))
    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (rep rep-list)
      (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> cid
            (replace-regexp-in-string (car rep) (cdr rep) cid)))
    (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (member cid cid_list)
      (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((n 0))
        (</span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (member (concat cid </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block"> (format </span><span class="org-block"><span class="string">"%d"</span></span><span class="org-block"> n)) cid_list)
          (</span><span class="org-block"><span class="keyword">incf</span></span><span class="org-block"> n))
        (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> cid (concat cid </span><span class="org-block"><span class="string">"_"</span></span><span class="org-block"> (format </span><span class="org-block"><span class="string">"%d"</span></span><span class="org-block"> n)))))
    cid))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: el-setup-title-lineage</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :tangle no
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">&#8482;/org-element-title-lineage</span></span><span class="org-block"> (el)
  </span><span class="org-block"><span class="doc">"Return list of parent headline titles for EL.
The title of EL is first."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> ((parent (org-element-property </span><span class="org-block"><span class="builtin">:parent</span></span><span class="org-block"> el))
         (p-title (car (org-element-property </span><span class="org-block"><span class="builtin">:title</span></span><span class="org-block"> el)))
         (out (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> p-title
                (&#8482;/org-element-title-lineage parent))))
    (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> p-title
      (</span><span class="org-block"><span class="keyword">push</span></span><span class="org-block"> (substring-no-properties p-title) out))
    out))
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Index generation</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">org-wiki-index</span>
<span class="org-special-keyword">:END:</span>

As described in the <span class="org-link"><a href="#wiki-search">Search</a></span> section, the search functionality requires the
generation of an index of the wiki content.

A common approach to enable client-side search consists in indexing the content
of complete files but this results in inaccurate results: searches return pages
containing a match, but not the location of the match.

In order to get more accurate results, the index is represented as a tree where
each node corresponds to a wiki file and a sub-heading (with level controlled by
the <span class="org-link"><a href="(org-wiki-conf-index-level)">~org-wiki-index-level-max~</a></span> variable) instead of using a node per file.  This
allows for search results at the subsection level.

The index structure is as follows:
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-index-tree-title)">~title~</a></span></span><span class="org-list-dt"> ::</span> Title of the wikipage
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-index-tree-sec_title)">~sec_title~</a></span></span><span class="org-list-dt"> ::</span> Full path to subsection (e.g. <span class="org-verbatim">=Section 1 &gt; SubSection 2 &gt; ...=</span>)
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-index-tree-keywords)">~keywords~</a></span></span><span class="org-list-dt"> ::</span> Captures the <span class="org-code">~KEYWORDS~</span> property of the org wikipage
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-index-tree-content)">~content~</a></span></span><span class="org-list-dt"> ::</span> The text of the subsection (including its subsections if their
     level is larger than <span class="org-link"><a href="(org-wiki-conf-index-level)">~org-wiki-index-level-max~</a></span>)
- <span class="org-link"><span class="org-list-dt"><a href="(org-wiki-index-tree-href)">~href~</a></span></span><span class="org-list-dt"> ::</span> The HTML anchor for linking (i.e. the <span class="org-code">~CUSTOM_ID~</span> property)

<span class="org-meta-line">#+name: el-setup-search-index-tree-insert</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)"
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Lunr index
</span></span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">org-wiki~add-to-index-tree</span></span><span class="org-block"> (outlist point-prev point-cur title
                                           title-lineage keywords text
                                           base-file customid)
  </span><span class="org-block"><span class="doc">"Helper function to add an entry to the index tree."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> point-prev
    (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> text (buffer-substring-no-properties
                point-prev point-cur))
    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (regex org-wiki-index-regexp-list)
      (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> text (replace-regexp-in-string
                  (car regex) (cdr regex) text)))
    (add-to-list
     'outlist
     (list `(</span><span class="org-block"><span class="string">"title"</span></span><span class="org-block"> . ,title) </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-tree-title)
</span></span><span class="org-block">           `(</span><span class="org-block"><span class="string">"sec_title"</span></span><span class="org-block"> .  </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-tree-sec_title)
</span></span><span class="org-block">             ,(mapconcat #'identity
                         (remove </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> title-lineage)
                         </span><span class="org-block"><span class="string">" &gt; "</span></span><span class="org-block">))
           `(</span><span class="org-block"><span class="string">"keywords"</span></span><span class="org-block"> . ,keywords) </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-tree-keywords)
</span></span><span class="org-block">           `(</span><span class="org-block"><span class="string">"content"</span></span><span class="org-block"> . ,text) </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-tree-content)
</span></span><span class="org-block">           `(</span><span class="org-block"><span class="string">"href"</span></span><span class="org-block"> . </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-tree-href)
</span></span><span class="org-block">             ,(concat base-file </span><span class="org-block"><span class="string">".html#"</span></span><span class="org-block"> customid)))))
  outlist)
</span><span class="org-block-end-line">#+end_src
</span>
The main index function loops over all org files in the wiki folder and
populates a list of index entries.

First, it <span class="org-link"><a href="(org-wiki-index-get-props)">extracts </a></span><span class="org-link"><span class="org-code"><a href="(org-wiki-index-get-props)">~title~</a></span></span><span class="org-link"><a href="(org-wiki-index-get-props)"> and </a></span><span class="org-link"><span class="org-code"><a href="(org-wiki-index-get-props)">~keywords~</a></span></span><span class="org-link"><a href="(org-wiki-index-get-props)"> properties of the current file</a></span>.  It
then <span class="org-link"><a href="(org-wiki-index-browse)">browses headings</a></span> and stores their lineage and content in the index.
Finally, the index list is stored as a json file.

This function also captures the <span class="org-code">~CATEGORY~</span> property of each page for use by the
<span class="org-link"><a href="#org-wiki-index-page">index table generation function</a></span>.

<span class="org-meta-line">#+name: el-setup-index</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)"
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">org-wiki-index</span></span><span class="org-block"> (outfile)
  </span><span class="org-block"><span class="doc">"Prepare json index for Lunr search, store in OUTFILE."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((category-list '())
        (file-list
         (remove-if
          (</span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> (el)
            (member (file-name-nondirectory el) org-wiki-ignored-files))
          (directory-files org-wiki-location t </span><span class="org-block"><span class="string">".org$"</span></span><span class="org-block">)))
        (outlist (list)))
    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (file file-list)
      (</span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> ((base-file (file-name-nondirectory
                         (file-name-sans-extension file)))
             (visiting (find-buffer-visiting file))
             (buffer (</span><span class="org-block"><span class="keyword">or</span></span><span class="org-block"> visiting (find-file-noselect file))))
        (</span><span class="org-block"><span class="keyword">with-current-buffer</span></span><span class="org-block"> buffer
          (</span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> ((tree (org-element-parse-buffer))
                 (title-lineage (make-list org-wiki-index-level-max </span><span class="org-block"><span class="string">""</span></span><span class="org-block">))
                 title
                 keywords
                 category
                 text
                 customid
                 point-prev
                 point-cur)
            (org-element-map </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-get-props)
</span></span><span class="org-block">                tree 'keyword
              (</span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> (r)
                (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((key (org-element-property </span><span class="org-block"><span class="builtin">:key</span></span><span class="org-block"> r))
                      (value (org-element-property </span><span class="org-block"><span class="builtin">:value</span></span><span class="org-block"> r)))
                  (</span><span class="org-block"><span class="keyword">cond</span></span><span class="org-block"> ((string= key </span><span class="org-block"><span class="string">"TITLE"</span></span><span class="org-block">)
                         (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> title value))
                        ((string= key </span><span class="org-block"><span class="string">"KEYWORDS"</span></span><span class="org-block">)
                         (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> keywords value))
                        ((string= key </span><span class="org-block"><span class="string">"CATEGORY"</span></span><span class="org-block">)
                         (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> category value))))))
            </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Update category list
</span></span><span class="org-block">            (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> category
              (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((page-link (format </span><span class="org-block"><span class="string">"<a href="file:%s.org">[[file:%s.org][%s]]</a>"</span></span><span class="org-block">
                                       base-file base-file)))
                (</span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (member category (mapcar 'car category-list))
                    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (cat category-list)
                      (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (string= (car cat) category)
                        (setcdr cat (</span><span class="org-block"><span class="keyword">push</span></span><span class="org-block"> page-link (cdr cat)))))
                  (add-to-list 'category-list
                               (list category page-link)))))
            </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Index headings
</span></span><span class="org-block">            (org-element-map </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:org-wiki-index-browse)
</span></span><span class="org-block">                tree 'headline
              (</span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> (el)
                (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((level (org-element-property </span><span class="org-block"><span class="builtin">:level</span></span><span class="org-block"> el))
                      (s-title (car (org-element-property </span><span class="org-block"><span class="builtin">:title</span></span><span class="org-block"> el))))
                  (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> point-cur (org-element-property </span><span class="org-block"><span class="builtin">:begin</span></span><span class="org-block"> el))
                  (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (&lt;= level org-wiki-index-level-max)
                    (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> outlist
                          (org-wiki~add-to-index-tree
                           outlist point-prev point-cur title title-lineage
                           keywords text base-file customid))
                    </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Set lineage title at current level
</span></span><span class="org-block">                    (</span><span class="org-block"><span class="keyword">setf</span></span><span class="org-block"> (nth (- level 1) title-lineage) s-title)
                    </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Reset following lineage titles
</span></span><span class="org-block">                    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (n (number-sequence
                                level (- org-wiki-index-level-max 1)))
                      (</span><span class="org-block"><span class="keyword">setf</span></span><span class="org-block"> (nth n title-lineage) </span><span class="org-block"><span class="string">""</span></span><span class="org-block">))
                    (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> customid (org-element-property </span><span class="org-block"><span class="builtin">:CUSTOM_ID</span></span><span class="org-block"> el))
                    (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> point-prev point-cur)))))
            (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> point-cur (point-max))
            (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> outlist
                  (org-wiki~add-to-index-tree
                   outlist point-prev point-cur title title-lineage
                   keywords text base-file customid))))))
    </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Write search index json file
</span></span><span class="org-block">    (</span><span class="org-block"><span class="keyword">with-temp-buffer</span></span><span class="org-block">
      (insert (json-encode outlist))
      (write-file outfile))
    </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Return index table
</span></span><span class="org-block">    category-list))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Page index</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">org-wiki-index-page</span>
<span class="org-special-keyword">:END:</span>

The page index is not used for the search but to insert a list of pages grouped
by categories in the <span class="org-verbatim">=index.org=</span> page.  The list is obtained during the
<span class="org-link"><a href="el-setup-index">generation of the search index</a></span>.

The following function replaces the content of <span class="org-verbatim">=index.org=</span> at the marker given
by <span class="org-link"><a href="#org-wiki-params">~org-wiki-index-page-marker~</a></span>.  It is used as a <span class="org-link"><a href="(org-wiki-publish-index-table)">preprocessing hook</a></span> and relies
on the <span class="org-code">~&#8482;/org-wiki-index-category-list~</span> variable to be set by a prior call to
the <span class="org-link"><a href="el-setup-index">~org-wiki-index~</a></span> function (this is done in the <span class="org-link"><a href="(org-wiki-publish-index)">publishing function</a></span>).

<span class="org-meta-line">#+name: el-setup-index-page</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">&#8482;/org-wiki-insert-index</span></span><span class="org-block"> (backend)
  </span><span class="org-block"><span class="doc">"Insert index table in index.org file."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (string= (file-name-nondirectory (buffer-file-name)) </span><span class="org-block"><span class="string">"index.org"</span></span><span class="org-block">)
    (</span><span class="org-block"><span class="keyword">save-excursion</span></span><span class="org-block">
      </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Find marker
</span></span><span class="org-block">      (goto-char (point-max))
      (search-backward org-wiki-index-page-marker nil t)
      </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Remove marker
</span></span><span class="org-block">      (org-kill-line)
      </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Insert table
</span></span><span class="org-block">      (insert (concat </span><span class="org-block"><span class="string">"|"</span></span><span class="org-block"> (mapconcat 'car &#8482;/org-wiki-index-category-list
                                     </span><span class="org-block"><span class="string">"|"</span></span><span class="org-block">) </span><span class="org-block"><span class="string">"|\n"</span></span><span class="org-block">))
      (insert </span><span class="org-block"><span class="string">"|---\n"</span></span><span class="org-block">)
      (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((done nil)
            (n 0))
        (</span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (not done)
          (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((pages (mapcar (</span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> (el) (elt (cdr el) n))
                               &#8482;/org-wiki-index-category-list)))
            (</span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (some 'identity pages)
                (insert (concat </span><span class="org-block"><span class="string">"|"</span></span><span class="org-block"> (mapconcat 'identity pages </span><span class="org-block"><span class="string">"|"</span></span><span class="org-block">) </span><span class="org-block"><span class="string">"|\n"</span></span><span class="org-block">))
              (</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> done t))
            (</span><span class="org-block"><span class="keyword">incf</span></span><span class="org-block"> n)))))))
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Refbase link</span>

Bibliographic citations are handled by org-links to an existing refbase
instance.  The interface with the refbase instance is handled by the
<span class="org-link"><a href="#refbase">=my-refbase.el=</a></span> package.

The following defines an org-link for refbase citations (<span class="org-code">~</span><span class="org-link"><span class="org-code"><a href="refbase:bibtexkey">refbase:bibtexkey</a></span></span><span class="org-code">~</span>):
- when activated in emacs, <span class="org-code">~refbase~</span> links open a link to the refbase webpage in
  the default web browser,
- when hovering the mouse over the link in emacs, a summary of the citation
  (author, title, publication) is shown as a tooltip,
- when exporting to HTML, a hypertext link is inserted to the refbase page along
  with a tooltip with a summary of the citation (author, title, publication).

Note that this assumes that the <span class="org-verbatim">=my-refbase.el=</span> file is in the <span class="org-code">~load-path~</span>.

<span class="org-meta-line">#+name: el-setup-rb-link</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">refbase link
</span></span><span class="org-block">
(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">rblink-follow</span></span><span class="org-block"> (path)
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((link (refbase-get-link path)))
    (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> link (browse-url link))))

(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">rblink-tooltip</span></span><span class="org-block"> (window object position)
  (</span><span class="org-block"><span class="keyword">with-current-buffer</span></span><span class="org-block"> object
    (</span><span class="org-block"><span class="keyword">save-excursion</span></span><span class="org-block">
      (goto-char position)
      (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((path (</span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> (thing-at-point-looking-at org-plain-link-re)
                    (replace-regexp-in-string
                     </span><span class="org-block"><span class="string">".*refbase:</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string"><a href=":alnum:">[[:alnum:]]</a>+</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">.*"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"\\1"</span></span><span class="org-block">
                     (match-string 0)))))
        (refbase-get-cite path)))))

(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">rblink-export</span></span><span class="org-block"> (path desc backend)
  (</span><span class="org-block"><span class="keyword">cond</span></span><span class="org-block"> ((eq 'html backend)
         (format </span><span class="org-block"><span class="string">"&lt;a href=\"%s\" title=\"%s\"&gt;%s&lt;/a&gt;"</span></span><span class="org-block">
                 (refbase-get-link path)
                 (refbase-get-cite path)
                 path))))

(org-link-set-parameters
 </span><span class="org-block"><span class="string">"refbase"</span></span><span class="org-block">
 </span><span class="org-block"><span class="builtin">:follow</span></span><span class="org-block"> #'rblink-follow
 </span><span class="org-block"><span class="builtin">:help-echo</span></span><span class="org-block"> #'rblink-tooltip
 </span><span class="org-block"><span class="builtin">:export</span></span><span class="org-block"> #'rblink-export)
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Helper function</span>

When migrating from <span class="org-link"><a href="https://www.mediawiki.org/wiki/MediaWiki">MediaWiki</a></span> to this org-mode wiki, the following function
proved useful as a first pass to convert pages.  It is left here for reference.

<span class="org-meta-line">#+name: el-setup-mw-to-org</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent :tangle no
</span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Convert mediawiki to org-wiki
</span></span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">&#8482;/org-wiki-convert-mw-to-org</span></span><span class="org-block"> ()
  (</span><span class="org-block"><span class="keyword">interactive</span></span><span class="org-block">)
  (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (n (number-sequence 10 1 -1))
    (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((pat (concat
                </span><span class="org-block"><span class="string">"^"</span></span><span class="org-block">
                (mapconcat #'identity (make-list n </span><span class="org-block"><span class="string">"\\*"</span></span><span class="org-block">) </span><span class="org-block"><span class="string">""</span></span><span class="org-block">)))
          (rep (concat
                (mapconcat #'identity (make-list (* 2 (- n 1)) </span><span class="org-block"><span class="string">" "</span></span><span class="org-block">) </span><span class="org-block"><span class="string">""</span></span><span class="org-block">)
                </span><span class="org-block"><span class="string">"-"</span></span><span class="org-block">)))
      (goto-char (point-min))
      (</span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (re-search-forward pat nil t)
        (replace-match rep))))
  (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (n (number-sequence 10 1 -1))
    (</span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> ((eqs (make-string n ?=))
           (pat (format </span><span class="org-block"><span class="string">"^%s<a href=":space:">[[:space:]]</a>*</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.*?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string"><a href=":space:">[[:space:]]</a>*%s"</span></span><span class="org-block">
                        eqs eqs))
           (rep (format </span><span class="org-block"><span class="string">"%s \\1"</span></span><span class="org-block"> (make-string (- n 1) ?*))))
      (goto-char (point-min))
      (</span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (re-search-forward pat nil t)
        (replace-match rep))))
  (</span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> ((rep-list '((</span><span class="org-block"><span class="string">"&lt;math&gt;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.+?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">&lt;/math&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"$\\1$"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;math&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"\\\\begin{align}"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;/math&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"\\\\end{align}"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;pre&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"#+BEGIN_EXAMPLE"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;/pre&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"#+END_EXAMPLE"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;code&gt;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.+?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">&lt;/code&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"~\\1~"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;refbase&gt;</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.+?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">&lt;/refbase&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"<a href="refbase:\\1">refbase:\\1</a>"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"[[]</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">https?:[</span></span><span class="org-block"><span class="string"><span class="negation-char">^</span></span></span><span class="org-block"><span class="string"> ]+</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string"><a href=":space:">[[:space:]]</a>*|?<a href=":space:">[[:space:]]</a>*</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.*</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">]"</span></span><span class="org-block"> .
                     </span><span class="org-block"><span class="string">"\\2: \\1"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;syntaxhighlight lang=[\"]?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.*?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">[\"]?&gt;"</span></span><span class="org-block"> .
                     </span><span class="org-block"><span class="string">"#+BEGIN_SRC \\1"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"&lt;/syntaxhighlight&gt;"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"#+END_SRC"</span></span><span class="org-block">)
                    (</span><span class="org-block"><span class="string">"'''</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(</span></span></span><span class="org-block"><span class="string">.*?</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">'''"</span></span><span class="org-block"> . </span><span class="org-block"><span class="string">"*\\1*"</span></span><span class="org-block">))))
    (</span><span class="org-block"><span class="keyword">dolist</span></span><span class="org-block"> (rep rep-list)
      (goto-char (point-min))
      (</span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (re-search-forward (car rep) nil t)
        (replace-match (cdr rep))))))
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Footer</span>

This concludes the <span class="org-verbatim">=my-org-wiki=</span> package.

<span class="org-meta-line">#+name: el-org-wiki-footer</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block">
(</span><span class="org-block"><span class="keyword">provide</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">my-org-wiki</span></span><span class="org-block">)
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">my-org-wiki.el ends here
</span></span><span class="org-block-end-line">#+end_src
</span>


<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Refbase package</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle my-refbase.el</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">refbase</span>
<span class="org-special-keyword">:END:</span>

This section describes the minimalist refbase package used to handle
bibliographic citations.  Note that this package assumes a local refbase
instance for which the (MySQL) database is accessible.

<span class="org-meta-line">#+name: el-rb-header</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">my-refbase.el --- Helper functions to communicate with refbase instance
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">Commentary:
</span></span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">Defines functions to perform requests from a refbase instance (using mysql)
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">Code:
</span></span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Parameters</span>

The package is configured by the <span class="org-link"><a href="(refbase-pkg-url)">~refbase-url~</a></span> and <span class="org-link"><a href="(refbase-pkg-db)">~refbase-db~</a></span> parameters which
control the URL and the name of the MySQL database.

<span class="org-meta-line">#+name: el-rb-params</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -r -l " ;;(ref:%s)" :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">refbase-url</span></span><span class="org-block"> </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:refbase-pkg-url)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"URL of refbase installation."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'string
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'refbase)

(</span><span class="org-block"><span class="keyword">defcustom</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">refbase-db</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"refbase"</span></span><span class="org-block"> </span><span class="org-block"><span class="comment-delimiter">;;</span></span><span class="org-block"><span class="comment">(ref:refbase-pkg-db)
</span></span><span class="org-block">  </span><span class="org-block"><span class="doc">"Name of the MySQL refbase database."</span></span><span class="org-block">
  </span><span class="org-block"><span class="builtin">:type</span></span><span class="org-block"> 'string
  </span><span class="org-block"><span class="builtin">:group</span></span><span class="org-block"> 'refbase)
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Main function</span>

The following function interrogates a local mysql instance for arbitrary fields
(e.g. author, title, publication, year, etc.).  Requests are performed for a
bibtex key rather than refbase's serial number.  This requires the <span class="org-verbatim">=citekey=</span>
field to be populated in refbase.

<span class="org-meta-line">#+name: el-rb-get-fields-by-citekey</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">refbase~get-by-citekey</span></span><span class="org-block"> (citekey fields)
  </span><span class="org-block"><span class="doc">"Perform MySQL query to extract entry information by cite_key field."</span></span><span class="org-block">
  (</span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> ((query (concat
                 (format </span><span class="org-block"><span class="string">"SELECT %s FROM refs r "</span></span><span class="org-block"> fields)
                 </span><span class="org-block"><span class="string">"INNER JOIN user_data u ON r.serial = u.data_id "</span></span><span class="org-block">
                 (format </span><span class="org-block"><span class="string">"WHERE u.cite_key='%s';"</span></span><span class="org-block"> citekey)))
         (cmd (format </span><span class="org-block"><span class="string">"mysql --login-path=local -sN -r -e \"%s\" %s"</span></span><span class="org-block">
                      query refbase-db)))
    (replace-regexp-in-string
     </span><span class="org-block"><span class="string">"\n$"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> (shell-command-to-string cmd))))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Get link</span>

Using the <span class="org-link"><a href="el-rb-get-fields-by-citekey">~refbase~get-by-citekey~</a></span> function, the following function returns a
link to the refbase page for a given citation.

<span class="org-meta-line">#+name: el-rb-get-link</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">refbase-get-link</span></span><span class="org-block"> (citekey)
  </span><span class="org-block"><span class="doc">"Get link to refbase page."</span></span><span class="org-block">
  (format </span><span class="org-block"><span class="string">"%s/show.php?record=%s"</span></span><span class="org-block">
          refbase-url
          (refbase~get-by-citekey citekey </span><span class="org-block"><span class="string">"serial"</span></span><span class="org-block">)))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Get abstract</span>

The following function returns the abstract for a citation using
<span class="org-link"><a href="el-rb-get-fields-by-citekey">~refbase~get-by-citekey~</a></span>.

<span class="org-meta-line">#+name: el-rb-get-abstract</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">refbase-get-abstract</span></span><span class="org-block"> (citekey)
  </span><span class="org-block"><span class="doc">"Get abstract of refbase entry."</span></span><span class="org-block">
  (refbase~get-by-citekey citekey </span><span class="org-block"><span class="string">"abstract"</span></span><span class="org-block">))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Get citation</span>

The following function builds a short summary of a citation using
<span class="org-link"><a href="el-rb-get-fields-by-citekey">~refbase~get-by-citekey~</a></span> containing the author, title, publication, and year.

<span class="org-meta-line">#+name: el-rb-get-citation</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">refbase-get-cite</span></span><span class="org-block"> (citekey)
  </span><span class="org-block"><span class="doc">"Get title of refbase entry."</span></span><span class="org-block">
  (replace-regexp-in-string
   </span><span class="org-block"><span class="string">"\t"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">", "</span></span><span class="org-block">
   (refbase~get-by-citekey citekey </span><span class="org-block"><span class="string">"author, title, publication, year"</span></span><span class="org-block">)))
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Package footer</span>

<span class="org-meta-line">#+name: el-rb-footer</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp :results silent
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">provide</span></span><span class="org-block"> '</span><span class="org-block"><span class="constant">my-refbase</span></span><span class="org-block">)
</span><span class="org-block"><span class="comment-delimiter">;;; </span></span><span class="org-block"><span class="comment">my-refbase.el ends here
</span></span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Wiki setup</span>

This section defines the static content of the wiki website.  It includes the
javascripts libraries, style sheets and the basic wiki pages.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Javascript libraries</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wiki-js-libs</span>
<span class="org-special-keyword">:END:</span>

In this section, third-party javascript dependencies can be downloaded using the
following source blocks (this requires some shell and wget):


- <span class="org-list-dt">JQuery ::</span> version 2.1.3 but more recent versions should also work:
<span class="org-meta-line">     #+name: wiki-js-jquery</span>
<span class="org-block-begin-line">     #+begin_src sh
</span><span class="org-block">     wget <a href="https://code.jquery.com/jquery-2.1.3.min.js">https://code.jquery.com/jquery-2.1.3.min.js</a> -O org/_resources/jquery-2.1.3.min.js
</span><span class="org-block-end-line">     #+end_src
</span>- <span class="org-list-dt">Lunr ::</span> latest version hoping it does not break (2.1.3 is known to work):
<span class="org-meta-line">     #+name: wiki-js-lunr</span>
<span class="org-block-begin-line">     #+begin_src sh
</span><span class="org-block">     wget <a href="https://unpkg.com/lunr/lunr.js">https://unpkg.com/lunr/lunr.js</a> -O org/_resources/lunr.js
</span><span class="org-block-end-line">     #+end_src
</span>- <span class="org-verbatim"><span class="org-list-dt">=mark.js=</span></span><span class="org-list-dt"> ::</span> version 8.11.0 but more recent versions should also work:
<span class="org-meta-line">     #+name: wiki-js-mark</span>
<span class="org-block-begin-line">     #+begin_src sh
</span><span class="org-block">     wget <a href="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.0/jquery.mark.min.js">https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.0/jquery.mark.min.js</a> -O org/_resources/jquery.mark.min.js
</span><span class="org-block-end-line">     #+end_src
</span>- <span class="org-verbatim"><span class="org-list-dt">=org-info.js=</span></span><span class="org-list-dt"> ::</span> use latest version
<span class="org-meta-line">     #+name: wiki-js-org-info</span>
<span class="org-block-begin-line">     #+begin_src sh
</span><span class="org-block">     wget <a href="http://orgmode.org/worg/code/org-info-js/org-info.js">http://orgmode.org/worg/code/org-info-js/org-info.js</a> -O org/_resources/org-info.js
</span><span class="org-block-end-line">     #+end_src
</span>- <span class="org-list-dt">MathJax ::</span> version 2.7.2, but more recent versions should also work:
<span class="org-meta-line">     #+name: wiki-js-mathjax</span>
<span class="org-block-begin-line">     #+begin_src sh
</span><span class="org-block">     wget <a href="https://github.com/mathjax/MathJax/archive/2.7.2.zip">https://github.com/mathjax/MathJax/archive/2.7.2.zip</a> -O org/_resources/mathjax2.7.2.zip
     unzip org/_resources/mathjax2.7.2.zip
     mv MathJax-2.7.2 org/_resources/MathJax
     rm org/_resources/mathjax2.7.2.zip
</span><span class="org-block-end-line">     #+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Search</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wiki-search</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle org/_resources/search.js</span>
<span class="org-special-keyword">:END:</span>

The search functionality relies on the client-side <span class="org-link"><a href="https://lunrjs.com/">Lunr</a></span> library.

The basic idea is to <span class="org-link"><a href="#org-wiki-index">generate an index file</a></span> during the static generation of
wikipages (i.e. when running <span class="org-code">~org-publish~</span>), send it to the client via a jQuery
request and use Lunr to search the index.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Asynchronous index download using jQuery</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-index-download</span>
<span class="org-special-keyword">:END:</span>

The following block performs three operations:
1. <span class="org-link"><a href="(js-search-get-json)">asynchronously download the index file</a></span>,
2. <span class="org-link"><a href="(js-search-lunr-index)">build the Lunr search index</a></span>, assigning score "boost" factors to each field,
   and using the <span class="org-code">~href~</span> link to the wiki entry as <span class="org-link"><a href="(js-search-lunr-index-key)">primary key</a></span>.
3. <span class="org-link"><a href="(js-search-url-search)">perform a search</a></span> if the URL contains a <span class="org-code">~q=~</span> parameter.

<span class="org-meta-line">#+name: search-js-index-download</span>
<span class="org-block-begin-line">#+begin_src javascript -r -l " //(ref:%s)" :noweb yes
</span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">lunrIndex</span></span><span class="org-block">,
    pagesIndex,
    searchStr;

</span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Initialize lunrjs using our generated index file
</span></span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">initLunr</span></span><span class="org-block">() {
    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">First retrieve the index file
</span></span><span class="org-block">    $.getJSON(</span><span class="org-block"><span class="string">"&lt;&lt;el-get-index-json()&gt;&gt;"</span></span><span class="org-block">) </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-get-json)
</span></span><span class="org-block">        .done(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">index</span></span><span class="org-block">) {
            pagesIndex = index;

            </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Set up lunrjs by declaring the fields we use
</span></span><span class="org-block">            </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Also provide their boost level for the ranking
</span></span><span class="org-block">            lunrIndex = lunr(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() { </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-lunr-index)
</span></span><span class="org-block">                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.field(</span><span class="org-block"><span class="string">"title"</span></span><span class="org-block">, {
                    boost: 30
                });
                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.field(</span><span class="org-block"><span class="string">"sec_title"</span></span><span class="org-block">, {
                    boost: 20
                });
                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.field(</span><span class="org-block"><span class="string">"keywords"</span></span><span class="org-block">, {
                    boost: 10
                });
                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.field(</span><span class="org-block"><span class="string">"content"</span></span><span class="org-block">);
                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.field(</span><span class="org-block"><span class="string">"score"</span></span><span class="org-block">);

                </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">ref is the result item identifier
</span></span><span class="org-block">                </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.ref(</span><span class="org-block"><span class="string">"href"</span></span><span class="org-block">); </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-lunr-index-key)
</span></span><span class="org-block">
                </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Feed lunr with each file and let lunr actually index them
</span></span><span class="org-block">                </span><span class="org-block"><span class="keyword">for</span></span><span class="org-block"> (pi = 0; pi &lt; pagesIndex.length; pi++) {
                    </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.add(pagesIndex[pi]);
                }
            });

            </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Immediate search from URL
</span></span><span class="org-block">            url = window.location.search;
            </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (url[0] == </span><span class="org-block"><span class="string">"?"</span></span><span class="org-block">) {
                url = url.slice(1);
            }
            </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">urlParams</span></span><span class="org-block"> = </span><span class="org-block"><span class="keyword">new</span></span><span class="org-block"> </span><span class="org-block"><span class="type">URLSearchParams</span></span><span class="org-block">(url);
            </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">urlQuery</span></span><span class="org-block"> = urlParams.get(</span><span class="org-block"><span class="string">'q'</span></span><span class="org-block">);
            </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (urlQuery != </span><span class="org-block"><span class="constant">null</span></span><span class="org-block">) { </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-url-search)
</span></span><span class="org-block">                $(</span><span class="org-block"><span class="string">'#search'</span></span><span class="org-block">).val(urlQuery);
                searchStr = urlQuery;
                </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">results</span></span><span class="org-block"> = search(urlQuery);
                renderResults(results);
            }
        })
        .fail(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">jqxhr</span></span><span class="org-block">, </span><span class="org-block"><span class="variable-name">textStatus</span></span><span class="org-block">, </span><span class="org-block"><span class="variable-name">error</span></span><span class="org-block">) {
            </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">err</span></span><span class="org-block"> = textStatus + </span><span class="org-block"><span class="string">", "</span></span><span class="org-block"> + error;
            console.error(</span><span class="org-block"><span class="string">"Error getting lunr index flie:"</span></span><span class="org-block">, err);
        });
}
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Search box listener</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-listener</span>
<span class="org-special-keyword">:END:</span>

The following adds a listener function to the search box in the <span class="org-link"><a href="#wiki-page-search">search page</a></span>.
When two or more characters are typed, a search is performed.

<span class="org-meta-line">#+name: search-js-searchbox-listener</span>
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">$results</span></span><span class="org-block">

</span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Add events to search box
</span></span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">initUI</span></span><span class="org-block">() {
    $results = $(</span><span class="org-block"><span class="string">"#results"</span></span><span class="org-block">);
    $(</span><span class="org-block"><span class="string">'#search'</span></span><span class="org-block">).focus();
    $(</span><span class="org-block"><span class="string">"#search"</span></span><span class="org-block">).keyup(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
        $results.empty();

        </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Only trigger a search when 2 chars. at least have been provided
</span></span><span class="org-block">        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">query</span></span><span class="org-block"> = $(</span><span class="org-block"><span class="constant">this</span></span><span class="org-block">).val();
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (query.length &lt; 2) {
            </span><span class="org-block"><span class="keyword">return</span></span><span class="org-block">;
        }

        searchStr = query;
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">results</span></span><span class="org-block"> = search(query);

        renderResults(results);
    });
}
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Lunr search</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-search</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-code">~search~</span> function is a wrapper around Lunr's <span class="org-link"><a href="(js-search-lunr-search)">~search~</a></span> function.  Lunr's
function returns scores and the corresponding primary key (the <span class="org-code">~href~</span> field).
In order to display, in the results page, more than just the hyperlink, the
<span class="org-code">~href~</span> link is used to find full entries in the page index.  The double <span class="org-code">~for~</span>
loop may not be optimal in terms of speed but it does not seem prohibitively
slow yet.

<span class="org-meta-line">#+name: search-js-search</span>
<span class="org-block-begin-line">#+begin_src javascript -r -l " //(ref:%s)"
</span><span class="org-block"><span class="comment-delimiter">/**</span></span><span class="org-block"><span class="comment">
 ,* Trigger a search in lunr and transform the result
 ,*
 ,* @param  {String} query
 ,* @return {Array}  results
 ,*/</span></span><span class="org-block">
</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">search</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">query</span></span><span class="org-block">) {
    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Find the item in our index corresponding to the lunr one to have
</span></span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">more info
</span></span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Lunr result:
</span></span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">//  </span></span><span class="org-block"><span class="comment">{ref: "/section/page1", score: 0.2725657778206127}
</span></span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Our result:
</span></span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">//  </span></span><span class="org-block"><span class="comment">{title:"Page1", href:"/section/page1", ...}
</span></span><span class="org-block">    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">search_res</span></span><span class="org-block"> = lunrIndex.search(query); </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-lunr-search)
</span></span><span class="org-block">    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">out_res</span></span><span class="org-block"> = []
    </span><span class="org-block"><span class="keyword">for</span></span><span class="org-block"> (ri = 0; ri &lt; search_res.length; ri++) {
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">found</span></span><span class="org-block"> = </span><span class="org-block"><span class="constant">false</span></span><span class="org-block">;
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">pi</span></span><span class="org-block"> = 0;
        </span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (!found &amp;&amp; pi &lt; pagesIndex.length) {
            </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (pagesIndex[pi].href == search_res[ri].ref) {
                pagesIndex[pi].score = search_res[ri].score;
                out_res.push(pagesIndex[pi]);
                found = </span><span class="org-block"><span class="constant">true</span></span><span class="org-block">;
            }
            pi++;
        }
    }
    </span><span class="org-block"><span class="keyword">return</span></span><span class="org-block"> out_res;
}
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Display results</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-display</span>
<span class="org-special-keyword">:END:</span>

Search results are grouped by wikipage, and displayed by subsections, along with
the Lunr search score.  The <span class="org-link"><a href="(js-search-display-href)">~href~ link</a></span> is modified to <span class="org-link"><a href="#search-js-highlight">highlight the search
results</a></span>.

Most of the code in the function deals with creating the HTML output which
could probably be simplified with better jQuery skills.

<span class="org-meta-line">#+name: search-js-display</span>
<span class="org-block-begin-line">#+begin_src javascript -r -l " //(ref:%s)"
</span><span class="org-block"><span class="comment-delimiter">/**</span></span><span class="org-block"><span class="comment">
 ,* Display the 10 first results
 ,*
 ,* @param  {Array} results to display
 ,*/</span></span><span class="org-block">
</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">renderResults</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">results</span></span><span class="org-block">) { </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-render)
</span></span><span class="org-block">    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (!results.length) {
        </span><span class="org-block"><span class="keyword">return</span></span><span class="org-block">;
    }

    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Reformat into sortable table (only show the ten first results)
</span></span><span class="org-block">    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">res_top</span></span><span class="org-block"> = [];
    </span><span class="org-block"><span class="keyword">for</span></span><span class="org-block"> (ri = 0; ri &lt; results.slice(0, 10).length; ri++) {
        res_top.push([results.slice(0, 10)[ri].title,
                      results.slice(0, 10)[ri].sec_title,
                      results.slice(0, 10)[ri].href,
                      results.slice(0, 10)[ri].score]);
    }
    res_top.sort(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">a</span></span><span class="org-block">, </span><span class="org-block"><span class="variable-name">b</span></span><span class="org-block">) {
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (a[0] == b[0]) {
            </span><span class="org-block"><span class="keyword">return</span></span><span class="org-block"> a[1].localeCompare(b[1]);
        } </span><span class="org-block"><span class="keyword">else</span></span><span class="org-block"> {
            </span><span class="org-block"><span class="keyword">return</span></span><span class="org-block"> a[0].localeCompare(b[0]);
        }} );

    </span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Display results
</span></span><span class="org-block">    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">title_prev</span></span><span class="org-block"> = </span><span class="org-block"><span class="string">""</span></span><span class="org-block">;
    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">$result_all</span></span><span class="org-block"> = </span><span class="org-block"><span class="string">""</span></span><span class="org-block">;
    </span><span class="org-block"><span class="keyword">for</span></span><span class="org-block"> (ri = 0; ri &lt; res_top.length; ri++) {
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">res</span></span><span class="org-block"> = res_top[ri];
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">href</span></span><span class="org-block"> = res[2].replace(</span><span class="org-block"><span class="string">/([^#]+)#(.*)/</span></span><span class="org-block">, </span><span class="org-block"><span class="comment-delimiter">//</span></span><span class="org-block"><span class="comment">(ref:js-search-display-href)
</span></span><span class="org-block">                                  </span><span class="org-block"><span class="string">'$1?highlight='</span></span><span class="org-block"> + searchStr + </span><span class="org-block"><span class="string">'#$2'</span></span><span class="org-block">);
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">title</span></span><span class="org-block"> = res[0];
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">sec_title</span></span><span class="org-block"> = res[1];
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">$result</span></span><span class="org-block"> = </span><span class="org-block"><span class="string">""</span></span><span class="org-block">;
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">$result_inner</span></span><span class="org-block"> = </span><span class="org-block"><span class="string">"&lt;li&gt;&lt;a href=\""</span></span><span class="org-block"> + href + </span><span class="org-block"><span class="string">"\"&gt;"</span></span><span class="org-block">;
        $result_inner += sec_title + </span><span class="org-block"><span class="string">"&lt;/a&gt; &lt;small&gt;[score: "</span></span><span class="org-block"> +
            res[3].toFixed(3) + </span><span class="org-block"><span class="string">"]&lt;/small&gt;&lt;/li&gt;"</span></span><span class="org-block">;
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (title.localeCompare(title_prev) == 0) {
            $result = $result_inner;
        } </span><span class="org-block"><span class="keyword">else</span></span><span class="org-block"> {
            </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (title_prev.localeCompare(</span><span class="org-block"><span class="string">""</span></span><span class="org-block">) != 0) {
                $result += </span><span class="org-block"><span class="string">"&lt;/ul&gt;&lt;/li&gt;"</span></span><span class="org-block">
            }
            $result += </span><span class="org-block"><span class="string">"&lt;li&gt;"</span></span><span class="org-block"> + title + </span><span class="org-block"><span class="string">"&lt;ul&gt;"</span></span><span class="org-block">;
            $result += $result_inner;
        }
        $result_all += $result;
        title_prev = title;
    }
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (res_top.length &gt; 0) {
        $result_all += </span><span class="org-block"><span class="string">"&lt;/ul&gt;&lt;/li&gt;"</span></span><span class="org-block">
    }
    $(</span><span class="org-block"><span class="string">'#results'</span></span><span class="org-block">).append($result_all);
}
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Initialization</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-init</span>
<span class="org-special-keyword">:END:</span>

The following instantiates the <span class="org-verbatim">=json=</span> index download when loading the page.

<span class="org-meta-line">#+name: search-js-init</span>
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">// </span></span><span class="org-block"><span class="comment">Initialize
</span></span><span class="org-block">initLunr();

$(document).ready(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
    initUI();
});
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Results highlighting</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">search-js-highlight</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle org/_resources/highlight.js</span>
<span class="org-special-keyword">:END:</span>

When a search is performed, the search term is passed to the target page via the
URL (the <span class="org-code">~highlight~</span> parameter).  The <span class="org-code">~highlight~</span> parameter is parsed by the
<span class="org-link"><a href="(js-search-render)">render function</a></span>.  The highlighting is handled by the <span class="org-code">~highlight.js~</span> library:
1. jump to the first search result,
2. highlight the search results (using <span class="org-code">~mark.js~</span>).

When the <span class="org-code">~highlight~</span> parameter is passed, a search bar is shown on the target
page, with buttons to navigate through results.  This is shown on
Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="fig-highlight">fig-highlight</a></span>.

<span class="org-meta-line">#+name: search-js-highlight</span>
<span class="org-block-begin-line">#+begin_src javascript
</span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">currentClass</span></span><span class="org-block"> = </span><span class="org-block"><span class="string">"current"</span></span><span class="org-block">;
</span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">currentIndex</span></span><span class="org-block"> = 0;

</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">jumpTo</span></span><span class="org-block">() {
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> ($mark_results.length) {
        </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">position</span></span><span class="org-block">,
            $current = $mark_results.eq(currentIndex);
        $mark_results.removeClass(currentClass);
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> ($current.length) {
            $current.addClass(currentClass);
            position = $current.offset().top;
            window.scrollTo(0, position);
        }
    }
}

$(</span><span class="org-block"><span class="string">'#searchbar_search'</span></span><span class="org-block">).on(</span><span class="org-block"><span class="string">"input"</span></span><span class="org-block">, </span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">searchVal</span></span><span class="org-block"> = </span><span class="org-block"><span class="constant">this</span></span><span class="org-block">.value;
    $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).unmark({
        </span><span class="org-block"><span class="function-name">done</span></span><span class="org-block">: </span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
            $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).mark(searchVal, {
                separateWordSearch: </span><span class="org-block"><span class="constant">true</span></span><span class="org-block">,
                </span><span class="org-block"><span class="function-name">done</span></span><span class="org-block">: </span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
                    $results = $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).find(</span><span class="org-block"><span class="string">"mark"</span></span><span class="org-block">);
                    currentIndex = 0;
                    jumpTo();
                }
            });
        }
    });
});

</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">searchbar_clear</span></span><span class="org-block">() {
    $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).unmark();
    $(</span><span class="org-block"><span class="string">'#searchbar_search'</span></span><span class="org-block">).val(</span><span class="org-block"><span class="string">""</span></span><span class="org-block">).focus();
    $(</span><span class="org-block"><span class="string">'#searchbar'</span></span><span class="org-block">).hide();
}

</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">searchbar_next</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">dir</span></span><span class="org-block">) {
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> ($mark_results.length) {
        currentIndex += dir ? 1 : -1;
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (currentIndex &lt; 0) {
            currentIndex = $mark_results.length - 1;
        }
        </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (currentIndex &gt; $mark_results.length - 1) {
            currentIndex = 0;
        }
        jumpTo();
    }
}

</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">highlight</span></span><span class="org-block">(</span><span class="org-block"><span class="variable-name">query</span></span><span class="org-block">) {
    $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).unmark({
        </span><span class="org-block"><span class="function-name">done</span></span><span class="org-block">: </span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
            $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).mark(query, {
                separateWordSearch: </span><span class="org-block"><span class="constant">true</span></span><span class="org-block">,
                </span><span class="org-block"><span class="function-name">done</span></span><span class="org-block">: </span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
                    $mark_results = $(</span><span class="org-block"><span class="string">'#content'</span></span><span class="org-block">).find(</span><span class="org-block"><span class="string">"mark"</span></span><span class="org-block">);
                    currentIndex = 0;
                    </span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> (currentIndex &lt; $mark_results.length &amp;&amp;
                           $mark_results[currentIndex].offsetTop &lt;
                           $(window).scrollTop()) {
                        currentIndex++;
                    }
                    jumpTo();
                }
            });
        }
    });
}

$(document).ready(</span><span class="org-block"><span class="keyword">function</span></span><span class="org-block">() {
    url = window.location.search;
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (url[0] == </span><span class="org-block"><span class="string">"?"</span></span><span class="org-block">) {
        url = url.slice(1);
    }
    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">urlParams</span></span><span class="org-block"> = </span><span class="org-block"><span class="keyword">new</span></span><span class="org-block"> </span><span class="org-block"><span class="type">URLSearchParams</span></span><span class="org-block">(url);
    </span><span class="org-block"><span class="keyword">var</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">urlQuery</span></span><span class="org-block"> = urlParams.get(</span><span class="org-block"><span class="string">'highlight'</span></span><span class="org-block">);
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> (urlQuery != </span><span class="org-block"><span class="constant">null</span></span><span class="org-block">) {
        highlight(urlQuery);
        $(</span><span class="org-block"><span class="string">'#searchbar'</span></span><span class="org-block">).show();
        $(</span><span class="org-block"><span class="string">'#searchbar_search'</span></span><span class="org-block">).val(urlQuery);
        $(</span><span class="org-block"><span class="string">'#searchbar_search'</span></span><span class="org-block">).attr(</span><span class="org-block"><span class="string">'disabled'</span></span><span class="org-block">, </span><span class="org-block"><span class="string">'disabled'</span></span><span class="org-block">);
    }
});
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: fig-highlight</span>
<span class="org-meta-line">#+attr_html: :width 70%</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Search results highlighting and search bar (in the top right corner).</span>
<span class="org-link"><a href="file:../images/2017-08-15-Personal_wiki_in_org/highlight.png">file:../images/2017-08-15-Personal_wiki_in_org/highlight.png</a></span>


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> CSS</span>

Styling for the wiki is identical to that of the <span class="org-link"><a href="file:2016-11-13-Personal_website_in_org.org">website</a></span>.  The following source
block creates a symbolic link to the website css.

<span class="org-meta-line">#+name: wiki-css-wiki</span>
<span class="org-block-begin-line">#+begin_src sh
</span><span class="org-block">ln -sf ../../../website/org/css/site.css org/_resources/wiki.css
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Search</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle org/_resources/search.css</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">css-search</span>
<span class="org-special-keyword">:END:</span>

The highlighting of the search results and the appearance of the search bar are
controlled by the <span class="org-code">~search.css~</span> file.

<span class="org-meta-line">#+name: css-search</span>
<span class="org-block-begin-line">#+begin_src css
</span><span class="org-block"><span class="css-selector">mark </span></span><span class="org-block">{
  </span><span class="org-block"><span class="css-property">background</span></span><span class="org-block">: </span><span class="org-block"><span class="custom-2"><span class="custom-3">yellow</span></span></span><span class="org-block">;
}

</span><span class="org-block"><span class="css-selector">mark.current </span></span><span class="org-block">{
  </span><span class="org-block"><span class="css-property">background</span></span><span class="org-block">: </span><span class="org-block"><span class="custom-1"><span class="custom-3">orange</span></span></span><span class="org-block">;
}

</span><span class="org-block"><span class="css-selector">#searchbar </span></span><span class="org-block">{
    </span><span class="org-block"><span class="css-property">position</span></span><span class="org-block">: fixed;
    </span><span class="org-block"><span class="css-property">top</span></span><span class="org-block">: 20px;
    </span><span class="org-block"><span class="css-property">right</span></span><span class="org-block">: 5px;
    </span><span class="org-block"><span class="css-property">display</span></span><span class="org-block">: none;
    </span><span class="org-block"><span class="css-property">z-index</span></span><span class="org-block">: 1;
}

</span><span class="org-block"><span class="css-selector">#searchbar_prev, #searchbar_next, #searchbar_clear </span></span><span class="org-block">{
    </span><span class="org-block"><span class="css-property">padding</span></span><span class="org-block">: 5px;
    </span><span class="org-block"><span class="css-property">min-width</span></span><span class="org-block">: 20px;
    </span><span class="org-block"><span class="css-property">height</span></span><span class="org-block">: 40px;
}
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Org header</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wiki-setup-org</span>
<span class="org-special-keyword">:END:</span>

Wiki pages are processed before publishing to include the following org-setup.
This configures common options:
- path and configuration for <span class="org-link"><a href="(org-setup-info-js)">=org-info.js=</a></span>
  (<span class="org-link"><a href="http://orgmode.org/worg/code/org-info-js/">http://orgmode.org/worg/code/org-info-js/</a></span>), which provides navigation tools
  for published pages,
- the path to a local instance of <span class="org-link"><a href="(org-setup-mathjax)">MathJax</a></span>,
- the CSS for the website,
- the <span class="org-link"><a href="#wiki-js-libs">javascript libraries used</a></span>.

<span class="org-meta-line">#+name: org-setup</span>
<span class="org-meta-line">#+header: :tangle org/setup.org</span>
<span class="org-block-begin-line">#+begin_src org -r -l " #(ref:%s)"
</span><span class="org-block">,#+INFOJS_OPT: toc:t tdepth:2 view:showall ftoc:t ltoc:nil path:_resources/org-info.js #(ref:org-setup-info-js)
,#+PROPERTY: header-args :eval no-export :exports code
,#+STARTUP: nohideblocks
,#+MACRO: tt \nbsp{}
,#+MACRO: kbd call_el-common-kbd[:eval yes :results value raw :exports results]($1) #(ref:org-setup-kbd)
,#+HTML_MATHJAX: path:"_resources/MathJax/MathJax.js?config=TeX-AMS_HTML" #(ref:org-setup-mathjax)
,#+HTML_HEAD_EXTRA: &lt;link rel="stylesheet" type="text/css" href="_resources/code.css"/&gt;
,#+HTML_HEAD_EXTRA: &lt;link rel="stylesheet" type="text/css" href="_resources/wiki.css"/&gt;
,#+HTML_HEAD_EXTRA: &lt;link rel="stylesheet" type="text/css" href="_resources/search.css"/&gt;
,#+HTML_HEAD_EXTRA: &lt;script type="text/javascript" src="_resources/jquery-2.1.3.min.js"&gt;&lt;/script&gt;
,#+HTML_HEAD_EXTRA: &lt;script type="text/javascript" src="_resources/jquery.mark.min.js"&gt;&lt;/script&gt;
,#+HTML_HEAD_EXTRA: &lt;script type="text/javascript" src="_resources/highlight.js"&gt;&lt;/script&gt;
,#+HTML_HEAD_EXTRA: &lt;link rel="search" type="application/opensearchdescription+xml" title="Org-wiki search" href="_resources/opensearch.xml"/&gt;
</span><span class="org-block-end-line">#+end_src
</span>
The <span class="org-link"><a href="(org-setup-kbd)">~kbd~</a></span> macro relies on a org-mode source block defined in <span class="org-verbatim">=source-blocks.org=</span>
(also from the <span class="org-link"><a href="file:2016-11-13-Personal_website_in_org.org">website</a></span> setup).  I use a symlink to the version used in my
personal website.

<span class="org-meta-line">#+name: org-source-block-ln</span>
<span class="org-block-begin-line">#+begin_src sh
</span><span class="org-block">ln -sf ../../website/org/source-blocks.org org/source-blocks.org
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Basic wiki pages</span>

Wikipages are simple org files which are exported to HTML during the call to the
<span class="org-link"><a href="el-setup-publish-function">publishing function</a></span>.  The wiki comes with three predefined pages described in
this section.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-level-3"><span class="org-verbatim">=index=</span></span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wiki-page-index</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=index.org=</span> page is the welcome page of the published wiki (published to
<span class="org-verbatim">=index.html=</span>).  It may contain a general welcome message, custom links, etc.  In
this example the index page contains:

1. a table with all the wikipages grouped by category (the generation of the
   page index is described <span class="org-link"><a href="#org-wiki-index-page">here</a></span>),
2. a link to a <span class="org-verbatim">=demo=</span> page demonstrating the wiki functionality (e.g. markup,
   links),
3. a link to the full sitemap.


<span class="org-meta-line">#+name: wikipage-index</span>
<span class="org-meta-line">#+header: :tangle org/index.org :noweb yes</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">,#+TITLE: index
,#+STARTUP: overview

,* Index

</span><span class="org-block"><span class="org-target">&lt;&lt;el-index-marker()&gt;&gt;</span></span><span class="org-block">


,* Editing help
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">editing_help</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

</span><span class="org-block"><span class="org-link"><a href="file:demo.org">[[file:demo.org][demo]]</a></span></span><span class="org-block">


,* Sitemap
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">sitemap</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

</span><span class="org-block"><span class="org-link"><a href="file:sitemap.org">[[file:sitemap.org][Sitemap]]</a></span></span><span class="org-block">
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-level-3"><span class="org-verbatim">=search=</span></span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wiki-page-search</span>
<span class="org-special-keyword">:END:</span>

The search page (<span class="org-verbatim">=search.org=</span>) is relatively simple: it contains an input area
for the user to enter search terms and a result section.  It must also include
the appropriate javascript libraries.

<span class="org-meta-line">#+name: wikipage-search</span>
<span class="org-meta-line">#+header: :tangle org/search.org</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">,#+TITLE: Search
,#+HTML_HEAD_EXTRA: &lt;script type="text/javascript" src="_resources/lunr.js"&gt;&lt;/script&gt;
,#+HTML_HEAD_EXTRA: &lt;script type="text/javascript" src="_resources/search.js"&gt;&lt;/script&gt;
,#+BEGIN_EXPORT html
Search:
&lt;input id="search" type="text" /&gt;
&lt;br&gt; Results:
&lt;ul id="results"&gt;
&lt;/ul&gt;
,#+END_EXPORT
</span><span class="org-block-end-line">#+end_src
</span>
An example of rendered search page is shown on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="fig-search-page">fig-search-page</a></span>.

<span class="org-meta-line">#+name: fig-search-page</span>
<span class="org-meta-line">#+attr_html: :width 55%</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Search page with search results.</span>
<span class="org-link"><a href="file:../images/2017-08-15-Personal_wiki_in_org/searchpage.png">file:../images/2017-08-15-Personal_wiki_in_org/searchpage.png</a></span>


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-level-3"><span class="org-verbatim">=demo=</span></span>

The <span class="org-verbatim">=demo.org=</span> page is meant as a help for the wiki.  It is designed to describe
the main functionality:

- text formatting,
- links,
- equations,
- tikz diagrams,
- figure creation using source blocks,
- citations to refbase instance.


<span class="org-meta-line">#+name: wikipage-demo</span>
<span class="org-meta-line">#+header: :tangle org/demo.org</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">,#+TITLE: demo
,#+DESCRIPTION:
,#+KEYWORDS: help
,#+STARTUP: overview
,#+PROPERTY: header-args+ :eval no-export

,* Editing the wiki
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">editing_the_wiki</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

To edit the wiki, perform the following:
1. Open a terminal (or putty)
2. ssh to the server
3. Open emacs: </span><span class="org-block"><span class="org-code">~emacs -nw </span></span><span class="org-block"><span class="org-code"><span class="org-code">~/org/org-wiki/index.org~</span></span></span><span class="org-block">
4. Open the wiki page (a </span><span class="org-block"><span class="org-verbatim">=.org=</span></span><span class="org-block"> file) to edit
   - </span><span class="org-block"><span class="org-macro">{{{kbd("C-x C-f")}}}</span></span><span class="org-block"> then enter a filename in </span><span class="org-block"><span class="org-verbatim">=~/org/org-wiki/=</span></span><span class="org-block">
   - Alternatively, use the </span><span class="org-block"><span class="org-verbatim">=projectile=</span></span><span class="org-block"> package with </span><span class="org-block"><span class="org-macro">{{{kbd("C-c p f")}}}</span></span><span class="org-block"> and
     select a file from the list
5. Edit the file
   - See the </span><span class="org-block"><span class="org-link"><a href="#navigation">[[#navigation]]</a></span></span><span class="org-block"> and </span><span class="org-block"><span class="org-link"><a href="#formatting">[[#formatting]]</a></span></span><span class="org-block"> sections for help on using org-mode
   - See the rest of the file for details about advanced editing (equations,
     diagrams, code blocks)
   - Note that when using a terminal, some keyboard shortcuts may not work
     (e.g. some keybindings involving the </span><span class="org-block"><span class="org-macro">{{{kbd("Alt")}}}</span></span><span class="org-block"> key)
6. Save the file (</span><span class="org-block"><span class="org-macro">{{{kbd("C-x C-s")}}}</span></span><span class="org-block">)
7. To update the website run the command: </span><span class="org-block"><span class="org-code">~org-wiki-publish~</span></span><span class="org-block">
   - </span><span class="org-block"><span class="org-macro">{{{kbd("M-x")}}}</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~org-wiki-publish~</span></span><span class="org-block">


,* Navigation
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">navigation</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

See the org-mode documentation for navigation commands and keyboard shortcuts:
- </span><span class="org-block"><span class="org-link"><a href="http://orgmode.org/manual/Motion.html">http://orgmode.org/manual/Motion.html</a></span></span><span class="org-block">
- </span><span class="org-block"><span class="org-link"><a href="http://orgmode.org/manual/Document-structure.html#Document-structure">http://orgmode.org/manual/Document-structure.html#Document-structure</a></span></span><span class="org-block">
- </span><span class="org-block"><span class="org-link"><a href="http://orgmode.org/orgcard.txt">http://orgmode.org/orgcard.txt</a></span></span><span class="org-block">


,* Formatting
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">formatting</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

- The formatting syntax is that of emacs org-mode (see the </span><span class="org-block"><span class="org-link"><a href="http://orgmode.org/manual/Markup.html">[[http://orgmode.org/manual/Markup.html][documentation]]</a></span></span><span class="org-block">).
  - </span><span class="org-block"><span class="org-list-dt">bold ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~*bold*~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="bold">*bold*</span></span><span class="org-block">
  - </span><span class="org-block"><span class="org-list-dt">italic ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~/italic/~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="italic">/italic/</span></span><span class="org-block">
  - </span><span class="org-block"><span class="org-list-dt">underlined ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~_underlined_~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="underline">_underlined_</span></span><span class="org-block">
  - </span><span class="org-block"><span class="org-list-dt">verbatim ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~=verbatim=~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="org-verbatim">=verbatim=</span></span><span class="org-block">
  - </span><span class="org-block"><span class="org-list-dt">code ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~~code~~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="org-code">~code~</span></span><span class="org-block">
  - </span><span class="org-block"><span class="org-list-dt">strike-through ::</span></span><span class="org-block"> </span><span class="org-block"><span class="org-code">~+strike-through+~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="custom">+strike-through+</span></span><span class="org-block">
- To render keyboard shortcuts, the </span><span class="org-block"><span class="org-code">~kbd~</span></span><span class="org-block"> macro can be used: </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-macro"><span class="org-code">{{{kbd("C-c C-x
  p")}}}</span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="org-macro">{{{kbd("C-c C-x p")}}}</span></span><span class="org-block">.


,* Links
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">links</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

To link to a wiki page, simply insert </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-link"><span class="org-code"><a href="file:page_name.org">file:page_name.org</a></span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"> into the page
(e.g. </span><span class="org-block"><span class="org-link"><a href="file:index.org">file:index.org</a></span></span><span class="org-block">).  In order to change the label, use </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-link"><span class="org-code"><a href="file:page_name.org">[[file:page_name.org][Displayed label]]</a></span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block">
(e.g. </span><span class="org-block"><span class="org-link"><a href="file:index.org">[[file:index.org][Index]]</a></span></span><span class="org-block">).

To link to a specific subsection, use regular org links
(</span><span class="org-block"><span class="org-link"><a href="http://orgmode.org/manual/Search-options.html#Search-options">http://orgmode.org/manual/Search-options.html#Search-options</a></span></span><span class="org-block">): </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-link"><span class="org-code"><a href="file:blender.org::#how_to">[[file:blender.org::#how_to][link label]]</a></span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block">
results in the following link: </span><span class="org-block"><span class="org-link"><a href="file:blender.org::#how_to">[[file:blender.org::#how_to][link label]]</a></span></span><span class="org-block"> (the anchor name </span><span class="org-block"><span class="org-verbatim">=#how_to=</span></span><span class="org-block"> corresponds
to the </span><span class="org-block"><span class="org-verbatim">=CUSTOM_ID=</span></span><span class="org-block"> headline property).  To use the heading title instead of the
</span><span class="org-block"><span class="org-verbatim">=CUSTOM_ID=</span></span><span class="org-block"> property, use </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-link"><span class="org-code"><a href="file:blender.org::*How to">[[file:blender.org::*How to][link label]]</a></span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"> which results in a similar link: </span><span class="org-block"><span class="org-link"><a href="file:blender.org::*How to">[[file:blender.org::*How to][link
label]]</a></span></span><span class="org-block">.


,* Equations
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">equations</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

Inline equations can be wrapped with </span><span class="org-block"><span class="org-code">~$~</span></span><span class="org-block"> characters, e.g. </span><span class="org-block"><span class="org-code">~$1 + 1 = 2$~</span></span><span class="org-block">
(rendered as</span><span class="org-block"><span class="org-latex-and-related"> $1 + 1 = 2$)</span></span><span class="org-block">.  Longer equations can be defined within </span><span class="org-block"><span class="org-code">~align~</span></span><span class="org-block">
blocks:

,#+NAME: eq-demo
,#+begin_src latex :results drawer :exports both
</span><span class="org-block"><span class="org-latex-and-related">\begin{align}
e^{i\pi} + 1 &amp;= 0\\
\sum_{n=1}^{\infty}\frac{1}{n^2} &amp;= \frac{\pi^2}{6}\\
\int_{-\infty}^{\infty}e^{-t^2} &amp;= \sqrt{\pi}
\end{align}</span></span><span class="org-block">
,#+end_src

is rendered as:

,#+RESULTS: eq-demo
</span><span class="org-block"><span class="org-special-keyword">:RESULTS:</span></span><span class="org-block">
</span><span class="org-block"><span class="org-latex-and-related">\begin{align}
e^{i\pi} + 1 &amp;= 0\\
\sum_{n=1}^{\infty}\frac{1}{n^2} &amp;= \frac{\pi^2}{6}\\
\int_{-\infty}^{\infty}e^{-t^2} &amp;= \sqrt{\pi}
\end{align}</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">:END:</span></span><span class="org-block">


,** TikZ diagrams
</span><span class="org-block"><span class="org-special-keyword">   :PROPERTIES:</span></span><span class="org-block">
   </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">tikz_diagrams</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">   :END:</span></span><span class="org-block">

TikZ diagrams can be inserted via latex source blocks:

,#+begin_src org
,,#+NAME: demo-tikz
,,#+header: :imagemagick t :mkdirp yes
,,#+header: :iminoptions -density 300 :imoutoptions -geometry 1024 -trim
,,#+begin_src latex :file demo/tikz.png :results raw :exports results
</span><span class="org-block"><span class="org-latex-and-related">\begin{tikzpicture}
  \draw node (a) [draw] {$h(t)$} (a.west) --
  ++(-1,0) node[left] {$x(t)$} circle[radius=2pt] (a.east) --
  ++(1,0) node[right] {$y(t)=h(t)*x(t)$} circle[radius=2pt];
\end{tikzpicture}</span></span><span class="org-block">
,,#+end_src
,#+end_src

which produces the image in Fig.\nbsp </span><span class="org-block"><span class="org-link"><a href="fig-demo-tikz">[[fig-demo-tikz]]</a></span></span><span class="org-block"> (the </span><span class="org-block"><span class="org-code">~geometry~</span></span><span class="org-block"> option
controls the size of the output image).

,#+NAME: demo-tikz
,#+header: :imagemagick t :mkdirp yes
,#+header: :iminoptions -density 300 :imoutoptions -geometry 1024 -trim
,#+begin_src latex :file demo/tikz.png :results raw :exports results
</span><span class="org-block"><span class="org-latex-and-related">\begin{tikzpicture}
  \draw node (a) [draw] {$h(t)$} (a.west) --
  ++(-1,0) node[left] {$x(t)$} circle[radius=2pt] (a.east) --
  ++(1,0) node[right] {$y(t)=h(t)*x(t)$} circle[radius=2pt];
\end{tikzpicture}</span></span><span class="org-block">
,#+end_src

,#+NAME: fig-demo-tikz
,#+CAPTION: tikz caption
,#+RESULTS: demo-tikz
</span><span class="org-block"><span class="org-link"><a href="file:demo/tikz.png">[[file:demo/tikz.png]]</a></span></span><span class="org-block">


,* Source blocks
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">source_blocks</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

Source blocks should not be executed on export (set </span><span class="org-block"><span class="org-code">~:eval~</span></span><span class="org-block"> to </span><span class="org-block"><span class="org-code">~no-export~</span></span><span class="org-block">,
ideally in the header </span><span class="org-block"><span class="org-code">~#+PROPERTY: header-args+ :eval no-export~</span></span><span class="org-block">).

Here is an example in python:

,#+BEGIN_SRC org
,,#+NAME: plot-test
,,#+BEGIN_SRC python :session yes :results file :exports both
import numpy as np
import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
fname = 'demo/test.png'
plt.clf()
plt.plot(np.random.random(100))
plt.savefig(fname)
fname
,,#+END_SRC
,#+END_SRC

which renders the code:

,#+NAME: plot-test
,#+BEGIN_SRC python :session yes :results file :exports both
import numpy as np
import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
fname = 'demo/test.png'
plt.clf()
plt.plot(np.random.random(100))
plt.savefig(fname)
fname
,#+END_SRC

and the output figure:

,#+RESULTS: plot-test
</span><span class="org-block"><span class="org-link"><a href="file:demo/test.png">[[file:demo/test.png]]</a></span></span><span class="org-block">


,* Citations
</span><span class="org-block"><span class="org-special-keyword">  :PROPERTIES:</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-special-keyword">:CUSTOM_ID:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">citations</span></span><span class="org-block">
</span><span class="org-block"><span class="org-special-keyword">  :END:</span></span><span class="org-block">

Papers from a refbase installation can be inserted using the </span><span class="org-block"><span class="org-code">~refbase:~</span></span><span class="org-block"> link
type: </span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"><span class="org-link"><span class="org-code"><a href="refbase:Marin2010c">refbase:Marin2010c</a></span></span></span><span class="org-block"><span class="org-code">~</span></span><span class="org-block"> is rendered as </span><span class="org-block"><span class="org-link"><a href="refbase:Marin2010c">refbase:Marin2010c</a></span></span><span class="org-block">.
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Dotfiles setup</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle my_wiki.el</span>
<span class="org-special-keyword">:END:</span>

This section contains the setup code to store in emacs init file (<span class="org-verbatim">=.emacs=</span>).


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Org-wiki configuration</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">dotfiles-org-wiki</span>
<span class="org-special-keyword">:END:</span>

The minimum configuration must define the <span class="org-code">~org-wiki-location~</span> variable.  The
following uses an auxiliary function <span class="org-code">~&#8482;/get-perso~</span> which can be replaced by a
full path.

<span class="org-meta-line">#+name: el-dotfiles-org-wiki</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> org-wiki-location (&#8482;/get-perso </span><span class="org-block"><span class="string">"wiki-path"</span></span><span class="org-block">)
      org-wiki-index-level-max 3
      org-wiki-index-file </span><span class="org-block"><span class="string">"_resources/wiki.json"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Refbase configuration</span>

To use the <span class="org-link"><a href="#refbase">refbase</a></span> package, the URL and the name of the MySQL database must be
defined.

<span class="org-meta-line">#+name: el-dotfiles-refbase</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block">(</span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> refbase-url (&#8482;/get-perso </span><span class="org-block"><span class="string">"refbase-url"</span></span><span class="org-block">)
      refbase-db </span><span class="org-block"><span class="string">"refbase"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+end_src
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Bash helpers</span>

Finally, some useful bash functions are defined in the following source block.

- The path to the wiki must be set <span class="org-link"><a href="(bash-wiki-path)">here</a></span>,
- the <span class="org-link"><a href="(bash-owg)">~owg~</a></span> function greps the content of the wikipages for a search string.
  Lines around the match are shown (using <span class="org-code">~-B~</span> and <span class="org-code">~-A~</span> grep options).
- The <span class="org-link"><a href="(bash-owe)">~owe~</a></span> and <span class="org-link"><a href="(bash-owt)">~owt~</a></span> functions open emacs (more specifically emacsclient) in
  graphical and terminal mode respectively.  These functions support
  <span class="org-link"><a href="(bash-ow-comp)">auto-completion</a></span>.

<span class="org-meta-line">#+name: bashrc</span>
<span class="org-block-begin-line">#+begin_src sh -r -l " #(ref:%s)"
</span><span class="org-block"><span class="comment-delimiter">## </span></span><span class="org-block"><span class="comment">Wiki location
</span></span><span class="org-block"><span class="variable-name">wiki_path</span></span><span class="org-block">=~/dotfiles/emacs/wiki/org/ </span><span class="org-block"><span class="comment-delimiter">#</span></span><span class="org-block"><span class="comment">(ref:bash-wiki-path)
</span></span><span class="org-block">
</span><span class="org-block"><span class="comment-delimiter">## </span></span><span class="org-block"><span class="comment">Alias
</span></span><span class="org-block"><span class="builtin">alias</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">ow</span></span><span class="org-block">=</span><span class="org-block"><span class="string">'pushd ${wiki_path}'</span></span><span class="org-block">

</span><span class="org-block"><span class="comment-delimiter">## </span></span><span class="org-block"><span class="comment">Search function
</span></span><span class="org-block"><span class="function-name">owg</span></span><span class="org-block">(){ </span><span class="org-block"><span class="comment-delimiter">#</span></span><span class="org-block"><span class="comment">(ref:bash-owg)
</span></span><span class="org-block">    (</span><span class="org-block"><span class="builtin">cd</span></span><span class="org-block"> ${</span><span class="org-block"><span class="variable-name">wiki_path</span></span><span class="org-block">} &amp;&amp; find ./ -name </span><span class="org-block"><span class="string">"*.org"</span></span><span class="org-block"> -exec grep -Hin </span><span class="org-block"><span class="string">"$1"</span></span><span class="org-block"> -B1 -A5 </span><span class="org-block"><span class="string">"{}"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">\;</span></span><span class="org-block">)
}

</span><span class="org-block"><span class="comment-delimiter">## </span></span><span class="org-block"><span class="comment">Open in emacs
</span></span><span class="org-block"><span class="function-name">org_wiki_open</span></span><span class="org-block">(){
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> [ $(</span><span class="org-block"><span class="sh-quoted-exec">dirname</span></span><span class="org-block"> $(</span><span class="org-block"><span class="sh-quoted-exec">readlink</span></span><span class="org-block"> -f </span><span class="org-block"><span class="string">"$1"</span></span><span class="org-block">)) ==
         $(</span><span class="org-block"><span class="sh-quoted-exec">dirname</span></span><span class="org-block"> $(</span><span class="org-block"><span class="sh-quoted-exec">readlink</span></span><span class="org-block"> -f </span><span class="org-block"><span class="string">"${wiki_path}/index.org"</span></span><span class="org-block">)) ]; </span><span class="org-block"><span class="keyword">then</span></span><span class="org-block">
        </span><span class="org-block"><span class="variable-name">name</span></span><span class="org-block">=$</span><span class="org-block"><span class="variable-name">1</span></span><span class="org-block">;
    </span><span class="org-block"><span class="keyword">else</span></span><span class="org-block">
        </span><span class="org-block"><span class="variable-name">name</span></span><span class="org-block">=${</span><span class="org-block"><span class="variable-name">wiki_path</span></span><span class="org-block">}/$</span><span class="org-block"><span class="variable-name">1</span></span><span class="org-block">
    </span><span class="org-block"><span class="keyword">fi</span></span><span class="org-block">
    </span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> [ </span><span class="org-block"><span class="string">"$2"</span></span><span class="org-block"> == </span><span class="org-block"><span class="string">"gui"</span></span><span class="org-block"> ]; </span><span class="org-block"><span class="keyword">then</span></span><span class="org-block">
        emacsclient -c -a </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"$name"</span></span><span class="org-block">
    </span><span class="org-block"><span class="keyword">elif</span></span><span class="org-block"> [ </span><span class="org-block"><span class="string">"$2"</span></span><span class="org-block"> == </span><span class="org-block"><span class="string">"terminal"</span></span><span class="org-block"> ]; </span><span class="org-block"><span class="keyword">then</span></span><span class="org-block">
        emacsclient -c -t -a </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"$name"</span></span><span class="org-block">
    </span><span class="org-block"><span class="keyword">fi</span></span><span class="org-block">
}
</span><span class="org-block"><span class="function-name">owe</span></span><span class="org-block"> (){ </span><span class="org-block"><span class="comment-delimiter">#</span></span><span class="org-block"><span class="comment">(ref:bash-owe)
</span></span><span class="org-block">    org_wiki_open </span><span class="org-block"><span class="string">"$1"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"gui"</span></span><span class="org-block">
}
</span><span class="org-block"><span class="function-name">owt</span></span><span class="org-block"> (){ </span><span class="org-block"><span class="comment-delimiter">#</span></span><span class="org-block"><span class="comment">(ref:bash-owt)
</span></span><span class="org-block">    org_wiki_open </span><span class="org-block"><span class="string">"$1"</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"terminal"</span></span><span class="org-block">
}
</span><span class="org-block"><span class="comment-delimiter"># </span></span><span class="org-block"><span class="comment">Tab completion
</span></span><span class="org-block"><span class="function-name">_ow_comp</span></span><span class="org-block"> () { </span><span class="org-block"><span class="comment-delimiter">#</span></span><span class="org-block"><span class="comment">(ref:bash-ow-comp)
</span></span><span class="org-block">    </span><span class="org-block"><span class="variable-name">IFS</span></span><span class="org-block">=$</span><span class="org-block"><span class="string">'\n'</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">tmp</span></span><span class="org-block">=( $(</span><span class="org-block"><span class="sh-quoted-exec">compgen</span></span><span class="org-block"> -W </span><span class="org-block"><span class="string">"$(</span></span><span class="org-block"><span class="sh-quoted-exec">cd</span></span><span class="org-block"><span class="string"> "${wiki_path}" &amp;&amp; ls *.org)"</span></span><span class="org-block"> -- </span><span class="org-block"><span class="string">"${COMP_WORDS[$COMP_CWORD]}"</span></span><span class="org-block"> ))
    </span><span class="org-block"><span class="variable-name">COMPREPLY</span></span><span class="org-block">=( </span><span class="org-block"><span class="string">"${tmp[@]// /\ }"</span></span><span class="org-block"> )
}
</span><span class="org-block"><span class="builtin">complete</span></span><span class="org-block"> -o default -F _ow_comp owe
</span><span class="org-block"><span class="builtin">complete</span></span><span class="org-block"> -o default -F _ow_comp owt
</span><span class="org-block-end-line">#+end_src
</span></pre>
  </body>
</html>
