<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>2016-10-05-Awesome-wm_configuration.org</title>
    <style type="text/css">
    <!--
      body {
        color: #000000;
        background-color: #ffffff;
      }
      .ATTRLIST {
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #483d8b;
      }
      .comment {
        /* font-lock-comment-face */
        color: #b22222;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #b22222;
      }
      .constant {
        /* font-lock-constant-face */
        color: #008b8b;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #0000ff;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #a020f0;
      }
      .makefile-targets {
        /* makefile-targets */
        color: #0000ff;
      }
      .org-block {
        /* org-block */
        color: #7f7f7f;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #b22222;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #b22222;
      }
      .org-checkbox {
        /* org-checkbox */
        font-weight: bold;
      }
      .org-checkbox-statistics-done {
        /* org-checkbox-statistics-done */
        color: #228b22;
        font-weight: bold;
      }
      .org-code {
        /* org-code */
        color: #7f7f7f;
      }
      .org-document-info {
        /* org-document-info */
        color: #191970;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #7f7f7f;
      }
      .org-document-title {
        /* org-document-title */
        color: #191970;
        font-weight: bold;
      }
      .org-done {
        /* org-done */
        color: #228b22;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #0000ff;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #a0522d;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #a020f0;
      }
      .org-level-4 {
        /* org-level-4 */
        color: #b22222;
      }
      .org-level-5 {
        /* org-level-5 */
        color: #228b22;
      }
      .org-link {
        /* org-link */
        color: #3a5fcd;
        text-decoration: underline;
      }
      .org-list-dt {
        /* org-list-dt */
        font-weight: bold;
      }
      .org-macro {
        /* org-macro */
        color: #8b4513;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #b22222;
      }
      .org-property-value {
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #a020f0;
      }
      .org-tag {
        /* org-tag */
        font-weight: bold;
      }
      .org-verbatim {
        /* org-verbatim */
        color: #7f7f7f;
      }
      .python-cell-cellbreak {
        /* python-cell-cellbreak-face */
        font-weight: bold;
        text-decoration: overline;
      }
      .sh-escaped-newline {
        /* sh-escaped-newline */
        color: #8b2252;
      }
      .sh-quoted-exec {
        /* sh-quoted-exec */
        color: #ff00ff;
      }
      .string {
        /* font-lock-string-face */
        color: #8b2252;
      }
      .type {
        /* font-lock-type-face */
        color: #228b22;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #a0522d;
      }
      .warning {
        /* font-lock-warning-face */
        color: #ff0000;
        font-weight: bold;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+SETUPFILE: ../setup.org</span>
<span class="org-document-info-keyword">#+TITLE:</span> <span class="org-document-title">Awesome-wm configuration
</span><span class="org-document-info-keyword">#+DATE:</span> <span class="org-document-info">&lt;2016-10-05 Wed&gt;
</span><span class="org-meta-line">#+OPTIONS: ^:t H:4</span>
<span class="org-meta-line">#+TODO: TODO REVIEW | DONE DEFERRED ABANDONED</span>
<span class="org-meta-line">#+INFOJS_OPT: view:content toc:t mouse:t ltoc:nil ftoc:nil</span>
<span class="org-meta-line">#+PROPERTY: COOKIE_DATA todo recursive</span>
<span class="org-meta-line">#+PROPERTY: header-args :tangle rc.lua</span>
<span class="org-meta-line">#+PROPERTY: header-args+ :exports code</span>
<span class="org-meta-line">#+PROPERTY: header-args+ :comments link</span>
<span class="org-meta-line">#+STARTUP: hideblocks</span>
<span class="org-meta-line">#+MACRO: tt \nbsp{}</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Introduction </span><span class="org-checkbox-statistics-done">[2/2]</span>

This file contains my configuration for the <span class="org-link"><a href="https://awesome.naquadah.org/">[[https://awesome.naquadah.org/][awesome]]</a></span> window manager along with
documentation of the different modules developed and used. The actual
configuration (a set of lua files) can be produced by running <span class="org-verbatim">=org-babel-tangle=</span>
on the original org file.

The resulting desktop is shown on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop-main]]</a></span>.  The following
bash script produces the image.  The most interesting part is the top wibox,
which is shown enlarged on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span>.

<span class="org-meta-line">#+NAME: sh-scrot-main</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports code :tangle no :cache yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Could get these from xrandr
</span></span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block">=1920
</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block">=1080
</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block">=1

</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> ))
</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block"> ))
</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block"> * $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> ))
</span><span class="variable-name"><span class="org-block">start_y</span></span><span class="org-block">=$(( 0 ))

scrot desktop.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_y</span></span><span class="org-block">} desktop-main.png
rm desktop.png -rf
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS[B5C042D3841BEB561E6A367F03D0611474D96782]: sh-scrot-main</span>


<span class="org-meta-line">#+NAME: img-desktop-main</span>
<span class="org-meta-line">#+ATTR_HTML: :width 100%</span>
<span class="org-meta-line">#+CAPTION:</span> <span class="org-block">My awesome-wm desktop.
</span><span class="org-link"><a href="file:../images/2016-10-05-Awesome-wm_configuration/desktop-main.png">[[file:../images/2016-10-05-Awesome-wm_configuration/desktop-main.png]]</a></span>


This configuration is currently used on the following system:

- <span class="org-list-dt">OS ::</span> 
<span class="org-meta-line">#+NAME: sh-debian-version</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :results verbatim :exports both :tangle no
</span><span class="org-block">lsb_release -a
uname -a
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: sh-debian-version</span>
<span class="org-code">: Distributor ID:   Debian
: Description:  Debian GNU/Linux testing (stretch)
: Release:  testing
: Codename: stretch
: Linux dell-desktop 4.6.0-1-amd64 #1 SMP Debian 4.6.4-1 (2016-07-18) x86_64 GNU/Linux
</span>
- <span class="org-list-dt">awesome ::</span> 
<span class="org-meta-line">#+NAME: sh-awesome-wm-version</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :results verbatim :exports both :tangle no
</span><span class="org-block">awesome --version
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: sh-awesome-wm-version</span>
<span class="org-code">: awesome v3.5.9 (Mighty Ravendark)
:  &#8226; Build: Mar 27 2016 02:23:55 for x86_64 by gcc version 5.3.1 (pbuilder@minjo)
:  &#8226; Compiled against Lua 5.1.5 (running with Lua 5.1)
:  &#8226; D-Bus support: &#10004;
</span>
- <span class="org-list-dt">emacs ::</span> 
<span class="org-meta-line">#+NAME: el-emacs-version</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp :results verbatim :exports both :tangle no
</span><span class="org-block">(emacs-version)
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: el-emacs-version</span>
<span class="org-code">: "GNU Emacs 24.5.1 (x86_64-pc-linux-gnu, GTK+ Version 3.21.5)
:  of 2016-09-05 on trouble, modified by Debian"
</span>
- <span class="org-list-dt">org-mode ::</span> 
<span class="org-meta-line">#+NAME: el-org-version</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp :results verbatim :exports both :tangle no
</span><span class="org-block">(replace-regexp-in-string </span><span class="string"><span class="org-block">"@.*)"</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"@ ... )"</span></span><span class="org-block"> (org-version nil t))
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: el-org-version</span>
<span class="org-code">: "Org mode version 8.3.6 (release_8.3.6-1210-gd942f7 @ ... )"
</span>
Most of the code in this configuration comes from the default <span class="org-verbatim">=rc.lua=</span> delivered
with awesome-wm.  On my system, it is located under <span class="org-verbatim">=/etc/xdg/awesome/rc.lua=</span>.

Tangling this org file produces several lua files.  The main configuration is
contained in the <span class="org-verbatim">=rc.lua=</span> file (widgets, keybindings), and code for modules is
tangled to separate files.  To disable a component of this configuration, the
corresponding code block must be skipped during tangling.  To disable tangling
of an individual block, the preferred way is to add the <span class="org-verbatim">=header-args=</span> property
on the parent heading:

<span class="org-block-begin-line">#+BEGIN_SRC org :tangle no
</span><span class="org-block">,** Disabled heading
</span><span class="org-special-keyword"><span class="org-block">   :PROPERTIES:</span></span><span class="org-block">
   </span><span class="org-special-keyword"><span class="org-block">:header-args:</span></span><span class="org-block"> </span><span class="org-property-value"><span class="org-block">:tangle no</span></span><span class="org-block">
</span><span class="org-special-keyword"><span class="org-block">   :END:</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>
This can be done by adding the text manually or by using the <span class="org-verbatim">=org-set-property=</span>
function, which is bound to <span class="org-verbatim">=C-c C-x p=</span> by default.  Alternatively, individual
source blocks can be disabled by adding <span class="org-verbatim">=:tangle no=</span> on the <span class="org-verbatim">=#+BEGIN_SRC=</span> line.

It is important to note that when tangling this file, any change made directly
to the lua files will be overridden by the code in this org file.  This can be
prevented by changing the permissions of the tangled files (see
<span class="org-link"><a href="http://orgmode.org/manual/tangle_002dmode.html">[[http://orgmode.org/manual/tangle_002dmode.html]]</a></span>).  Alternatively, the detangle
functionality in org-mode can be utilized to merge changes from the lua files
back to this org file: simply run <span class="org-verbatim">=org-detangle=</span> from the modified lua file and
changes should be merged back.  This requires the <span class="org-verbatim">=#+PROPERTY: comments link=</span>
option which is set at the top of this file.

This org file can also be exported to html to produce the documentation.  Note
that exporting this file (e.g. to HTML) executes some bash scripts (for
screenshots for instance), so use at your own risk.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Requirements</span>


- The only non-standard awesome library required should be <span class="org-link"><a href="https://awesome.naquadah.org/wiki/Blingbling">[[https://awesome.naquadah.org/wiki/Blingbling][blingbling]]</a></span> which I
  have checked out from git into <span class="org-verbatim">=~/.config/awesome/blingbling=</span>.  The blingbling
  path should be accessible by the lua import system.  See the <span class="org-link"><a href="nil:nil">[[#import_blingbling][blingbling import
  section]]</a></span> for the list of components which require blingbling.

- Since the configuration is written in an org-mode file, emacs is also required
  to extract (tangle) the lua code.  A makefile is provided to run the tangle
  operation on this file from the command line (the <span class="org-link"><a href="https://www.gnu.org/software/make">[[https://www.gnu.org/software/make][GNU make]]</a></span> utility is required
  to use the makefile).  It also requires a recent version of org-mode, and
  basic emacs modes for lua and python.

- The music player widget requires <span class="org-link"><a href="https://cmus.github.io/">[[https://cmus.github.io/][cmus]]</a></span> and uses <span class="org-link"><a href="http://eyed3.nicfit.net/">[[http://eyed3.nicfit.net/][eyeD3]]</a></span> to extract cover art from
  audio files.

- The bash script used to display the volume through OSD requires the <span class="org-verbatim">=aosd_cat=</span>
  command.

- The memory monitor widget uses the <span class="org-verbatim">=htop=</span> command to display a summary of the
  processes when moving the mouse over the widget.  This can be replaced by the
  <span class="org-verbatim">=top=</span> command for instance.

- The calendar widget lists events for each day using <span class="org-link"><a href="https://github.com/pimutils/khal">[[https://github.com/pimutils/khal][khal]]</a></span>.  I have it
  synchronized to my (<span class="org-link"><a href="http://owncloud.org">[[http://owncloud.org][owncloud]]</a></span>) CalDAV server using <span class="org-link"><a href="https://github.com/pimutils/vdirsyncer">[[https://github.com/pimutils/vdirsyncer][vdirsyncer]]</a></span>.

- The mail widget relies on <span class="org-link"><a href="https://www.djcbsoftware.nl/code/mu/">[[https://www.djcbsoftware.nl/code/mu/][mu]]</a></span> to find emails to show in the popup notification
  (emails are stored in maildir format).  This could be replaced by some other
  script for IMAP emails.

- The news widget requires a <span class="org-link"><a href="https://tt-rss.org/">[[https://tt-rss.org/][Tiny Tiny RSS]]</a></span> instance, and the <span class="org-link"><a href="https://github.com/Vassius/ttrss-pythom">[[https://github.com/Vassius/ttrss-pythom][ttrss-python]]</a></span>
  package; a wrapper python script to get news feeds is provided in this file.

- If using the <span class="org-link"><a href="nil:nil">[[#global_prompt][global prompt module]]</a></span>, some modes include additional dependencies:

  - The music prompt requires <span class="org-link"><a href="http://www.mplayerhq.hu/design7/news.html">[[http://www.mplayerhq.hu/design7/news.html][mplayer]]</a></span> and uses the <span class="org-verbatim">=locate=</span> program (part of the
    <span class="org-link"><a href="https://www.gnu.org/software/findutils/">[[https://www.gnu.org/software/findutils/][=findutils=]]</a></span> package) to find audio files.

  - The <span class="org-link"><a href="nil:nil">[[#global_prompt_calc][calc]]</a></span> prompt requires a python script to perform calculations from
    strings.  This script is provided in this org file.

- The transparency effect on focus (see the <span class="org-link"><a href="nil:nil">[[#effects_transparency][transparency]]</a></span> section) requires a
  compositor, such as <span class="org-verbatim">=xcompmgr=</span>.

- When generating the HTML documentation (by running <span class="org-verbatim">=C-c C-e h h=</span> on this
  buffer), screenshots are taken from the active desktop (assuming awesome-wm is
  the running desktop environment).  This requires the <span class="org-verbatim">=scrot=</span> and <span class="org-link"><a href="http://www.imagemagick.org">[[http://www.imagemagick.org][=imagemagick=]]</a></span>
  programs.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Makefile</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle makefile</span>
<span class="org-special-keyword">:END:</span>

A simple makefile can be used to generate the configuration files (<span class="org-verbatim">=.lua=</span>) and
the documentation.  Use <span class="org-verbatim">=make=</span> to update the configuration files from the org
source, <span class="org-verbatim">=make doc-html=</span> to export the org file into html.  The latex export
(<span class="org-verbatim">=make doc-pdf=</span>) is not supported (there is no syntax highlighting support for
lua in the <span class="org-verbatim">=minted=</span> package).

To get a reproducible <span class="org-verbatim">=make=</span> behavior, a minimal emacs initialization file is
provided here:

<span class="org-meta-line">#+NAME: makefile-init-el</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp :tangle makefile-init.el :noweb yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Assume default folder for emacs packages
</span></span><span class="org-block">(</span><span class="keyword"><span class="org-block">let</span></span><span class="org-block"> ((default-directory  </span><span class="string"><span class="org-block">"~/.emacs.d/elpa/"</span></span><span class="org-block">))
  (normal-top-level-add-subdirs-to-load-path))

</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Explicitly load required packages
</span></span><span class="org-block">(</span><span class="keyword"><span class="org-block">require</span></span><span class="org-block"> '</span><span class="constant"><span class="org-block">org</span></span><span class="org-block">)
(</span><span class="keyword"><span class="org-block">require</span></span><span class="org-block"> '</span><span class="constant"><span class="org-block">lua-mode</span></span><span class="org-block">)
(</span><span class="keyword"><span class="org-block">require</span></span><span class="org-block"> '</span><span class="constant"><span class="org-block">python-mode</span></span><span class="org-block">)

</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Set source block languages
</span></span><span class="org-block">(org-babel-do-load-languages
 'org-babel-load-languages
 '( (emacs-lisp . t)
    (lua        . t)
    (makefile   . t)
    (python     . t)
    (shell      . t)
    )
 )

</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Org options
</span></span><span class="org-block">(setq org-confirm-babel-evaluate nil)
(setq org-src-fontify-natively t)
(setq org-src-preserve-indentation t)
(setq org-edit-src-content-indentation 0)

</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Credential extraction function (uses auth-source)
</span></span><span class="org-block">&lt;&lt;ttrss-credentials&gt;&gt;

</span><span class="comment-delimiter"><span class="org-block">;; </span></span><span class="comment"><span class="org-block">Define credential extraction function before tangling
</span></span><span class="org-block">(add-hook 'org-babel-pre-tangle-hook 'get-ttrss-cred)
</span><span class="org-block-end-line">#+END_SRC
</span>
The makefile is relatively simple, one trick is to not use emacs in --batch mode
when generating the HTML documentation, since it seems to interact with syntax
highlighting.

<span class="org-meta-line">#+NAME: makefile</span>
<span class="org-block-begin-line">#+BEGIN_SRC makefile
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Makefile for org file, with targets:
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">all: Tangle source blocks
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">doc-html: Export org-file to html
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">doc-pdf: Export org-file to pdf
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Input org file
</span></span><span class="variable-name"><span class="org-block">input</span></span><span class="org-block"> = awesome-wm
</span><span class="variable-name"><span class="org-block">src</span></span><span class="org-block"> = $(</span><span class="variable-name"><span class="org-block">input</span></span><span class="org-block">).org

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Emacs command
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Note: I can't seem to get syntax highlighting in the exported html when using
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">--batch
</span></span><span class="variable-name"><span class="org-block">emacs</span></span><span class="org-block"> = emacs --batch --no-init-file --load makefile-init.el --find-file $(</span><span class="variable-name"><span class="org-block">src</span></span><span class="org-block">)
</span><span class="variable-name"><span class="org-block">emacs_batch</span></span><span class="org-block"> = ${</span><span class="variable-name"><span class="org-block">emacs</span></span><span class="org-block">} --batch

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Delete command
</span></span><span class="variable-name"><span class="org-block">RM</span></span><span class="org-block"> = rm -rf

</span><span class="makefile-targets"><span class="org-block">all</span></span><span class="org-block">:
    $(</span><span class="variable-name"><span class="org-block">emacs_batch</span></span><span class="org-block">) --funcall org-babel-tangle --kill

</span><span class="makefile-targets"><span class="org-block">doc-html</span></span><span class="org-block">:
    $(</span><span class="variable-name"><span class="org-block">emacs</span></span><span class="org-block">) --funcall org-html-export-to-html --kill

</span><span class="makefile-targets"><span class="org-block">doc-pdf</span></span><span class="org-block">:
    $(</span><span class="variable-name"><span class="org-block">emacs</span></span><span class="org-block">) --funcall org-latex-export-to-pdf --kill

</span><span class="makefile-targets"><span class="org-block">clean</span></span><span class="org-block">:
    $(</span><span class="variable-name"><span class="org-block">RM</span></span><span class="org-block">) $(</span><span class="variable-name"><span class="org-block">input</span></span><span class="org-block">).{html,tex,log,aux,dvi,pdf,ps,out,toc}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Imports </span><span class="org-checkbox-statistics-done">[12/12]</span>

The first section of the <span class="org-verbatim">=rc.lua=</span> file contains library imports used throughout
the file.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Standard awesome imports</span>

Standard modules listed here should come installed with awesome.

<span class="org-meta-line">#+NAME: src-imports-standard</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Standard awesome library
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">gears</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"gears"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">util</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.util"</span></span><span class="org-block">)
awful.rules = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.rules"</span></span><span class="org-block">)
</span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.autofocus"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Widget and layout library
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">wibox</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"wibox"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Theme handling library
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">vicious</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"vicious"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Notification library
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">menubar</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"menubar"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Paths</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">awesome_paths</span>
<span class="org-special-keyword">:END:</span>

Paths are stored in the <span class="org-verbatim">=awesome_paths=</span> object which is later used to search for
launchbar programs, theme selection, maildir, icons, etc.

<span class="org-meta-line">#+NAME: src-setup-paths</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Define global folders
</span></span><span class="org-block">awesome_paths = {}

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">config_dir is used for local theme customizations and shortcut search
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">(launchbar module)
</span></span><span class="org-block">awesome_paths.config_dir = awful.util.getdir(</span><span class="string"><span class="org-block">"config"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">system_dir is used for themes
</span></span><span class="org-block">awesome_paths.system_dir = </span><span class="string"><span class="org-block">"/usr/share/awesome/"</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">home_dir is used to locate the maildir, start dropbox
</span></span><span class="org-block">awesome_paths.home_dir = </span><span class="builtin"><span class="org-block">os</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">getenv</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"HOME"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Icon paths
</span></span><span class="org-block">awesome_paths.icon_dir = </span><span class="string"><span class="org-block">"/usr/share/icons/oxygen/base/16x16/"</span></span><span class="org-block">
awesome_paths.iconapps_dir = { awesome_paths.icon_dir,
                               </span><span class="string"><span class="org-block">"/usr/share/icons/hicolor/16x16/"</span></span><span class="org-block">,
                               </span><span class="string"><span class="org-block">"/usr/share/icons/gnome/16x16/"</span></span><span class="org-block">,
                               </span><span class="string"><span class="org-block">"/usr/share/icons/Tango/16x16/"</span></span><span class="org-block"> }
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Debian specific</span>

Use the menu provided on debian, it lists most applications in categories,
similar to main menus in other desktop environments.

<span class="org-meta-line">#+NAME: src-imports-debian</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Load Debian menu entries
</span></span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"debian.menu"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Blingbling</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">import_blingbling</span>
<span class="org-special-keyword">:END:</span>

The blingbling module is used by the following widgets:
- <span class="org-link"><a href="nil:nil">[[#volume][volume display and control]]</a></span>,
- <span class="org-link"><a href="nil:nil">[[#memory][memory usage monitor]]</a></span>,
- <span class="org-link"><a href="nil:nil">[[#calendar][calendar popup]]</a></span>

The blingbling library itself must be placed in a location accessible for the
import system.

<span class="org-meta-line">#+NAME: src-imports-blingbling</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Blingbling library
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">blingbling</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"blingbling"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Custom modules</span>

The following imports are for custom modules implemented in this file.  The
filenames should match the names used with the <span class="org-verbatim">=require=</span> command.

<span class="org-meta-line">#+NAME: src-imports-custom</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Custom libraries
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> launchbar module</span>

This module creates the launchers in the wibox from <span class="org-verbatim">=.desktop=</span> files (see the
<span class="org-link"><a href="nil:nil">[[#launchbar][Launchbar]]</a></span> section).

<span class="org-meta-line">#+NAME: src-imports-custom-launchbar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">launchbar</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'launchbar'</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> cmus module</span>

Control and display information from the <span class="org-link"><a href="https://cmus.github.io/">[[https://cmus.github.io/][cmus]]</a></span> music player (see the <span class="org-link"><a href="nil:nil">[[#cmus][cmus]]</a></span>
section).

<span class="org-meta-line">#+NAME: src-imports-custom-cmus</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">cmus</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> ttrss module</span>

View RSS feed updates from <span class="org-link"><a href="https://tt-rss.org/">[[https://tt-rss.org/][Tiny Tiny RSS]]</a></span> instance (see the <span class="org-link"><a href="nil:nil">[[#ttrss][Tiny Tiny RSS]]</a></span>
section).

<span class="org-meta-line">#+NAME: src-imports-custom-ttrss</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"ttrss"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> themes module</span>

Manage desktop themes (see the <span class="org-link"><a href="nil:nil">[[#theme][Theme]]</a></span> section).

<span class="org-meta-line">#+NAME: src-imports-custom-theme</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">theme_customization</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"theme_customization"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-verbatim"><span class="org-level-3">=icon_finder=</span></span><span class="org-level-3"> module</span>

Helper utility to find program icons in system paths (see the <span class="org-link"><a href="nil:nil">[[#icon_finder][Icon finder]]</a></span>
section).

<span class="org-meta-line">#+NAME: src-imports-custom-icon_finder</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_finder</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"icon_finder"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-verbatim"><span class="org-level-3">=global_prompt=</span></span><span class="org-level-3"> module</span>

Generic command launcher (gnome-do style) (see the <span class="org-link"><a href="nil:nil">[[#global_prompt][Global prompt]]</a></span> section).

<span class="org-meta-line">#+NAME: src-imports-custom-global_prompt</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">global_prompt</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"global_prompt"</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> </span><span class="org-verbatim"><span class="org-level-3">=my_utility=</span></span><span class="org-level-3"> module</span>

Some utility functions (see the <span class="org-link"><a href="nil:nil">[[#my_utility][Utilities]]</a></span> section).

<span class="org-meta-line">#+NAME: src-imports-custom-utility</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">my_utility</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'my_utility'</span></span><span class="org-block">)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Basic setup </span><span class="org-checkbox-statistics-done">[5/5]</span>

This section contains general settings for the different desktop components:
search paths, default applications, main key modifiers and some boiler plate
code for error handling.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Default programs</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">default_programs</span>
<span class="org-special-keyword">:END:</span>

Define default programs.

<span class="org-meta-line">#+NAME: src-setup-default-programs</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Define default programs
</span></span><span class="org-block">terminal = </span><span class="string"><span class="org-block">"x-terminal-emulator"</span></span><span class="org-block">
termapps = </span><span class="string"><span class="org-block">"terminator"</span></span><span class="org-block">
editor = </span><span class="builtin"><span class="org-block">os</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">getenv</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"EDITOR"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"editor"</span></span><span class="org-block">
editor_cmd = terminal .. </span><span class="string"><span class="org-block">" -e "</span></span><span class="org-block"> .. editor
internet_browser = </span><span class="string"><span class="org-block">"x-www-browser"</span></span><span class="org-block">
mail_reader = </span><span class="string"><span class="org-block">"icedove"</span></span><span class="org-block">
emacs = </span><span class="string"><span class="org-block">"emacs"</span></span><span class="org-block">
explorer = </span><span class="string"><span class="org-block">"xdg-open"</span></span><span class="org-block">
mixer = </span><span class="string"><span class="org-block">"pavucontrol"</span></span><span class="org-block">
music_player = </span><span class="string"><span class="org-block">"mplayer"</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Icons</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">icons</span>
<span class="org-special-keyword">:END:</span>

Create an instance of the <span class="org-link"><a href="nil:nil">[[#icon_finder][Icon finder]]</a></span> module.  It is used throughout the
configuration to find icons for programs and session operations (<span class="org-link"><a href="nil:nil">[[#shutdown][Shutdown menu]]</a></span>).

<span class="org-meta-line">#+NAME: src-setup-icons</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Icon finder
</span></span><span class="org-block">myiconfinder = icon_finder.new(awesome_paths.iconapps_dir)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Error handling</span>

This is default code; it creates notifications when errors occur, which is
helpful to debug issues in <span class="org-verbatim">=rc.lua=</span>.

<span class="org-meta-line">#+NAME: src-setup-error</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Error handling
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Check if awesome encountered an error during startup and fell back to
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">another config (This code will only ever execute for the fallback config)
</span></span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> awesome.startup_errors </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
    naughty.notify({ preset = naughty.config.presets.critical,
                     title = </span><span class="string"><span class="org-block">"Oops, there were errors during startup!"</span></span><span class="org-block">,
                     text = awesome.startup_errors })
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Handle runtime errors after startup
</span></span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">in_error</span></span><span class="org-block"> = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
    awesome.connect_signal(</span><span class="string"><span class="org-block">"debug::error"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (err)
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Make sure we don't go into an endless error loop
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> in_error </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        in_error = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">

        naughty.notify({ preset = naughty.config.presets.critical,
                         title = </span><span class="string"><span class="org-block">"Oops, an error happened!"</span></span><span class="org-block">,
                         text = err })
        in_error = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Modkey setting</span>

The modkey is the main key modifier for special bindings: use <span class="org-verbatim">=Super=</span> as main
modifier.  Also set <span class="org-verbatim">=Alt=</span> key.

<span class="org-meta-line">#+NAME: src-setup-modkey</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Default modkey.
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Usually, Mod4 is the key with a logo between Control and Alt.
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">If you do not like this or do not have such a key,
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">I suggest you to remap Mod4 to another key using xmodmap or other tools.
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">However, you can use another modifier like Mod1, but it may interact with
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">others.
</span></span><span class="org-block">modkey = </span><span class="string"><span class="org-block">"Mod4"</span></span><span class="org-block">
altkey = </span><span class="string"><span class="org-block">"Mod1"</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Initialize wibox widgets</span>

Create empty structures for different widgets.

<span class="org-meta-line">#+NAME: src-setup-init-widgets</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Initialize widgets
</span></span><span class="org-block">mywibox = {}
mywibox_prompt = {}
mypromptbox = {}
mypromptbox_conf = {}
mylayoutbox = {}
mytaglist = {}
mytasklist = {}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Desktop </span><span class="org-checkbox-statistics-done">[7/7]</span>

This configuration is used with a dual screen system, where the widgets are
identical on both screens (except for the systray, which can only be added to
one screen).  An example of wibox produced by this file is shown on
Fig<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span>.

The following bash snippet produces the screenshot shown on
Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span> on export (the result is cached, so it is not
re-generated if the content of the code block is not changed).

<span class="org-meta-line">#+NAME: sh-scrot-wibox</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports code :tangle no :cache yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Could get these from xrandr
</span></span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block">=1920
</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block">=1080
</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block">=0

</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> / 2 ))
</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">=25
</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block"> * $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> ))
</span><span class="variable-name"><span class="org-block">half_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block"> + $</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block"> ))

scrot desktop.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">}+0 desktop-wibox-l.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">half_x</span></span><span class="org-block">}+0 desktop-wibox-r.png
convert desktop-wibox-l.png desktop-wibox-r.png -append desktop-wibox.png
rm desktop.png desktop-wibox-l.png desktop-wibox-r.png -rf
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS[6DE29F351040F17242EA1C881DCEFF562100E5BB]: sh-scrot-wibox</span>



<span class="org-meta-line">#+NAME: img-desktop</span>
<span class="org-meta-line">#+ATTR_HTML: :width 100%</span>
<span class="org-meta-line">#+CAPTION:</span> <span class="org-block">Main wibox (split into two rows for display) with widgets (from left
</span><span class="org-meta-line">#+CAPTION:</span> <span class="org-block">to right): <a href="nil:nil">[[#main_menu][awesome menu]]</a>, <a href="nil:nil">[[#tags][tags]]</a>,
</span><span class="org-meta-line">#+CAPTION:</span> <span class="org-block"><a href="nil:nil">[[#launchbar][launchbar]]</a>, tasklist, <a href="nil:nil">[[#cmus][cmus]]</a>,
</span><span class="org-meta-line">#+CAPTION:</span> <span class="org-block"><a href="nil:nil">[[#email][mail]]</a>, <a href="nil:nil">[[#ttrss][ttrss]]</a>, <a href="nil:nil">[[#memory][memory]]</a>,
</span><span class="org-meta-line">#+CAPTION:</span> <span class="org-block"><a href="nil:nil">[[#volume][volume]]</a>, systray, <a href="nil:nil">[[#layouts][layout]]</a>,
</span><span class="org-meta-line">#+CAPTION:</span> <span class="org-block"><a href="nil:nil">[[#calendar][date + calendar]]</a>, <a href="nil:nil">[[#shutdown][shutdown menu]]</a>.
</span><span class="org-link"><a href="file:../images/2016-10-05-Awesome-wm_configuration/desktop-wibox.png">[[file:../images/2016-10-05-Awesome-wm_configuration/desktop-wibox.png]]</a></span>



<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Layouts</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">layouts</span>
<span class="org-special-keyword">:END:</span>

This section defines the layouts for windows, I use the default code, with a few
entries disabled.

<span class="org-meta-line">#+NAME: src-desktop-layouts</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Table of layouts to cover with awful.layout.inc, order matters.
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">layouts</span></span><span class="org-block"> </span><span class="warning"><span class="org-block">=</span></span><span class="org-block">
{
    awful.layout.suit.floating,
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">awful.layout.suit.tile,
</span></span><span class="org-block">    awful.layout.suit.tile.left,
    awful.layout.suit.tile.bottom,
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">awful.layout.suit.tile.top,
</span></span><span class="org-block">    awful.layout.suit.fair,
    awful.layout.suit.fair.horizontal,
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">awful.layout.suit.spiral,
</span></span><span class="org-block">    awful.layout.suit.spiral.dwindle,
    awful.layout.suit.max,
    awful.layout.suit.max.fullscreen,
    awful.layout.suit.magnifier
}
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Theme</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">theme</span>
<span class="org-special-keyword">:END:</span>

Themes are handled through the <span class="org-verbatim">=beautiful=</span> module, which creates the <span class="org-verbatim">=beautiful=</span>
table upon instantiation.  Themes are assumed to be located in sub-folders of
the paths defined by the <span class="org-verbatim">=awesome_paths.themes_system_path=</span> and
<span class="org-verbatim">=awesome_paths.themes_custom_path=</span> variables.  They are defined by a <span class="org-verbatim">=theme.lua=</span>
file (the filename can be customized by modifying
<span class="org-verbatim">=theme_customatization.theme_file=</span>) and possibly a <span class="org-verbatim">=custom.lua=</span> file (the
filename can be customized by modifying <span class="org-verbatim">=theme_customatization.custom_file=</span>).
The <span class="org-verbatim">=theme.lua=</span> file fully defines the theme (colors, icons, etc.) and the
<span class="org-verbatim">=custom.lua=</span> is used to locally modify theme values.

Some of the custom modules used in this configuration rely on an extended
<span class="org-verbatim">=beautiful=</span> table.  Any required field that is not in the original <span class="org-verbatim">=beautiful=</span>
table <span class="bold">*must*</span> be defined in the <span class="org-verbatim">=themes/custom_defaults.lua=</span> file and can be
overridden by individual themes in the <span class="org-verbatim">=custom.lua=</span> file.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Theme management module</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle theme_customization.lua</span>
<span class="org-special-keyword">:END:</span>

The theme module has two main functions:
- list the available themes into a theme menu,
- define a complete <span class="org-verbatim">=beautiful=</span> table for a given theme.

The <span class="org-verbatim">=theme_customatization.set_custom_theme=</span> function takes a theme name as
input along with the <span class="org-link"><a href="nil:nil">[[#awesome_paths][=awesome_paths=]]</a></span> variable.  It searches files named
<span class="org-verbatim">=theme.lua=</span> in the custom and system theme paths.  If a theme is found, the
<span class="org-verbatim">=beautiful.init=</span> function is called to initialize the <span class="org-verbatim">=beautiful=</span> table.  Next,
the <span class="org-verbatim">=custom_defaults.lua=</span> file is executed to complete the <span class="org-verbatim">=beautiful=</span> variables
with the custom ones required by this configuration.  Finally, the <span class="org-verbatim">=beautiful=</span>
table is augmented by inserting fields found in the theme's <span class="org-verbatim">=custom.lua=</span> file
(if present).

<span class="org-meta-line">#+NAME: module-theme</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Theme helper script
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">dofile</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">dofile</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">lfs</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"lfs"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">gears</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"gears"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">util</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.util"</span></span><span class="org-block">)

theme_customization = {}
theme_customization.theme_file = </span><span class="string"><span class="org-block">"theme.lua"</span></span><span class="org-block">
theme_customization.custom_file = </span><span class="string"><span class="org-block">"custom.lua"</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">theme_customization.set_custom_theme</span></span><span class="org-block">(theme, awesome_paths)

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Locate theme file
</span></span><span class="org-block">   path_list = {
      awesome_paths.themes_custom_path .. theme,
      awesome_paths.themes_system_path .. theme,
   }
   fname_theme = get_first_found_file(path_list,
                                      theme_customization.theme_file)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> fname_theme </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Locate customization file
</span></span><span class="org-block">   fname_custom = get_first_found_file(path_list,
                                       theme_customization.custom_file)

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Initialize beautiful theme
</span></span><span class="org-block">   beautiful.init(fname_theme)

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Load default customization (fields required by rc.lua not defined by
</span></span><span class="org-block">   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">regular themes)
</span></span><span class="org-block">   fname_custom_defaults = awesome_paths.themes_custom_path
      .. </span><span class="string"><span class="org-block">"/custom_defaults.lua"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(fname_custom_defaults) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">dofile</span></span><span class="org-block">(fname_custom_defaults) </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">`custom_defaults` table
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      custom_defaults = {}
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Load theme customization
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> fname_custom </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">dofile</span></span><span class="org-block">(fname_custom) </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">`custom` table
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      custom = {a=</span><span class="string"><span class="org-block">"b"</span></span><span class="org-block">}
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Join all tables
</span></span><span class="org-block">   custom_tables = { custom_defaults, custom }
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(custom_tables) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">key</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">value</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">(t) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         beautiful[key] = value
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">get_first_found_file</span></span><span class="org-block">(path_list, fname)
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(path_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      fname_full = f .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. fname
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(fname_full) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> fname_full
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">theme_customization.create_themes_menu</span></span><span class="org-block">(awesome_paths)

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">List of search paths
</span></span><span class="org-block">   path_list = {
      awesome_paths.themes_custom_path,
      awesome_paths.themes_system_path,
   }

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Initialize table
</span></span><span class="org-block">   theme_list = {}

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Perform search
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">path</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(path_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">fold</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> lfs.dir(path) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         f_attr = lfs.attributes(path .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. fold, </span><span class="string"><span class="org-block">"mode"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> f_attr </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> f_attr == </span><span class="string"><span class="org-block">"directory"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block">
            fold ~= </span><span class="string"><span class="org-block">"."</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> fold ~= </span><span class="string"><span class="org-block">".."</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            fname_full = path .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. fold .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> ..
               theme_customization.theme_file
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(fname_full) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> theme_list[fold] </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  theme_list[fold] = path .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. fold .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> ..
                     theme_customization.theme_file
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create menu
</span></span><span class="org-block">   menuitems = {}
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">theme_name</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">theme_file</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">(theme_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      theme = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">dofile</span></span><span class="org-block">(theme_file)
      theme_icon = theme.awesome_icon
      theme = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(menuitems, {
         theme_name,
         </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
            </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">theme_fname</span></span><span class="org-block"> = awesome_paths.themes_custom_path .. </span><span class="string"><span class="org-block">"/theme"</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">file</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">open</span></span><span class="org-block">(theme_fname, </span><span class="string"><span class="org-block">"w"</span></span><span class="org-block">)
            <a href="file:write">file:write</a>(theme_name .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block">)
            <a href="file:close">file:close</a>()
            awesome.restart()
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
         theme_icon })
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> menuitems
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> theme_customization
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> The </span><span class="org-verbatim"><span class="org-level-3">=custom_defaults=</span></span><span class="org-level-3"> file</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle themes/custom_defaults.lua</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=custom_defaults=</span> file returns a table with theme parameters required by
modules and absent from the original <span class="org-verbatim">=beautiful=</span> table.  For visual consistency,
some of the fields use values from the <span class="org-verbatim">=beautiful=</span> table itself.

<span class="org-meta-line">#+NAME: src-desktop-theme-custom_defaults</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua :mkdirp yes
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)

custom_defaults = {}

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">mail widget
</span></span><span class="org-block">custom_defaults.mail_fg_urgent = beautiful.fg_urgent
custom_defaults.mail_fg_normal = beautiful.fg_normal
custom_defaults.mail_fg_focus = beautiful.fg_focus

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">memory widget
</span></span><span class="org-block">custom_defaults.mem_bg = beautiful.bg_normal

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">cmus widget
</span></span><span class="org-block">custom_defaults.cmus_fg = beautiful.fg_normal

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">screen highlighter
</span></span><span class="org-block">custom_defaults.screen_highlight_bg_active = beautiful.bg_minimize
custom_defaults.screen_highlight_fg_active = beautiful.fg_minimize
custom_defaults.screen_highlight_bg_inactive = beautiful.bg_normal
custom_defaults.screen_highlight_fg_inactive = beautiful.fg_normal

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> custom_defaults
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Theme selection</span>

In the main <span class="org-verbatim">=rc.lua=</span> file, the theme folders are first added to the
<span class="org-verbatim">=awesome_paths=</span> table (<span class="org-verbatim">=awesome_paths.themes_system_path=</span> and
<span class="org-verbatim">=awesome_paths.themes_custom_path=</span>).  Then the theme to load is read from the
<span class="org-verbatim">=themes/theme=</span> file.  This file should contain a single line with the name of
the theme to use (see the <span class="org-link"><a href="nil:nil">[[src-theme-file][theme definition block]]</a></span>).  Note that lines starting
with "#" are ignored (such lines occur when tangling this org-file, to allow
"de-tangling").  Also note that parsing is rudimentary so empty lines may cause
issues.

<span class="org-meta-line">#+NAME: src-desktop-theme</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Theme management
</span></span><span class="org-block">awesome_paths.themes_system_path = awesome_paths.system_dir .. </span><span class="string"><span class="org-block">"/themes/"</span></span><span class="org-block">
awesome_paths.themes_custom_path = awesome_paths.config_dir .. </span><span class="string"><span class="org-block">"/themes/"</span></span><span class="org-block">
theme_fname = awesome_paths.themes_custom_path .. </span><span class="string"><span class="org-block">"/theme"</span></span><span class="org-block">
theme_name = </span><span class="string"><span class="org-block">"default"</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(theme_fname) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">open</span></span><span class="org-block">(theme_fname, </span><span class="string"><span class="org-block">"r"</span></span><span class="org-block">)
   theme_lines = my_utility.lines(f:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">))
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">k</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">(theme_lines) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">find</span></span><span class="org-block">(v, </span><span class="string"><span class="org-block">"^%s*[^#]"</span></span><span class="org-block">) ~= </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         theme_name = v:gsub(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"%1"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   f:close()
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Set themes
</span></span><span class="org-block">theme_customization.set_custom_theme(theme_name, awesome_paths)

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Build theme selection menu
</span></span><span class="org-block">theme_menuitems = theme_customization.create_themes_menu(awesome_paths)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Wallpaper
</span></span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> beautiful.wallpaper </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      gears.wallpaper.maximized(beautiful.wallpaper, s, </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">--</span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Selected theme</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle themes/theme</span>
<span class="org-special-keyword">:END:</span>

To change the default theme, change the content of the following <span class="org-verbatim">=themes/theme=</span>
file:

<span class="org-meta-line">#+NAME: src-theme-file</span>
<span class="org-block-begin-line">#+BEGIN_SRC conf
</span><span class="org-block">
</span><span class="variable-name"><span class="org-block">default</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Tags</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">tags</span>
<span class="org-special-keyword">:END:</span>

Tags are similar to workspaces in other desktop environments.  My configuration
is for my home desktop, which has two screens.  It is only slightly modified
from the default: a few tags are named instead of numbered and the default
layout on some tags is customized.

- The first tag on each screen is for email: one for work using icedove and one
  for my personal email using mu4e (emacs).  These are not started
  automatically, I have a <span class="org-link"><a href="nil:nil">[[#rules][rule]]</a></span> to force icedove on the second screen, and I
  manually start mu4e on the desired tag.
- The second tag on the second screen is used for my resident instances or
  <span class="org-link"><a href="http://newsbeuter.org/">[[http://newsbeuter.org/][newsbeuter]]</a></span> (terminal RSS reader) and <span class="org-link"><a href="https://cmus.github.io/">[[https://cmus.github.io/][cmus]]</a></span> (terminal music player).  Both
  programs are launched on startup (see <span class="org-link"><a href="nil:nil">[[#startup_applications][Startup applications]]</a></span>) and rules are used
  to place them on the right screen and tag (see the <span class="org-link"><a href="nil:nil">[[#rules][Rules]]</a></span> section).

<span class="org-meta-line">#+NAME: src-desktop-tags</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Tags
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Define a tag table which hold all screen tags.
</span></span><span class="org-block">tags = {
   {
      names  = { </span><span class="string"><span class="org-block">"@"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"www"</span></span><span class="org-block">, 3, 4, 5, 6, 7, 8, 9 },
      layout = { layouts[5], layouts[2], layouts[2], layouts[2], layouts[2],
                 layouts[2], layouts[2], layouts[2], layouts[1]}
   },
   {
      names  = { </span><span class="string"><span class="org-block">"@"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"news/cmus"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"www"</span></span><span class="org-block">, 4, 5, 6, 7, 8, 9 },
      layout = { layouts[2], layouts[2], layouts[2], layouts[2], layouts[2],
                 layouts[2], layouts[2], layouts[2], layouts[1]}
}}
</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Each screen has its own tag table.
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s &lt;= #tags </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> si = s </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block"> si = #tags </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   tags[s] = awful.tag(tags[si].names, s, tags[si].layout)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Main bar </span><span class="org-checkbox-statistics-done">[27/27]</span>

This section is the main part of the configuration, it defines and configures
the widgets present on the main wibox (Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span>).

Note that the widgets defined here must be later added to the wibox, which is
done in the <span class="org-link"><a href="nil:nil">[[#wibox][Wibox]]</a></span> section.

First, we create the simplest widget: a separator used to add visual spacing
between widgets.

<span class="org-meta-line">#+NAME: src-main-misc</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">---- </span></span><span class="comment"><span class="org-block">{{{ Separators
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">separator</span></span><span class="org-block"> = wibox.widget.textbox()
separator:set_markup(</span><span class="string"><span class="org-block">" &lt;span foreground='grey'&gt;&#183;&lt;/span&gt; "</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">---- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Launchbar</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">launchbar</span>
<span class="org-special-keyword">:END:</span>

In most desktop environments, application shortcuts are stored in <span class="org-verbatim">=.desktop=</span>
files that give the application name, icon, command, etc.  The specification is
available <span class="org-link"><a href="https://specifications.freedesktop.org/desktop-entry-spec/desktop-entry-spec-latest.html">[[https://specifications.freedesktop.org/desktop-entry-spec/desktop-entry-spec-latest.html][here]]</a></span>.  The standard <span class="org-verbatim">=awful.widget.launcher=</span> module allows to add
<span class="org-verbatim">=.desktop=</span> files to a launchbar which can be displayed in a wibox (as shown on
Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span>).

A few examples can be found online, most notably:
- <span class="org-link"><a href="https://awesome.naquadah.org/wiki/Quick_launch_bar_widget/3.5">[[https://awesome.naquadah.org/wiki/Quick_launch_bar_widget/3.5][The basic quick launch bar]]</a></span> requires <span class="org-verbatim">=.desktop=</span> files to include a <span class="org-verbatim">=Position=</span>
  field.  Usual <span class="org-verbatim">=.desktop=</span> files do not have this field so this is impractical.
- <span class="org-link"><a href="https://gist.github.com/alexander-yakushev/6343832">[[https://gist.github.com/alexander-yakushev/6343832][This script]]</a></span> lists all the <span class="org-verbatim">=.desktop=</span> files in a given folder and adds them to
  the launchbar.  If the position field is missing, it is replaced, and
  launchers are added in alphabetical order.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Module definition</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle launchbar.lua</span>
<span class="org-special-keyword">:END:</span>

This version is based on the second code segment, the only difference is that
the Exec entry of the <span class="org-verbatim">=.desktop=</span> file is cleaned up from its command line
arguments, such as "%u" for firefox (they seem to cause problems when
launching).  The other addition is the use of the custom <span class="org-verbatim">=icon_finder=</span> module
described in the <span class="org-link"><a href="nil:nil">[[#icon_finder][Icon finder]]</a></span> section.

<span class="org-meta-line">#+NAME: module-launchbar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Quick launchbar widget for Awesome WM
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block"><a href="http://awesome.naquadah.org/wiki/Quick_launch_bar_widget/3.5">http://awesome.naquadah.org/wiki/Quick_launch_bar_widget/3.5</a>
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Put into your awesome/ folder and add the following to rc.lua:
</span></span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">local launchbar = require('launchbar')
</span></span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">local mylb = launchbar("/path/to/directory/with/shortcuts")
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Then add mylb to the wibox.
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">layout</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"wibox.layout"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">launcher</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.widget.launcher"</span></span><span class="org-block">)

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">launchbar</span></span><span class="org-block"> = {}

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">getValue</span></span><span class="org-block">(t, key)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">res</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">find</span></span><span class="org-block">(t, key .. </span><span class="string"><span class="org-block">" *= *([^%c]+)%c"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> res
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">launchbar.new</span></span><span class="org-block">(filedir, icon_finder_helper)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> filedir </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">error</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"Launchbar: filedir was not specified"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   launchbar.icon_dirs = icondir
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">items</span></span><span class="org-block"> = {}
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">widget</span></span><span class="org-block"> = layout.fixed.horizontal()
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">files</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"ls "</span></span><span class="org-block"> .. filedir .. </span><span class="string"><span class="org-block">"*.desktop"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> files:lines() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">open</span></span><span class="org-block">(f):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
      cmd = getValue(t, </span><span class="string"><span class="org-block">"Exec"</span></span><span class="org-block">)
      cmd = cmd:gsub(</span><span class="string"><span class="org-block">"%%u"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      cmd = cmd:gsub(</span><span class="string"><span class="org-block">"%%U"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      cmd = cmd:gsub(</span><span class="string"><span class="org-block">"%%F"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(
         items, {
            image = icon_finder_helper:find(getValue(t,</span><span class="string"><span class="org-block">"Icon"</span></span><span class="org-block">)),
            command = cmd,
            position = </span><span class="builtin"><span class="org-block">tonumber</span></span><span class="org-block">(getValue(t,</span><span class="string"><span class="org-block">"Position"</span></span><span class="org-block">)) </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> 255 })
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sort</span></span><span class="org-block">(items, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(a,b) </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> a.position &lt; b.position </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(items) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> v.image </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         widget:add(launcher(v))
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> widget
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">setmetatable</span></span><span class="org-block">(launchbar, { __call = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(_, ...)
                                    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> launchbar.new(...) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> })
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Instantiation</span>

The simplest way to use the module is to symlink <span class="org-verbatim">=.desktop=</span> files into a folder
and instantiate the launchbar object with the same folder as a parameter.  My
shortcuts are in a subfolder of the awesome config folder called <span class="org-verbatim">=shortcuts=</span>.

Note that the creation function also takes the icon finder instance as a
parameter (created in the <span class="org-link"><a href="nil:nil">[[#icons][Icons]]</a></span> section).

<span class="org-meta-line">#+NAME: src-main-launchbar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Launchbar
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mylaunchbar</span></span><span class="org-block"> = launchbar.new(awesome_paths.config_dir .. </span><span class="string"><span class="org-block">"/shortcuts/"</span></span><span class="org-block">,
                                  myiconfinder)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Shutdown menu</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">shutdown</span>
<span class="org-special-keyword">:END:</span>

By default, awesome has no menu to restart or shutdown the computer, just an
option to logout.  The following adds a menu with common shutdown, restart,
logout and lock items.  There is no support for hibernation but it should be
easy to add.

The shutdown and restart commands typically require the root password so the
sudoers file must be edited to allow the desired user to run the <span class="org-verbatim">=shutdown=</span>
command without password.  On Debian, the sudoers file can be edited by running
<span class="org-verbatim">=sudo visudo=</span> from a terminal.  My sudoers file contains the following:

<span class="org-block-begin-line">#+BEGIN_SRC conf :tangle no
</span><span class="variable-name"><span class="org-block">username ALL</span></span><span class="org-block">=SHUTDOWN
</span><span class="variable-name"><span class="org-block">username ALL</span></span><span class="org-block">=NOPASSWD: SHUTDOWN
</span><span class="org-block-end-line">#+END_SRC
</span>
The menu is created as follows.  First, the icons are obtained from the <span class="org-link"><a href="nil:nil">[[#icons][icon
finder instance]]</a></span>, then the menu is built, wrapping commands with the
<span class="org-link"><a href="nil:nil">[[#my_utility_confirm][=confirm_action=]]</a></span> function, which prompts for confirmation.  Note that the
filenames used to recover icons are the ones used in common themes (icons are in
found in folders set in the <span class="org-verbatim">=awesome_paths=</span> variable).

<span class="org-meta-line">#+NAME: src-main-shutdown</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Shutdown menu
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Session management icons
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_shutdown</span></span><span class="org-block"> = myiconfinder:find(</span><span class="string"><span class="org-block">"system-shutdown.png"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_restart</span></span><span class="org-block"> = myiconfinder:find(</span><span class="string"><span class="org-block">"system-reboot.png"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_logout</span></span><span class="org-block"> = myiconfinder:find(</span><span class="string"><span class="org-block">"system-log-out.png"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_lock</span></span><span class="org-block"> = myiconfinder:find(</span><span class="string"><span class="org-block">"system-lock-screen.png"</span></span><span class="org-block">)

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Shutdown menu
</span></span><span class="org-block">myleave_menuitems = {
   { </span><span class="string"><span class="org-block">"shutdown"</span></span><span class="org-block">,
     </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() my_utility.confirm_action(
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
              awful.util.spawn(</span><span class="string"><span class="org-block">'sudo /sbin/shutdown -h now'</span></span><span class="org-block">)
           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shutdown"</span></span><span class="org-block">)
     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, icon_shutdown },
   { </span><span class="string"><span class="org-block">"restart"</span></span><span class="org-block">,
     </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() my_utility.confirm_action(
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
              awful.util.spawn(</span><span class="string"><span class="org-block">'sudo /sbin/shutdown -r now'</span></span><span class="org-block">)
           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Restart"</span></span><span class="org-block">)
     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
     icon_restart },
   { </span><span class="string"><span class="org-block">"logout"</span></span><span class="org-block">,
     </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() my_utility.confirm_action(
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
              awesome.quit()
           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Logout"</span></span><span class="org-block">)
     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
     icon_logout },
   { </span><span class="string"><span class="org-block">"lock"</span></span><span class="org-block">,
     </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() my_utility.confirm_action(
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
              awful.util.spawn(</span><span class="string"><span class="org-block">"xscreensaver-command -lock"</span></span><span class="org-block">)
           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Lock"</span></span><span class="org-block">)
     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
     icon_lock }
}
myleave_launcher = awful.widget.launcher({
      image = icon_shutdown,
      menu = awful.menu({ items = myleave_menuitems}) })
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Main menu</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">main_menu</span>
<span class="org-special-keyword">:END:</span>

The main menu is based on the default configuration with a few additions:
- Selected applications are added to an "Apps" submenu
- A theme selection menu
- A "Leave" menu to control the session (shutdown, restart, lock)

The icons are found using the <span class="org-link"><a href="nil:nil">[[#icon_finder][icon finder]]</a></span> module.

This code block also configures the menubar, which can be used to quickly find
and launch applications by typing part of their name.

<span class="org-meta-line">#+NAME: src-main-menu</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Menu
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a laucher widget and a main menu
</span></span><span class="org-block">myawesomemenu = {
   { </span><span class="string"><span class="org-block">"manual"</span></span><span class="org-block">, terminal .. </span><span class="string"><span class="org-block">" -e man awesome"</span></span><span class="org-block"> },
   { </span><span class="string"><span class="org-block">"edit config"</span></span><span class="org-block">, emacs .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> .. awesome.conffile },
   { </span><span class="string"><span class="org-block">"restart"</span></span><span class="org-block">, awesome.restart },
   { </span><span class="string"><span class="org-block">"quit"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() my_utility.confirm_action(
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
              awesome.quit()
           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Logout"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> }
}

mymainmenu = awful.menu({
      items = { { </span><span class="string"><span class="org-block">"awesome"</span></span><span class="org-block">, myawesomemenu, beautiful.awesome_icon },
         { </span><span class="string"><span class="org-block">"Debian"</span></span><span class="org-block">, debian.menu.Debian_menu.Debian,
           myiconfinder:find(</span><span class="string"><span class="org-block">"*debian"</span></span><span class="org-block">) },
         { </span><span class="string"><span class="org-block">"Terminal"</span></span><span class="org-block">, terminal, myiconfinder:find(</span><span class="string"><span class="org-block">"terminal"</span></span><span class="org-block">) },
         { </span><span class="string"><span class="org-block">"Apps"</span></span><span class="org-block">,
           {
              { </span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block">, termapps .. </span><span class="string"><span class="org-block">" -c cmus -e cmus"</span></span><span class="org-block">,
                myiconfinder:find(</span><span class="string"><span class="org-block">"multimedia-player"</span></span><span class="org-block">) },
              { </span><span class="string"><span class="org-block">"newsbeuter"</span></span><span class="org-block">, termapps .. </span><span class="string"><span class="org-block">" -c newsbeuter -e newsbeuter"</span></span><span class="org-block">,
                myiconfinder:find(</span><span class="string"><span class="org-block">"internet-news-reader"</span></span><span class="org-block">) },
              { </span><span class="string"><span class="org-block">"Internet"</span></span><span class="org-block">, internet_browser,
                myiconfinder:find(</span><span class="string"><span class="org-block">"web-browser"</span></span><span class="org-block">) },
              { </span><span class="string"><span class="org-block">"Mail reader"</span></span><span class="org-block">, mail_reader,
                myiconfinder:find(</span><span class="string"><span class="org-block">"internet-mail"</span></span><span class="org-block">) },
              { </span><span class="string"><span class="org-block">"emacs"</span></span><span class="org-block">, emacs, myiconfinder:find(emacs) }
           }
         },
         { </span><span class="string"><span class="org-block">"Themes"</span></span><span class="org-block">, theme_menuitems },
         { </span><span class="string"><span class="org-block">"Leave"</span></span><span class="org-block">, myleave_menuitems, icon_shutdown }
      }
})

mylauncher = awful.widget.launcher({ image = beautiful.awesome_icon,
                                     menu = mymainmenu })
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Menubar configuration
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Set the terminal for applications that require it
</span></span><span class="org-block">menubar.utils.terminal = terminal

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Volume widget</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">volume</span>
<span class="org-special-keyword">:END:</span>

The blingbling module provides a widget for displaying the volume.  Volume
control commands are also supported: a left click on the widget toggles the mute
option, a right click on the widget spawns a menu with a single entry linking to
the mixer program (see <span class="org-link"><a href="nil:nil">[[#default_programs][Default programs]]</a></span>).

<span class="org-meta-line">#+NAME: src-main-volume</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Volume
</span></span><span class="org-block">volume_text = wibox.widget.textbox()
volume_text:set_text(</span><span class="string"><span class="org-block">"&#128266;"</span></span><span class="org-block">)
volume_master = blingbling.volume({height = 18, width = 40, bar =</span><span class="constant"><span class="org-block">true</span></span><span class="org-block">,
                                   show_text = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">, label =</span><span class="string"><span class="org-block">"$percent%"</span></span><span class="org-block">})
volume_master:update_master()
volume_master:set_master_control()

volume_menu_items = {
   { </span><span class="string"><span class="org-block">"mixer"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () run_or_raise(mixer, { instance = </span><span class="string"><span class="org-block">"mixer"</span></span><span class="org-block"> }) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> }
}
volume_menu = awful.menu.new( { items = volume_menu_items } )
volume_buttons = awful.util.table.join(
   awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         awful.util.spawn(awesome_paths.config_dir ..
                          </span><span class="string"><span class="org-block">"/scripts/osdvol.sh mute"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 4, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         awful.util.spawn(awesome_paths.config_dir ..
                          </span><span class="string"><span class="org-block">"/scripts/osdvol.sh volup"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 5, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         awful.util.spawn(awesome_paths.config_dir ..
                          </span><span class="string"><span class="org-block">"/scripts/osdvol.sh voldown"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () volume_menu:toggle() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
volume_text:buttons(volume_buttons)
volume_master:buttons(volume_buttons)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> OSD volume</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle scripts/osdvol.sh</span>
<span class="org-special-keyword">:END:</span>

The volume widget relies on a bash script to control the volume (using the
<span class="org-verbatim">=amixer=</span> command).  It also displays the volume on the screen via OSD (using the
<span class="org-verbatim">=aosd_cat=</span> command.  The bash script is bound to volume keys on the keyboard
(see <span class="org-link"><a href="nil:nil">[[#bindings_keyboard][Keyboard bindings]]</a></span>).

<span class="org-meta-line">#+NAME: script-osd-sh</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :mkdirp yes :tangle-mode (identity #o755)
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">#</span></span><span class="comment"><span class="org-block">!/bin/bash
</span></span><span class="org-block">

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">constants
</span></span><span class="variable-name"><span class="org-block">FONT</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'-*-fixed-*-*-*-*-100-*-*-*-*-*-*-*'</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">COLOR</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"green"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">DELAY</span></span><span class="org-block">=4
</span><span class="variable-name"><span class="org-block">POS</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"bottom"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">ALIGN</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"center"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">BARMOD</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"percentage"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">VOLTXT</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"Volume"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">VOLMUTEDTXT</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"Muted"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">VOLSTEP</span></span><span class="org-block">=5%



</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">kills an existing osd_cat process
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">needed when holding down a key to force repaint of the onscreen message
</span></span><span class="function-name"><span class="org-block">preKill</span></span><span class="org-block">() {
    killall aosd_cat
}

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">gets the actual volume value
</span></span><span class="function-name"><span class="org-block">getVol</span></span><span class="org-block">() {
    </span><span class="variable-name"><span class="org-block">VOL</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"$(</span></span><span class="sh-quoted-exec"><span class="org-block">amixer</span></span><span class="string"><span class="org-block"> sget Master,0 | grep "</span></span><span class="org-block">Front Left:</span><span class="string"><span class="org-block">"|
           awk '{print $5}'|sed -r 's/[][]//g')"</span></span><span class="org-block">
}

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">gets the actual volume value and prints is on the screen
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">with a percent bar + a percent number
</span></span><span class="function-name"><span class="org-block">showVol</span></span><span class="org-block">() {
    getVol
    </span><span class="builtin"><span class="org-block">echo</span></span><span class="org-block"> $</span><span class="variable-name"><span class="org-block">VOL</span></span><span class="org-block"> |  aosd_cat -p 1 --fore-color=green --shadow-color=</span><span class="string"><span class="org-block">\#</span></span><span class="org-block">006633 </span><span class="sh-escaped-newline"><span class="org-block">\</span></span><span class="org-block">
                          --font=</span><span class="string"><span class="org-block">"Droid Sans Mono 32"</span></span><span class="org-block"> </span><span class="sh-escaped-newline"><span class="org-block">\</span></span><span class="org-block">
                          --x-offset=50 --y-offset=-0 --transparency=2 </span><span class="sh-escaped-newline"><span class="org-block">\</span></span><span class="org-block">
                          --fade-in=0 --fade-out=0 --fade-full=1000
}

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">reises the master channel by "VOLSTEP"
</span></span><span class="function-name"><span class="org-block">volUp</span></span><span class="org-block">() {
    amixer sset Master,0 </span><span class="string"><span class="org-block">"$VOLSTEP+"</span></span><span class="org-block">
}

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">decreases the master channel by "VOLSTEP"
</span></span><span class="function-name"><span class="org-block">volDown</span></span><span class="org-block">() {
    amixer sset Master,0 </span><span class="string"><span class="org-block">"$VOLSTEP-"</span></span><span class="org-block">
}

</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">mutes the master channel
</span></span><span class="function-name"><span class="org-block">volMute</span></span><span class="org-block">() {
    amixer sset Master,0 toggle
}


</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">main part
</span></span><span class="org-block">preKill

</span><span class="keyword"><span class="org-block">case</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"$1"</span></span><span class="keyword"><span class="org-block"> in</span></span><span class="org-block">
    </span><span class="string"><span class="org-block">"volup"</span></span><span class="org-block">)
            volUp
            showVol
            ;;
    </span><span class="string"><span class="org-block">"voldown"</span></span><span class="org-block">)
            volDown
            showVol
            ;;
    </span><span class="string"><span class="org-block">"mute"</span></span><span class="org-block">)
            volMute
            showVol
            ;;
    ,*)
            ;;
</span><span class="keyword"><span class="org-block">esac</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Memory</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">memory</span>
<span class="org-special-keyword">:END:</span>

Memory is monitored using another blingbling widget.  The widget setup was taken
from <span class="org-link"><a href="https://github.com/cedlemo/blingbling#line_graph">[[https://github.com/cedlemo/blingbling#line_graph][the blingbling example page]]</a></span>.  It spawns a popup window with the output of
the <span class="org-verbatim">=htop=</span> command on left-click (<span class="org-link"><a href="https://github.com/cedlemo/blingbling#popups">[[https://github.com/cedlemo/blingbling#popups][see here]]</a></span>).

<span class="org-meta-line">#+NAME: src-main-memory</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Memory usage
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">memory_label</span></span><span class="org-block"> = wibox.widget.textbox()
memory_label:set_text(</span><span class="string"><span class="org-block">"&#9636; "</span></span><span class="org-block">)
memory_label:set_align(</span><span class="string"><span class="org-block">"center"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">memory_graph</span></span><span class="org-block"> = blingbling.line_graph({
      height = 18,
      width = 40,
      show_text = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">,
      label = </span><span class="string"><span class="org-block">"$percent %"</span></span><span class="org-block">,
      rounded_size = 0.3,
      graph_background_color = beautiful.mem_bg
})
vicious.register(memory_graph, vicious.widgets.mem,</span><span class="string"><span class="org-block">'$1'</span></span><span class="org-block">,2)
blingbling.popups.htop(memory_graph, { terminal =  terminal })
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Calendar</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">calendar</span>
<span class="org-special-keyword">:END:</span>

The calendar widget implemented in blingbling is used to show the date and time
in the wibox.  It is combined with the <span class="org-verbatim">=khal=</span> program to display the agenda when
the mouse moves over a particular day in the popup calendar.  This assumes that
the <span class="org-verbatim">=khal=</span> program is installed and configured.

<span class="org-meta-line">#+NAME: src-main-calendar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Calendar
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a textclock widget
</span></span><span class="org-block">mytextclock = awful.widget.textclock()

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">calendar</span></span><span class="org-block"> = blingbling.calendar(mytextclock)
calendar:set_link_to_external_calendar(</span><span class="constant"><span class="org-block">true</span></span><span class="org-block">)
calendar:clear_and_add_function_get_events_from(
   </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(day, month, year)
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'khal agenda --days 1 '</span></span><span class="org-block"> ..
                            year .. </span><span class="string"><span class="org-block">'-'</span></span><span class="org-block"> .. month .. </span><span class="string"><span class="org-block">'-'</span></span><span class="org-block"> .. day)
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">out</span></span><span class="org-block"> = f:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
      f:close()
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> out
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Mail</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">email</span>
<span class="org-special-keyword">:END:</span>

I use maildir for my personal email, and mu for indexing.  The mail widget uses
the vicious maildir widget, combined with custom functions to display a summary
of active emails when moving the mouse over the widget.

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Module definition</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle mailhoover.lua</span>
<span class="org-special-keyword">:END:</span>

This module was taken from <span class="org-link"><a href="https://awesome.naquadah.org/wiki/Email_maildir_naughty_hoover">[[https://awesome.naquadah.org/wiki/Email_maildir_naughty_hoover][this post]]</a></span>, with small modifications to account for my
local setup.  In particular, the list of emails is obtained via a mu request
(<span class="org-verbatim">=querystring=</span>).

<span class="org-meta-line">#+NAME: module-mail</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">tostring</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">tostring</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">capi</span></span><span class="org-block"> = {
    mouse = mouse,
    screen = screen
}
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">os</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">os</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'beautiful'</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">my_utility</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"my_utility"</span></span><span class="org-block">)
</span><span class="builtin"><span class="org-block">module</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"mailhoover"</span></span><span class="org-block">)

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">popup</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mailhoover</span></span><span class="org-block"> = {}

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">mailhoover:addToWidget</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">print</span></span><span class="org-block">,mywidget, querystring, maxcount,
                                mail_colors)
   mywidget:connect_signal(
      </span><span class="string"><span class="org-block">'mouse::enter'</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">query_format</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"&lt;span color='"</span></span><span class="org-block"> .. beautiful.mail_fg_normal ..
            </span><span class="string"><span class="org-block">"'&gt;&lt;b&gt;&lt;u&gt;%s&lt;/u&gt;\n&lt;/b&gt;&lt;/span&gt;"</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">info</span></span><span class="org-block"> = mailhoover:read_index(</span><span class="builtin"><span class="org-block">print</span></span><span class="org-block">, querystring, maxcount,
                                            mail_colors)
         popup = naughty.notify({
               title = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">,
               text = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(query_format, querystring) .. </span><span class="string"><span class="org-block">"&lt;br&gt;"</span></span><span class="org-block"> ..
                  info,
               timeout = 0,
               hover_timeout = 0.5,
               screen = capi.mouse.screen
         })
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
   mywidget:connect_signal(</span><span class="string"><span class="org-block">'mouse::leave'</span></span><span class="org-block">,
                           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () naughty.destroy(popup) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">mailhoover:read_index</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">print</span></span><span class="org-block">, querystring, maxcount, mail_colors)
    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">info</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">count</span></span><span class="org-block"> = 0

    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'mu find -f "d f s m" -s d -z '</span></span><span class="org-block">..querystring)
    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">out</span></span><span class="org-block"> = f:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
    </span><span class="builtin"><span class="org-block">print</span></span><span class="org-block">(out)
    f:close()

    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">nlines</span></span><span class="org-block"> = 1
    </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">line</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> out:gmatch(</span><span class="string"><span class="org-block">"[^\r\n]+"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
       line = line:gsub(</span><span class="string"><span class="org-block">"&lt;"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"["</span></span><span class="org-block">)
       line = line:gsub(</span><span class="string"><span class="org-block">"&gt;"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"]"</span></span><span class="org-block">)
       line = line:gsub(</span><span class="string"><span class="org-block">"CDT"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
       fold = line:gsub(</span><span class="string"><span class="org-block">".*/([^%s]+)/([^%s]+)$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"%1_%2"</span></span><span class="org-block">)
       col_hex = beautiful.mail_fg_normal
       </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> mail_colors ~= </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">k</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">(mail_colors) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> fold:match(k) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                col_hex = v
                </span><span class="keyword"><span class="org-block">break</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       line = my_utility.html_escape(line)
       info = info .. </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"&lt;span color='"</span></span><span class="org-block"> .. col_hex .. </span><span class="string"><span class="org-block">"'&gt;"</span></span><span class="org-block"> ..
                                       line .. </span><span class="string"><span class="org-block">"&lt;/span&gt;"</span></span><span class="org-block">) .. </span><span class="string"><span class="org-block">'\n'</span></span><span class="org-block">
       nlines = nlines + 1
       </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> nlines == maxcount </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">break</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> info
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> mailhoover
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Widget setup</span>

The vicious module is used to report the number of new messages in a list of
maildir folders.  The color of the widget text changes from
<span class="org-verbatim">=beautiful.mail_fg_normal=</span> to <span class="org-verbatim">=beautiful.mail_fg_urgent=</span> when new messages are
present.

Additionally, a right-click on the widget spawns a small menu with options to
open mail clients (icedove and mu4e).

<span class="org-meta-line">#+NAME: src-main-mail</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Mail widget
</span></span><span class="org-block">mailicon = wibox.widget.textbox()
mailfolders = {
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX/free.fr'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX/gmx.com'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX/ieee.org'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX/iit.edu'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/INBOX/yahoo.fr'</span></span><span class="org-block">,
   awesome_paths.home_dir  .. </span><span class="string"><span class="org-block">'/maildir/status/action'</span></span><span class="org-block">
}
vicious.register(mailicon, vicious.widgets.mdir,
                 </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (widget, args)
                    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">new_messages</span></span><span class="org-block"> = args[1] + args[2]
                    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> new_messages == 0
                    </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'&#9993; 0'</span></span><span class="org-block">)
                    </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'&lt;span color="#dc322f"&gt;&#9993; '</span></span><span class="org-block"> ..
                                                 new_messages ..
                                                 </span><span class="string"><span class="org-block">'&lt;/span&gt; | '</span></span><span class="org-block">)
                    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                 </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, 60, mailfolders)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Mail mouse over
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mailhoover</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"mailhoover"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mail_query</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"maildir:/INBOX* or maildir:/status*"</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mail_colors</span></span><span class="org-block"> = {
   status_waiting_on = beautiful.mail_fg_normal,
   status_action     = beautiful.mail_fg_urgent,
   INBOX             = beautiful.mail_fg_focus,
}
mailhoover:addToWidget(</span><span class="builtin"><span class="org-block">print</span></span><span class="org-block">, mailicon, mail_query, 20, mail_colors)
mailmenu_items = {
   { </span><span class="string"><span class="org-block">"emacs"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () run_or_raise(</span><span class="string"><span class="org-block">"emacs -f mu4e"</span></span><span class="org-block">,
                                       { class = </span><span class="string"><span class="org-block">"Emacs"</span></span><span class="org-block"> }) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> },
   { </span><span class="string"><span class="org-block">"icedove"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () run_or_raise(mail_reader,
                                         { class = </span><span class="string"><span class="org-block">"Icedove"</span></span><span class="org-block"> }) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> }
}
mailmenu = awful.menu.new( { items = mailmenu_items } )
mailbuttons = awful.util.table.join(
   awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () mailmenu:toggle() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
mailicon:buttons(mailbuttons)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> cmus</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus</span>
<span class="org-special-keyword">:END:</span>

Music is controlled by cmus, which is launched on startup.  The original widget
was taken from <span class="org-link"><a href="http://blog.rolinh.ch/linux/un-widget-controleur-pour-le-lecteur-audio-cmus-pour-awesome-wm/">[[http://blog.rolinh.ch/linux/un-widget-controleur-pour-le-lecteur-audio-cmus-pour-awesome-wm/][here]]</a></span>.

The widget has the following features:
1. Show the current play state, song artist, title and current position in the
   wibox widget.
2. Toggle play / pause on click
3. Go to cmus on right click
4. On mouse over events, show a track listing of the current playing album in a
   notification window (popup), with the cover art (parsed from the file
   metadata using eyeD3).
5. A function to search for a given album by name or select an album at random
   and play it in cmus (<span class="org-link"><a href="nil:nil">[[#cmus_play][Quick play command]]</a></span>).  This function is not used by the
   widget but by the <span class="org-link"><a href="nil:nil">[[#global_prompt][global prompt module]]</a></span>.

An example of the widget in action is shown on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-cmus-popup]]</a></span>.

This module is not generic, modifications are likely to be necessary if the
setup is different from mine.  My music library is organized as follows:
- All my music is in <span class="org-verbatim">=~/data/music/=</span> where each album is in a separate folder
  with name <span class="org-verbatim">=YYYY-ARTIST-ALBUM=</span> (the quick play command explicitly assumes this
  format, so it probably won't work with different conventions).  The format is
  set in a regular expression (<span class="org-verbatim">=cmus_album_regex=</span> in the <span class="org-link"><a href="nil:nil">[[#cmus_global_variables][Global variables]]</a></span>
  section).
- Songs all have the cover art in their metadata.  This is where the cover art
  displayed in the popup notification comes from.  There is no clever mechanism
  to pick an image file in the album folder, although it should be possible to
  implement one.
- The extracted cover art is cached in <span class="org-verbatim">=~/cmus_img/=</span>.

This is admittedly pretty constraining, but supporting more generic setups seems
feasible, with some work.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Imports</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

First, import the necessary libraries.

<span class="org-meta-line">#+NAME: module-cmus-import</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'beautiful'</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">util</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.util"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">my_utility</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"my_utility"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">capi</span></span><span class="org-block"> = {
    mouse = mouse,
    screen = screen
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Utility functions</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_utils</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

A few utility functions are used in the module:
- <span class="org-list-dt"><span class="org-verbatim">=scandir=</span></span><span class="org-list-dt"> ::</span> List files in folder (from <span class="org-link"><a href="http://stackoverflow.com/a/11130774">[[http://stackoverflow.com/a/11130774]]</a></span>).
- <span class="org-list-dt"><span class="org-verbatim">=get_path=</span></span><span class="org-list-dt"> ::</span> Extract path from filename.
- <span class="org-list-dt"><span class="org-verbatim">=cmusover_addToWidget=</span></span><span class="org-list-dt"> ::</span> Show album popup on mouse over.
- <span class="org-list-dt"><span class="org-verbatim">=get_mp3_info=</span></span><span class="org-list-dt"> ::</span> Get a string representation of file ID3 tags using eyeD3.  The
  output string is of the form "track number - track title - track length"
  where the track title is padded so that the whole string length is
  <span class="org-verbatim">=strlen=</span> (this does not seem to work with accentuated letters).

<span class="org-meta-line">#+NAME: module-cmus-utils</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Lua implementation of scandir function
</span></span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">scandir</span></span><span class="org-block">(directory, pattern)
    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">popen</span></span><span class="org-block"> = 0, {}, </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">filename</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> popen(</span><span class="string"><span class="org-block">'ls -a "'</span></span><span class="org-block">..directory..</span><span class="string"><span class="org-block">'/"'</span></span><span class="org-block">..pattern):lines() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
        i = i + 1
        t[i] = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(filename, </span><span class="string"><span class="org-block">"//"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block">)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> t
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">get_path</span></span><span class="org-block">(str, sep)
    sep = sep </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> </span><span class="string"><span class="org-block">'/'</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> str:match(</span><span class="string"><span class="org-block">"(.*"</span></span><span class="org-block"> .. sep .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">cmusover_addToWidget</span></span><span class="org-block">(widget)
   widget:connect_signal(
      </span><span class="string"><span class="org-block">'mouse::enter'</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () cmus_popup(0) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
   widget:connect_signal(
      </span><span class="string"><span class="org-block">'mouse::leave'</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () naughty.destroy(popup) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">get_mp3_info</span></span><span class="org-block">(fname, strlen)
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">FIXME: fix padding for accentuated letters.
</span></span><span class="org-block">   cmd = </span><span class="string"><span class="org-block">'eyeD3 --no-color '</span></span><span class="org-block"> .. </span><span class="string"><span class="org-block">'"'</span></span><span class="org-block"> .. fname .. </span><span class="string"><span class="org-block">'"'</span></span><span class="org-block">
   out = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(cmd):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
   track = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(out, </span><span class="string"><span class="org-block">'track: %d*'</span></span><span class="org-block">),
                       </span><span class="string"><span class="org-block">'track: '</span></span><span class="org-block">, </span><span class="string"><span class="org-block">''</span></span><span class="org-block">)
   title = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(out, </span><span class="string"><span class="org-block">'title: %C*'</span></span><span class="org-block">),
                       </span><span class="string"><span class="org-block">'title: '</span></span><span class="org-block">, </span><span class="string"><span class="org-block">''</span></span><span class="org-block">)
   time_str = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(out, </span><span class="string"><span class="org-block">'Time: [%d:]*'</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> time_str == </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      time = </span><span class="string"><span class="org-block">"-"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      time = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(time_str, </span><span class="string"><span class="org-block">'Time: '</span></span><span class="org-block">, </span><span class="string"><span class="org-block">''</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   sfmt = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'%%-%d.%ds'</span></span><span class="org-block">, strlen, strlen)
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">'%2d - '</span></span><span class="org-block">..sfmt..</span><span class="string"><span class="org-block">' - %s'</span></span><span class="org-block">, track, title, time)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Global variables</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_global_variables</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

Setup variables are used to find albums by folder name in the music folder
(using the <span class="org-verbatim">=cmus_album_regex=</span> variable) and to cache the track listing and cover
art.

<span class="org-meta-line">#+NAME: module-cmus-cover-setup</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Album folder regexp
</span></span><span class="org-block">cmus_album_regex = </span><span class="string"><span class="org-block">"^[0-9]\\{4\\}-"</span></span><span class="org-block">

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Album display (with cover)
</span></span><span class="org-block">cmus_file_g = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
cmus_img_g = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
cmus_img_fold = </span><span class="builtin"><span class="org-block">os</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">getenv</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"HOME"</span></span><span class="org-block">) .. </span><span class="string"><span class="org-block">"/cmus_img/"</span></span><span class="org-block">
cmus_album_g = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
cmus_album_list_g = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
cmus_file_list_g = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Check running instance</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_pid</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

This function detects whether a cmus instance is running by requesting its PID.

<span class="org-meta-line">#+NAME: module-cmus-get-pid</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Get cmus PID to check if it is running
</span></span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">getCmusPid</span></span><span class="org-block">()
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">fpid</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"pgrep cmus"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">pid</span></span><span class="org-block"> = fpid:read(</span><span class="string"><span class="org-block">"*n"</span></span><span class="org-block">)
   fpid:close()
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> pid
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Controls</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

A cmus instance can be controlled from a terminal using the <span class="org-verbatim">=cmus-remote=</span>
command.  The following function passes simple controls to cmus-remote (play,
pause, stop, next, etc.).  In practice only the play / pause functionality is
used: clicking on the widget toggles the play state (play / pause).


<span class="org-meta-line">#+NAME: module-cmus-control</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Enable cmus control
</span></span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">cmus_control</span></span><span class="org-block"> (action)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">cmus_info</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">cmus_state</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">cmus_run</span></span><span class="org-block"> = getCmusPid()
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_run </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      cmus_info = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -Q"</span></span><span class="org-block">):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> cmus_info </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      cmus_state = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info, </span><span class="string"><span class="org-block">"status %a*"</span></span><span class="org-block">),
                               </span><span class="string"><span class="org-block">"status "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_state ~= </span><span class="string"><span class="org-block">"stopped"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"next"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -n"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"previous"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -r"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"stop"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -s"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"play_pause"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"playing"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"paused"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -u"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"stopped"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -p"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Popup</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_popup</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

The popup notification (Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-cmus-popup]]</a></span>) shows the content of the
global variables defined earlier (see <span class="org-link"><a href="nil:nil">[[#cmus_global_variables][global variables]]</a></span>) and updated by the
<span class="org-verbatim">=cmus_hook=</span> function (see the <span class="org-link"><a href="nil:nil">[[#cmus_hook][Main hook]]</a></span> section).

<span class="org-meta-line">#+NAME: module-cmus-popup</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">cmus_popup</span></span><span class="org-block">(timeout)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">img</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(cmus_img_g) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      img = cmus_img_g
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      img = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_album_list_g ~= </span><span class="string"><span class="org-block">""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      popup = naughty.notify({
            title = cmus_album_g,
            text = cmus_album_list_g,
            font = </span><span class="string"><span class="org-block">"monospace 10"</span></span><span class="org-block">,
            icon = img,
            icon_size = 192,
            timeout = timeout,
            hover_timeout = 0.5,
            screen = capi.mouse.screen
      })
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>
The following bash script, uses <span class="org-verbatim">=awesome-client=</span> to spawn the popup notification
and performs a screen capture (Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-cmus-popup]]</a></span>).

<span class="org-meta-line">#+NAME: sh-scrot-cmus-info</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports code :tangle no :cache yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Could get these from xrandr
</span></span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block">=1920
</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block">=1080
</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block">=1 </span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">starts at 0
</span></span><span class="org-block">
</span><span class="builtin"><span class="org-block">echo</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"local cmus = require(\"cmus\"); cmus_popup(5)"</span></span><span class="org-block"> | awesome-client

</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">=$(( 3 * $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> / 8 ))
</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">=250
</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> * $</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block"> + $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> - $</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block"> ))

sleep 0.5

scrot desktop.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">}+0 desktop-cmus-popup.png
rm desktop.png -rf
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS[6A446875DD481892F7F83D0F7947D490669A2857]: sh-scrot-cmus-info</span>

<span class="org-meta-line">#+NAME: img-cmus-popup</span>
<span class="org-meta-line">#+ATTR_HTML: :width 60%</span>
<span class="org-meta-line">#+CAPTION:</span> <span class="org-block">Cmus popup notification, with album cover and track list.
</span><span class="org-link"><a href="file:../images/2016-10-05-Awesome-wm_configuration/desktop-cmus-popup.png">[[file:../images/2016-10-05-Awesome-wm_configuration/desktop-cmus-popup.png]]</a></span>


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Quick play command</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_play</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

The quick play command <span class="org-verbatim">=cmus_play=</span> is used to start playing a new album, picked
randomly (<span class="org-verbatim">=rand=</span> mode) or from a string (<span class="org-verbatim">=album=</span> mode).  There is no single song
mode; it could probably be added, but I use a direct search and mplayer to play
individual songs via the <span class="org-link"><a href="nil:nil">[[#global_prompt_music][global prompt module]]</a></span>.

Once the folder to play is found, some work is required to get cmus to play it.
First, cmus must be in playlist mode (i.e. the <span class="org-verbatim">=play_library=</span> flag must of set
to false).  <span class="org-verbatim">=cmus-remote=</span> is used to interrogate the running instance and then a
second time to disable the <span class="org-verbatim">=play_library=</span> mode if necessary.  Then, the current
playlist is cleared (<span class="org-verbatim">=cmus-remote -c=</span>), the desired folder is added to the
playlist and playback is started.  A combination of stop, next and play commands
seems to be the best way to get the playlist to start.

The commands are written into a temporary bash script, which is executed at the
end of the function (I was not able to get this to work without the intermediate
bash script).

<span class="org-meta-line">#+NAME: module-cmus-play</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">cmus_play</span></span><span class="org-block">(mode, fold)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">out</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> mode == </span><span class="string"><span class="org-block">"rand"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      alb_sel_cmd = </span><span class="string"><span class="org-block">"ls "</span></span><span class="org-block"> .. global_prompt.music_folder .. </span><span class="string"><span class="org-block">" | "</span></span><span class="org-block"> ..
         </span><span class="string"><span class="org-block">"grep \""</span></span><span class="org-block"> .. cmus_album_regex .. </span><span class="string"><span class="org-block">"\" | sort -R | head -n1"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> mode == </span><span class="string"><span class="org-block">"album"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      alb_sel_cmd = </span><span class="string"><span class="org-block">"ls "</span></span><span class="org-block"> .. global_prompt.music_folder .. </span><span class="string"><span class="org-block">" | "</span></span><span class="org-block"> ..
         </span><span class="string"><span class="org-block">"grep \""</span></span><span class="org-block"> .. cmus_album_regex .. </span><span class="string"><span class="org-block">"\" | grep -i \""</span></span><span class="org-block"> .. fold .. </span><span class="string"><span class="org-block">"\" |"</span></span><span class="org-block"> ..
         </span><span class="string"><span class="org-block">"tail -n1"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(alb_sel_cmd)
   out = f:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">):gsub(</span><span class="string"><span class="org-block">"\n$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
   f:close()

   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Determine if play_library flag need to be toggled
</span></span><span class="org-block">   f = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -Q | grep play_library | awk '{print $3}'"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">lib_flag</span></span><span class="org-block"> = f:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">):gsub(</span><span class="string"><span class="org-block">"\n$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
   f:close()

   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> lib_flag == </span><span class="string"><span class="org-block">"true"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      mp_cmds = { </span><span class="string"><span class="org-block">"cmus-remote -C \"toggle play_library\""</span></span><span class="org-block"> }
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      mp_cmds = {}
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">table.insert(mp_cmds, "cmus-remote --stop")
</span></span><span class="org-block">   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(mp_cmds, </span><span class="string"><span class="org-block">"cmus-remote -P -c \""</span></span><span class="org-block"> ..
                   global_prompt.music_folder .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> ..
                   out .. </span><span class="string"><span class="org-block">"\""</span></span><span class="org-block">)
   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(mp_cmds, </span><span class="string"><span class="org-block">"cmus-remote -C \"view playlist\""</span></span><span class="org-block">)
   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(mp_cmds, </span><span class="string"><span class="org-block">"cmus-remote --stop"</span></span><span class="org-block">)
   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(mp_cmds, </span><span class="string"><span class="org-block">"cmus-remote --next"</span></span><span class="org-block">)
   </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(mp_cmds, </span><span class="string"><span class="org-block">"cmus-remote --play"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> mp_cmds </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">file</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">flag_batch</span></span><span class="org-block"> = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block"> </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">problems when not using this
</span></span><span class="org-block">      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> flag_batch </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         file = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">open</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"/tmp/cmus.sh"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"w"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">cmd</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(mp_cmds) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> flag_batch </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            <a href="file:write">file:write</a>(cmd .. </span><span class="string"><span class="org-block">"\nsleep 1\n"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            awful.util.spawn_with_shell(cmd)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> flag_batch </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         <a href="file:close">file:close</a>()
         awful.util.spawn_with_shell(</span><span class="string"><span class="org-block">"bash /tmp/cmus.sh"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Main hook</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">cmus_hook</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle cmus.lua</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=cmus_hook=</span> function is responsible for updating the text of the music
widget, and the content of the popup notification.  It is run on a frequent
timer (2 seconds by default).

The hook first checks for the presence of a running cmus instance using the
<span class="org-link"><a href="nil:nil">[[#cmus_pid][=getCmusPid=]]</a></span> function.  If a running instance is found and its status is
currently "playing" or "paused", the hook proceeds to extract information about
the currently playing file.  As shown in Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop]]</a></span>, the widget
shows the playing status with a unicode character (play / pause), the artist and
song title and the track position (formatted as "position" / "duration").

The rest of the function populates the album track list.  <span class="org-verbatim">=cmus_album_str=</span>
contains the album name and the year between parentheses.  If the album name is
different from the one cached in the <span class="org-link"><a href="nil:nil">[[#cmus_global_variables][global variable]]</a></span> <span class="org-verbatim">=cmus_album_g=</span>, the track
list is updated.

To update the track list, the cover art is first extracted from the current
playing file using the eyeD3 utility.  This requires all audio files to contain
the album art as metadata.  The extracted cover art is saved in the folder
defined by the <span class="org-verbatim">=cmus_img_fold=</span> variable.

Further, all the <span class="org-verbatim">=.mp3=</span> files in the same folder as the file being played are
listed, their metadata is extracted using the <span class="org-link"><a href="nil:nil">[[#cmus_utils][=get_mp3_info=]]</a></span> function, and they
are added to the <span class="org-verbatim">=cmus_album_list_g=</span> variable.  The song currently playing is
highlighted in the list.

<span class="org-meta-line">#+NAME: module-cmus-hook</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">cmus_hook</span></span><span class="org-block">()
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">check if cmus is running
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">cmus_run</span></span><span class="org-block"> = getCmusPid()
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_run </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      cmus_info = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus-remote -Q"</span></span><span class="org-block">):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> cmus_info </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"."</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      cmus_status = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info, </span><span class="string"><span class="org-block">"status %a*"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_status == </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"."</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      cmus_state = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(cmus_status,</span><span class="string"><span class="org-block">"status "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"playing"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"paused"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         cmus_artist = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(
                                      cmus_info, </span><span class="string"><span class="org-block">"tag artist %C*"</span></span><span class="org-block">),
                                   </span><span class="string"><span class="org-block">"tag artist "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_title = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info,
                                               </span><span class="string"><span class="org-block">"tag title %C*"</span></span><span class="org-block">),
                                  </span><span class="string"><span class="org-block">"tag title "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_album = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info,
                                               </span><span class="string"><span class="org-block">"tag album %C*"</span></span><span class="org-block">),
                                  </span><span class="string"><span class="org-block">"tag album "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_year = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info,
                                              </span><span class="string"><span class="org-block">"tag date %C*"</span></span><span class="org-block">),
                                 </span><span class="string"><span class="org-block">"tag date "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_curtime = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info,
                                                 </span><span class="string"><span class="org-block">"position %d*"</span></span><span class="org-block">),
                                    </span><span class="string"><span class="org-block">"position "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_curtime_formated = </span><span class="builtin"><span class="org-block">math</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">floor</span></span><span class="org-block">(cmus_curtime/60) .. </span><span class="string"><span class="org-block">':'</span></span><span class="org-block"> ..
            </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"%02d"</span></span><span class="org-block">,cmus_curtime % 60)
         cmus_totaltime = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info,
                                                   </span><span class="string"><span class="org-block">"duration %d*"</span></span><span class="org-block">),
                                      </span><span class="string"><span class="org-block">"duration "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         cmus_totaltime_formated = </span><span class="builtin"><span class="org-block">math</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">floor</span></span><span class="org-block">(cmus_totaltime/60) .. </span><span class="string"><span class="org-block">':'</span></span><span class="org-block"> ..
            </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"%02d"</span></span><span class="org-block">,cmus_totaltime % 60)
         cmus_album_str = cmus_album .. </span><span class="string"><span class="org-block">" ("</span></span><span class="org-block"> .. cmus_year .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_artist == </span><span class="string"><span class="org-block">""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            cmus_artist = </span><span class="string"><span class="org-block">"unknown artist"</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_title == </span><span class="string"><span class="org-block">""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            cmus_title = </span><span class="string"><span class="org-block">"unknown title"</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">cmus_title = string.format("%.5c", cmus_title)
</span></span><span class="org-block">         cmus_string = cmus_artist .. </span><span class="string"><span class="org-block">" - "</span></span><span class="org-block"> .. cmus_title .. </span><span class="string"><span class="org-block">" ("</span></span><span class="org-block"> ..
            cmus_curtime_formated .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. cmus_totaltime_formated .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_state == </span><span class="string"><span class="org-block">"paused"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            cmus_string = </span><span class="string"><span class="org-block">'&#9208; '</span></span><span class="org-block"> .. cmus_string .. </span><span class="string"><span class="org-block">''</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            cmus_string = </span><span class="string"><span class="org-block">'&#9204; '</span></span><span class="org-block"> .. cmus_string .. </span><span class="string"><span class="org-block">''</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         cmus_file = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_info, </span><span class="string"><span class="org-block">"file %C*"</span></span><span class="org-block">),
                                 </span><span class="string"><span class="org-block">"file "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_album_str ~= cmus_album_g </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            cmd = </span><span class="string"><span class="org-block">"rm "</span></span><span class="org-block"> .. cmus_img_fold .. </span><span class="string"><span class="org-block">"/*; "</span></span><span class="org-block"> ..
               </span><span class="string"><span class="org-block">"eyeD3 --no-color --write-images="</span></span><span class="org-block"> .. cmus_img_fold .. </span><span class="string"><span class="org-block">"/ "</span></span><span class="org-block"> ..
               </span><span class="string"><span class="org-block">"\"$(cmus-remote -Q|grep \"^file\"|"</span></span><span class="org-block"> ..
               </span><span class="string"><span class="org-block">"awk '{$1=\"\";print $0}'| "</span></span><span class="org-block"> ..
               </span><span class="string"><span class="org-block">"sed -r 's/^\\s*//g')\""</span></span><span class="org-block">
            cmus_img_dump = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(cmd .. </span><span class="string"><span class="org-block">" 2&gt;&amp;1"</span></span><span class="org-block">):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_img_dump, </span><span class="string"><span class="org-block">'file not found'</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">fname</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">(cmus_img_dump, </span><span class="string"><span class="org-block">"Writing %C*"</span></span><span class="org-block">)
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> fname ~= </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  cmus_img_g = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(
                     </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(fname, </span><span class="string"><span class="org-block">"Writing "</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">), </span><span class="string"><span class="org-block">"...$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            cmus_album_g = cmus_album_str
            cmus_file_list_g = scandir(get_path(cmus_file), </span><span class="string"><span class="org-block">'*.mp3'</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmus_file_g ~= cmus_file </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            cmus_file_g = cmus_file
            cmus_album_list_g = </span><span class="string"><span class="org-block">''</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">k</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">f</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">(cmus_file_list_g) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">file_info</span></span><span class="org-block"> = get_mp3_info(f, 35)
               file_info = my_utility.html_escape(file_info)
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> f == cmus_file </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  file_info = </span><span class="string"><span class="org-block">"&lt;span color='"</span></span><span class="org-block"> .. beautiful.cmus_fg ..
                     </span><span class="string"><span class="org-block">"'&gt;&lt;b&gt;"</span></span><span class="org-block"> .. file_info .. </span><span class="string"><span class="org-block">"&lt;/b&gt;&lt;/span&gt;"</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
               cmus_album_list_g = cmus_album_list_g .. file_info .. </span><span class="string"><span class="org-block">'\n'</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
         cmus_string = </span><span class="string"><span class="org-block">'-- not playing --'</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> cmus_string
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">'-- not running --'</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> cmus module usage</span>

In the main <span class="org-verbatim">=rc.lua=</span> file, we create the widget, connect it to the <span class="org-verbatim">=cmus_hook=</span>
function with a timer object (updated every 2 seconds), add the popup
notification to mouse over events and setup the click actions.

<span class="org-meta-line">#+NAME: src-main-cmus</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ cmus
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Cmus Widget
</span></span><span class="org-block">tb_cmus = wibox.widget.textbox()
tb_cmus:set_text(</span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">refresh Cmus widget
</span></span><span class="org-block">cmus_timer = timer({timeout = 2})
cmus_timer:connect_signal(
   </span><span class="string"><span class="org-block">"timeout"</span></span><span class="org-block">,
   </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
      tb_cmus:set_text(</span><span class="string"><span class="org-block">'&#9834; '</span></span><span class="org-block"> .. cmus_hook() .. </span><span class="string"><span class="org-block">' '</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
cmus_timer:start()
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">pause on click
</span></span><span class="org-block">cmusbuttons = awful.util.table.join(
   awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() cmus_control(</span><span class="string"><span class="org-block">"play_pause"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() run_or_raise(termapps ..
                                                   </span><span class="string"><span class="org-block">" -c cmus -e cmus"</span></span><span class="org-block">,
                                                { instance=</span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block">} ) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
tb_cmus:buttons(cmusbuttons)
cmusover_addToWidget(tb_cmus)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Tiny Tiny RSS</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">ttrss</span>
<span class="org-special-keyword">:END:</span>

The RSS widget relies on an instance of Tiny Tiny RSS and the <span class="org-link"><a href="https://github.com/Vassius/ttrss-python">[[https://github.com/Vassius/ttrss-python][ttrss python
package]]</a></span>.  Extraction of RSS entries is performed using the following python
wrapper script.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Python wrapper script</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">ttrss-wrapper-py</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle scripts/ttrss-wrapper.py</span>
<span class="org-special-keyword">:END:</span>

The python wrapper script is a simple interface to the ttrss python package.  It
requires the following packages (besides <span class="org-verbatim">=ttrss-python=</span>):
- <span class="org-list-dt"><span class="org-verbatim">=argparse=</span></span><span class="org-list-dt"> ::</span> command-line arguments parser,
- <span class="org-list-dt"><span class="org-verbatim">=keyring=</span></span><span class="org-list-dt"> ::</span> extract credentials from keyring,
- <span class="org-list-dt"><span class="org-verbatim">=textwrap=</span></span><span class="org-list-dt"> ::</span> wraps output string within fixed width paragraph.

<span class="org-meta-line">#+NAME: script-ttrss-py</span>
<span class="org-block-begin-line">#+BEGIN_SRC python :mkdirp yes :results silent
</span><span class="string"><span class="org-block">"""
Get unread feeds from tt-rss site

"""</span></span><span class="org-block">

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Imports</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> ttrss.client
</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> keyring
</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> argparse
</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> textwrap

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Parse options</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">__name__</span></span><span class="org-block"> == </span><span class="string"><span class="org-block">'__main__'</span></span><span class="org-block">:
    </span><span class="variable-name"><span class="org-block">parser</span></span><span class="org-block"> = argparse.ArgumentParser(description=</span><span class="string"><span class="org-block">'Get tt-rss feeds.'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-U'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--url'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'url'</span></span><span class="org-block">, required=</span><span class="constant"><span class="org-block">True</span></span><span class="org-block">,
                        </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">=</span><span class="builtin"><span class="org-block">str</span></span><span class="org-block">, </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'TinyTiny RSS URL'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-u'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--user'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'user'</span></span><span class="org-block">, required=</span><span class="constant"><span class="org-block">True</span></span><span class="org-block">,
                        </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">=</span><span class="builtin"><span class="org-block">str</span></span><span class="org-block">, </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'Username'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-p'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--pass'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'passwd'</span></span><span class="org-block">, required=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">,
                        </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">=</span><span class="builtin"><span class="org-block">str</span></span><span class="org-block">, </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'Password'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-W'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--width'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'text_width'</span></span><span class="org-block">, default=50,
                        required=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">, </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">=</span><span class="builtin"><span class="org-block">int</span></span><span class="org-block">, </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'Width of text output'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-c'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--count'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'flag_count'</span></span><span class="org-block">, action=</span><span class="string"><span class="org-block">'store_true'</span></span><span class="org-block">,
                        required=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">,
                        </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'Output only the number of unread items'</span></span><span class="org-block">)
    parser.add_argument(</span><span class="string"><span class="org-block">'-r'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'--mark-read'</span></span><span class="org-block">, dest=</span><span class="string"><span class="org-block">'flag_mark_read'</span></span><span class="org-block">,
                        action=</span><span class="string"><span class="org-block">'store_true'</span></span><span class="org-block">, required=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">,
                        </span><span class="builtin"><span class="org-block">help</span></span><span class="org-block">=</span><span class="string"><span class="org-block">'Mark all unread items as read'</span></span><span class="org-block">)
    </span><span class="variable-name"><span class="org-block">args</span></span><span class="org-block"> = parser.parse_args()
</span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">:
    </span><span class="keyword"><span class="org-block">from</span></span><span class="org-block"> collections </span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> namedtuple
    </span><span class="variable-name"><span class="org-block">Args</span></span><span class="org-block"> = namedtuple(</span><span class="string"><span class="org-block">'arg'</span></span><span class="org-block">, [</span><span class="string"><span class="org-block">'user'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'passwd'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'url'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'text_width'</span></span><span class="org-block">,
                              </span><span class="string"><span class="org-block">'flag_count'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'flag_mark_read'</span></span><span class="org-block">])
    </span><span class="variable-name"><span class="org-block">args</span></span><span class="org-block"> = Args(user=</span><span class="string"><span class="org-block">''</span></span><span class="org-block">, url=</span><span class="string"><span class="org-block">''</span></span><span class="org-block">, text_width=50,
                flag_count=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">, flag_mark_read=</span><span class="constant"><span class="org-block">False</span></span><span class="org-block">, passwd=</span><span class="constant"><span class="org-block">None</span></span><span class="org-block">)

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Get password</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> args.passwd:
    </span><span class="variable-name"><span class="org-block">args.passwd</span></span><span class="org-block"> = keyring.get_password(</span><span class="string"><span class="org-block">'tt-rss'</span></span><span class="org-block">, args.user)

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Create connection</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">

</span><span class="variable-name"><span class="org-block">client</span></span><span class="org-block"> = ttrss.client.TTRClient(args.url, args.user, args.passwd,
                                auto_login=</span><span class="constant"><span class="org-block">True</span></span><span class="org-block">, http_auth=())
client.login()


</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Get unread feeds</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">

</span><span class="variable-name"><span class="org-block">hl</span></span><span class="org-block"> = client.get_headlines(view_mode=</span><span class="string"><span class="org-block">'unread'</span></span><span class="org-block">)


</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Render output</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> args.flag_count:
    </span><span class="keyword"><span class="org-block">print</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">len</span></span><span class="org-block">(hl))
</span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">:
    </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> hh </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> hl:
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> args.flag_mark_read:
            client.mark_read(hh.</span><span class="builtin"><span class="org-block">id</span></span><span class="org-block">)
        </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">:
            </span><span class="keyword"><span class="org-block">print</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block">.join([
                (</span><span class="string"><span class="org-block">"- "</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> ii == 0 </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"  "</span></span><span class="org-block">) + tt
                </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> ii, tt </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">enumerate</span></span><span class="org-block">(
                        textwrap.wrap(hh.title,
                                      args.text_width))
            ]))

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Cleanup</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">

client.logout()
</span><span class="org-block-end-line">#+END_SRC
</span>
The script takes as parameters the URL to the Tiny Tiny RSS instance, a user
name and a password.  It gathers unread feeds and prints them into a string.  It
also adds the option to get the credentials from the keyring
(e.g. <span class="org-verbatim">=gnome-keyring=</span> or <span class="org-verbatim">=KWallet=</span>).  This functionality requires the <span class="org-verbatim">=keyring=</span>
python package.

Here is the help text for the <span class="org-verbatim">=ttrss-wrapper.py=</span> script:

<span class="org-meta-line">#+NAME: sh-ttrss-py-usage</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports both :tangle no :results verbatim
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Use " || echo " to ensure a success code is returned
</span></span><span class="org-block">python3 scripts/ttrss-wrapper.py --help || </span><span class="builtin"><span class="org-block">echo</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS: sh-ttrss-py-usage</span>
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="ATTRLIST">usage: ttrss-wrapper.py [-h] -U URL -u USER [-p PASSWD] [-W TEXT_WIDTH] [-c]
                        [-r]

Get tt-rss feeds.

optional arguments:
  -h, --help            show this help message and exit
  -U URL, --url URL     TinyTiny RSS URL
  -u USER, --user USER  Username
  -p PASSWD, --pass PASSWD
                        Password
  -W TEXT_WIDTH, --width TEXT_WIDTH
                        Width of text output
  -c, --count           Output only the number of unread items
  -r, --mark-read       Mark all unread items as read
</span><span class="org-block-end-line">#+END_EXAMPLE
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Credentials</span>

In my setup, credentials are stored in the <span class="org-verbatim">=~/.authinfo.gpg=</span> file.  The
following emacs-lisp snippet defines a function to get the username and password
from the url.  This should also work for the un-encrypted version using
<span class="org-verbatim">=.authinfo=</span>.

If not using authinfo, the credentials can be hard-coded in this emacs-lisp
snippet.  In the following source block, replace line<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[(user-nil)]]</a></span> by
line<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[(user-hardcoded)]]</a></span> and line<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[(pass-nil)]]</a></span> by
line<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[(pass-hardcoded)]]</a></span> and set the correct password.

<span class="org-meta-line">#+NAME: ttrss-credentials</span>
<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp -n -r :tangle no :results silent :exports code
</span><span class="org-block">(</span><span class="keyword"><span class="org-block">defun</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">get-ttrss-cred</span></span><span class="org-block"> (</span><span class="type"><span class="org-block">&amp;optional</span></span><span class="org-block"> url)
  (</span><span class="keyword"><span class="org-block">let</span></span><span class="org-block"> ((ttrss-url (</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> url url </span><span class="string"><span class="org-block">"127.0.0.1:81/tt-rss"</span></span><span class="org-block">))
        (ttrss-user nil)                                         (ref:user-nil)
        </span><span class="comment-delimiter"><span class="org-block">;;</span></span><span class="comment"><span class="org-block">(ttrss-user "myuser")                            (ref:user-hardcoded)
</span></span><span class="org-block">        (ttrss-pass nil)                                         (ref:pass-nil)
        </span><span class="comment-delimiter"><span class="org-block">;;</span></span><span class="comment"><span class="org-block">(ttrss-pass "mypassword")                        (ref:pass-hardcoded)
</span></span><span class="org-block">        )
    (</span><span class="keyword"><span class="org-block">when</span></span><span class="org-block"> (</span><span class="keyword"><span class="org-block">require</span></span><span class="org-block"> '</span><span class="constant"><span class="org-block">auth-source</span></span><span class="org-block">)
      (</span><span class="keyword"><span class="org-block">let</span></span><span class="org-block"> ((auth (nth 0 (auth-source-search </span><span class="builtin"><span class="org-block">:host</span></span><span class="org-block"> ttrss-url
                                             </span><span class="builtin"><span class="org-block">:requires</span></span><span class="org-block"> '(user secret)))))
        (</span><span class="keyword"><span class="org-block">when</span></span><span class="org-block"> (and (plist-get auth </span><span class="builtin"><span class="org-block">:secret</span></span><span class="org-block">) (plist-get auth </span><span class="builtin"><span class="org-block">:user</span></span><span class="org-block">))
          (setq ttrss-pass (funcall (plist-get auth </span><span class="builtin"><span class="org-block">:secret</span></span><span class="org-block">))
                ttrss-user (plist-get auth </span><span class="builtin"><span class="org-block">:user</span></span><span class="org-block">))
          )
        )
      )
    `(,ttrss-url ,ttrss-user ,ttrss-pass)
    )
  )
</span><span class="org-block-end-line">#+END_SRC
</span>
Note that this approach saves the credentials unencrypted in the <span class="org-verbatim">=ttrss.lua=</span>
module.  It may be preferable to rely on a keyring to get the password.
However, the <span class="org-verbatim">=authinfo=</span> approach can still be safely used with version control
if the org file is version-controlled and the tangled lua files are not.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> tt-rss module</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle ttrss.lua</span>
<span class="org-special-keyword">:END:</span>

The tt-rss module defines functions used by the <span class="org-link"><a href="nil:nil">[[#ttrss-widget][widget]]</a></span>:
- <span class="org-list-dt"><span class="org-verbatim">=ttrss_get_count=</span></span><span class="org-list-dt"> ::</span> return the number of unread feeds,
- <span class="org-list-dt"><span class="org-verbatim">=ttrss_get_feeds=</span></span><span class="org-list-dt"> ::</span> return a formatted list of unread feeds,
- <span class="org-list-dt"><span class="org-verbatim">=ttrss_mark_read=</span></span><span class="org-list-dt"> ::</span> mark all feeds as read,
- <span class="org-list-dt"><span class="org-verbatim">=ttrss_set_mouseover=</span></span><span class="org-list-dt"> ::</span> setup the widget to display a popup notification with
  the list of unread feeds on mouse-over.

These functions internally use the <span class="org-verbatim">=ttrss_get=</span> function which interacts with the
<span class="org-link"><a href="nil:nil">[[#ttrss-wrapper-py][=ttrss-wrapper.py=]]</a></span> python script.

<span class="org-meta-line">#+NAME: module-ttrss</span>
<span class="org-meta-line">#+HEADER: :var ttrss_cred=(get-ttrss-cred "127.0.0.1:81/tt-rss")</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Script options
</span></span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss_cmd</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"python3 "</span></span><span class="org-block"> .. awesome_paths.config_dir ..
   </span><span class="string"><span class="org-block">"/scripts/ttrss-wrapper.py "</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss_url</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"<a href="http://">http://</a>"</span></span><span class="org-block"> .. ttrss_cred[1]
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss_user</span></span><span class="org-block"> = ttrss_cred[2]
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss_pass</span></span><span class="org-block"> = ttrss_cred[3]
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ttrss_textwidth</span></span><span class="org-block"> = 100

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">capi</span></span><span class="org-block"> = {
    mouse = mouse,
    screen = screen
}

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">ttrss_get_count</span></span><span class="org-block">()
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> ttrss_get(</span><span class="string"><span class="org-block">"count"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">ttrss_get_feeds</span></span><span class="org-block">()
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> ttrss_get(</span><span class="string"><span class="org-block">"feeds"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">ttrss_mark_read</span></span><span class="org-block">()
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> ttrss_get(</span><span class="string"><span class="org-block">"mark_read"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">ttrss_get</span></span><span class="org-block">(action)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"feeds"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      args = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"count"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      args = </span><span class="string"><span class="org-block">"-c"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> action == </span><span class="string"><span class="org-block">"mark_read"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      args = </span><span class="string"><span class="org-block">"-r"</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   cmd = ttrss_cmd .. </span><span class="string"><span class="org-block">" -U "</span></span><span class="org-block"> .. ttrss_url .. </span><span class="string"><span class="org-block">" -u "</span></span><span class="org-block"> .. ttrss_user ..
      </span><span class="string"><span class="org-block">" -p "</span></span><span class="org-block"> .. ttrss_pass .. </span><span class="string"><span class="org-block">" -W "</span></span><span class="org-block"> .. ttrss_textwidth .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> .. args
   ttrss_info = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(cmd):read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> ttrss_info
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">ttrss_set_mouseover</span></span><span class="org-block">(mywidget)
   mywidget:connect_signal(</span><span class="string"><span class="org-block">'mouse::enter'</span></span><span class="org-block">,
                           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                              </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">info</span></span><span class="org-block"> = ttrss_get_feeds()
                              </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> info ~= </span><span class="string"><span class="org-block">""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                                 popup = naughty.notify({
                                       title = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">,
                                       text = info,
                                       timeout = 0,
                                       hover_timeout = 0.5,
                                       screen = capi.mouse.screen})
                              </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
   mywidget:connect_signal(</span><span class="string"><span class="org-block">'mouse::leave'</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                              naughty.destroy(popup) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> tt-rss widget</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">ttrss-widget</span>
<span class="org-special-keyword">:END:</span>

The ttrss widget is a textbox with the text updated on a timer (every 10 minutes
by default) to display the number of unread items.  On a mouse over event, a
list of unread feeds is shown in a popup notification.  Finally, click actions
are added to the widget:
- a left click shows a menu with entries "Refresh" and "Mark as read" which
  respectively refresh the widget count and mark all unread items as read,
- a right click spawns a menu with shortcuts to the terminal and GUI RSS
  applications newsbeuter and liferea.

<span class="org-meta-line">#+NAME: src-main-ttrss</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ tt-rss
</span></span><span class="org-block">tb_ttrss = wibox.widget.textbox()
tb_ttrss:set_text(</span><span class="string"><span class="org-block">"ttrss"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">refresh
</span></span><span class="org-block">ttrss_timer = timer({timeout = 600})
ttrss_timer:connect_signal(</span><span class="string"><span class="org-block">"timeout"</span></span><span class="org-block">,
                           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                              tb_ttrss:set_text(</span><span class="string"><span class="org-block">'&#9749; '</span></span><span class="org-block"> .. ttrss_get_count()) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
ttrss_timer:start()
tb_ttrss:set_text(</span><span class="string"><span class="org-block">'&#9749; '</span></span><span class="org-block"> .. ttrss_get_count())
ttrssmenu_l_items = {
   { </span><span class="string"><span class="org-block">"Refresh"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () tb_ttrss:set_text(</span><span class="string"><span class="org-block">'&#9749; '</span></span><span class="org-block"> .. ttrss_get_count()) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> },
   { </span><span class="string"><span class="org-block">"Mark as read"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
        ttrss_mark_read()
        tb_ttrss:set_text(</span><span class="string"><span class="org-block">'&#9749; '</span></span><span class="org-block"> .. ttrss_get_count())
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> }
}
ttrssmenu_r_items = {
   { </span><span class="string"><span class="org-block">"newsbeuter"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () run_or_raise(
           termapps .. </span><span class="string"><span class="org-block">" -c newsbeuter -e newsbeuter"</span></span><span class="org-block">,
           { instance=</span><span class="string"><span class="org-block">"newsbeuter"</span></span><span class="org-block">} ) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> },
   { </span><span class="string"><span class="org-block">"liferea"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () run_or_raise(
           </span><span class="string"><span class="org-block">"liferea"</span></span><span class="org-block">, { class = </span><span class="string"><span class="org-block">"Liferea"</span></span><span class="org-block"> }) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> }
}
ttrssmenu_l = awful.menu.new( { items = ttrssmenu_l_items } )
ttrssmenu_r = awful.menu.new( { items = ttrssmenu_r_items } )
ttrss_buttons = awful.util.table.join(
   awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () ttrssmenu_l:toggle() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () ttrssmenu_r:toggle() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
tb_ttrss:buttons(ttrss_buttons)
ttrss_set_mouseover(tb_ttrss)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Effects </span><span class="org-checkbox-statistics-done">[3/3]</span>

This section contains setup of visual effects that can be used with awesome-wm.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Monitor highlighting</span>

It is sometimes difficult to tell which monitor is the active one, so I
implemented a simple hook to highlight the wibox on the active screen.  The
actual colors are defined through the <span class="org-link"><a href="nil:nil">[[#theme][theme manager]]</a></span>.

<span class="org-meta-line">#+NAME: src-effects-monitor-highlight</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Highlight current monitor
</span></span><span class="org-block">screen_highlight_timer = timer({timeout = 0.2})
screen_highlight_idx = 1
screen_highlight_timer:connect_signal(
   </span><span class="string"><span class="org-block">"timeout"</span></span><span class="org-block">,
   </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> mouse.screen ~= screen_highlight_idx </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         screen_highlight_idx = mouse.screen
         </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s == mouse.screen </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               col_bg = beautiful.screen_highlight_bg_active
               col_fg = beautiful.screen_highlight_fg_active
            </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
               col_bg = beautiful.screen_highlight_bg_inactive
               col_fg = beautiful.screen_highlight_fg_inactive
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            mywibox[s]:set_bg(col_bg)
            mywibox[s]:set_fg(col_fg)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
screen_highlight_timer:start()
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Transparency</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">effects_transparency</span>
<span class="org-special-keyword">:header-args:</span> <span class="org-property-value">:tangle no</span>
<span class="org-special-keyword">:END:</span>

If using a compositor (e.g. <span class="org-verbatim">=xcompmgr=</span>), effects can be applied on windows.
This block makes windows transparent when losing focus, and opaque when
regaining focus.  Note that this block is disabled by default (see the
<span class="org-verbatim">=:PROPERTY:=</span> drawer).

<span class="org-meta-line">#+NAME: src-effects-transparency</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Transparency
</span></span><span class="org-block">client.connect_signal(</span><span class="string"><span class="org-block">"focus"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(c)
                         c.border_color = beautiful.border_focus
                         c.opacity = 1
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
client.connect_signal(</span><span class="string"><span class="org-block">"unfocus"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(c)
                         c.border_color = beautiful.border_normal
                         c.opacity = 0.9
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Window border change on focus</span>

Add a signal to change the color of window borders when losing / receiving
focus.  This comes from the default configuration.

<span class="org-meta-line">#+NAME: src-effects-border</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Window border
</span></span><span class="org-block">client.connect_signal(</span><span class="string"><span class="org-block">"focus"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(c)
                         c.border_color = beautiful.border_focus
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
client.connect_signal(</span><span class="string"><span class="org-block">"unfocus"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(c)
                         c.border_color = beautiful.border_normal
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Bindings </span><span class="org-checkbox-statistics-done">[56/56]</span>

Bindings include mouse click actions for the different widgets and windows as
well as keyboard shortcuts.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Mouse</span>

Mouse bindings are defined using tables filled by <span class="org-verbatim">=awful.button=</span> elements.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> General bindings</span>

This section handles mouse actions on an empty workspace:
- a right-click pops-up the <span class="org-link"><a href="nil:nil">[[#main_menu][main menu]]</a></span>,
- the mouse wheel moves to the previous / next tag.

<span class="org-meta-line">#+NAME: src-bindings-mouse-root</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Mouse bindings
</span></span><span class="org-block">root.buttons(awful.util.table.join(
    awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () mymainmenu:toggle() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.button({ }, 4, awful.tag.viewprev),
    awful.button({ }, 5, awful.tag.viewnext)
))
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Windows</span>

Mouse actions for clicks on windows are defined here:
- a left click sets the focus,
- <span class="org-verbatim">=modkey=</span> + left click drag moves the window,
- <span class="org-verbatim">=modkey=</span> + right click drag resizes the window.
The <span class="org-verbatim">=clientbuttons=</span> table created by this block is later added to each window
via the <span class="org-link"><a href="nil:nil">[[#rules][rules]]</a></span> mechanism.

<span class="org-meta-line">#+NAME: src-bindings-mouse-client</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Focus, move, resize window on click
</span></span><span class="org-block">clientbuttons = awful.util.table.join(
    awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c) client.focus = c; c:raise() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.button({ modkey }, 1, awful.mouse.client.move),
    awful.button({ modkey }, 3, awful.mouse.client.resize))

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Tag list</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">bindings_mouse_taglist</span>
<span class="org-special-keyword">:END:</span>

The mouse can be used to navigate between between tags, when the mouse is over
the tag list widget:
- a left click on a tag icon moves to the corresponding tag,
- <span class="org-verbatim">=modkey=</span> + left click moves the current window to the desired tag,
- a right click toggles the visibility of the corresponding tag (on top of the
  current tag, so all windows from the tag under the mouse will appear in the
  currently active tag),
- <span class="org-verbatim">=modkey=</span> + right click toggles the current tag's visibility on the tag under
  the mouse,
- the mouse wheel goes to the previous / next tag.

<span class="org-meta-line">#+NAME: src-bindings-mouse-taglist</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
mytaglist.buttons = awful.util.table.join(
   awful.button({ }, 1, awful.tag.viewonly),
   awful.button({ modkey }, 1, awful.client.movetotag),
   awful.button({ }, 3, awful.tag.viewtoggle),
   awful.button({ modkey }, 3, awful.client.toggletag),
   awful.button({ }, 4, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(t)
         awful.tag.viewprev(awful.tag.getscreen(t)) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 5, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(t)
         awful.tag.viewnext(awful.tag.getscreen(t)) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Task list</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">bindings_mouse_tasklist</span>
<span class="org-special-keyword">:END:</span>

Task list mouse actions are the following:
- a left click toggles window minimization,
- a right click spawns a menu listing the open windows (on all screens and
  tags),
- the mouse wheel cycles through windows in the current screen and tag.

<span class="org-meta-line">#+NAME: src-bindings-mouse-tasklist</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
mytasklist.buttons = awful.util.table.join(
   awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c == client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            c.minimized = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Without this, the following
</span></span><span class="org-block">            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">:isvisible() makes no sense
</span></span><span class="org-block">            c.minimized = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c:isvisible() </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               awful.tag.viewonly(c:tags()[1])
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">This will also un-minimize
</span></span><span class="org-block">            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">the client, if needed
</span></span><span class="org-block">            client.focus = c
            c:raise()
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> instance </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            instance:hide()
            instance = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            instance = awful.menu.clients({
                  theme = { width = 250 }
            })
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 4, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         awful.client.focus.byidx(1)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> client.focus:raise() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.button({ }, 5, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         awful.client.focus.byidx(-1)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> client.focus:raise() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">))
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Keyboard</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">bindings_keyboard</span>
<span class="org-special-keyword">:END:</span>

Keyboard bindings are split into two categories: global bindings and client
(windows) bindings.

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Global bindings </span><span class="org-checkbox-statistics-done">[39/39]</span>

Keybindings are defined in subsections, and can be individually disabled by
setting the <span class="org-verbatim">=tangle=</span> property to <span class="org-verbatim">=no=</span>.

First, we initialize the table for the keys.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-start</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Key bindings
</span></span><span class="org-block">globalkeys = {}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Tags</span>

This section defines tag navigation keybindings and window movement between
tags.


<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Previous/next tag with </span><span class="org-verbatim"><span class="org-level-5">=modkey=</span></span>

Move the the previous / next tag:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-prevnext</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"Left"</span></span><span class="org-block">,  awful.tag.viewprev ),
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"Right"</span></span><span class="org-block">, awful.tag.viewnext )
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Previous/next tag on all screens with </span><span class="org-verbatim"><span class="org-level-5">=Ctrl=</span></span><span class="org-level-5"> + </span><span class="org-verbatim"><span class="org-level-5">=Alt=</span></span>

Move to the previous / next tag (using <span class="org-verbatim">=Ctrl=</span> + <span class="org-verbatim">=Alt=</span> as on other desktop
environments) on all screens:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-prevnext-ctrl_alt</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ altkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Left"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen_cur</span></span><span class="org-block"> = mouse.screen
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_orig</span></span><span class="org-block"> = awful.tag.selected(screen_cur)
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_prev</span></span><span class="org-block"> = awful.tag.getidx(tag_orig)
          tag_prev = tag_prev - 1
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag_prev == 0 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             tag_prev = #awful.tag.gettags(screen_cur)
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[tag_prev]
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                awful.tag.viewonly(tag)
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ altkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Right"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen_cur</span></span><span class="org-block"> = mouse.screen
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_orig</span></span><span class="org-block"> = awful.tag.selected(screen_cur)
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_next</span></span><span class="org-block"> = awful.tag.getidx(tag_orig)
          tag_next = tag_next + 1
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag_next &gt; #awful.tag.gettags(screen_cur) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             tag_next = 1
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[tag_next]
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                awful.tag.viewonly(tag)
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Move window to previous/next with </span><span class="org-verbatim"><span class="org-level-5">=Ctrl=</span></span><span class="org-level-5"> + </span><span class="org-verbatim"><span class="org-level-5">=Alt=</span></span><span class="org-level-5"> + </span><span class="org-verbatim"><span class="org-level-5">=Shift=</span></span>

Move the current window to the previous / next tag:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-move-prevnext</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
   awful.key({ altkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Left"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen_cur</span></span><span class="org-block"> = mouse.screen
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_orig</span></span><span class="org-block"> = awful.tag.selected(screen_cur)
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_prev</span></span><span class="org-block"> = awful.tag.getidx(tag_orig)
          tag_prev = tag_prev - 1
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag_prev == 0 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             tag_prev = #awful.tag.gettags(screen_cur)
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(screen_cur)[tag_prev]
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                awful.client.movetotag(tag)
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

          </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s ~= screen_cur </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[tag_prev]
                </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                   awful.tag.viewonly(tag)
                </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tags[screen_cur][tag_prev] </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             awful.tag.viewonly(tags[screen_cur][tag_prev])
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ altkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Right"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen_cur</span></span><span class="org-block"> = mouse.screen
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_orig</span></span><span class="org-block"> = awful.tag.selected(screen_cur)
          </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag_next</span></span><span class="org-block"> = awful.tag.getidx(tag_orig)
          tag_next = tag_next + 1
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag_next &gt; #awful.tag.gettags(screen_cur) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             tag_next = 1
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(screen_cur)[tag_next]
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                awful.client.movetotag(tag)
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

          </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s ~= screen_cur </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[tag_next]
                </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                   awful.tag.viewonly(tag)
                </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tags[screen_cur][tag_next] </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
             awful.tag.viewonly(tags[screen_cur][tag_next])
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Go to tag number</span>

Bind numbers to tags (with <span class="org-verbatim">=modkey=</span>):

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Bind all key numbers to tags.
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Be careful: we use keycodes to make it works on any keyboard layout.
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">This should map on the top row of your keyboard, usually 1 to 9.
</span></span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">View tag only.
</span></span><span class="org-block">        awful.key({ modkey }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
                  </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen</span></span><span class="org-block"> = mouse.screen
                        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(screen)[i]
                        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                           awful.tag.viewonly(tag)
                        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Go to tag number on all screens with </span><span class="org-verbatim"><span class="org-level-5">=Ctrl=</span></span><span class="org-level-5"> + </span><span class="org-verbatim"><span class="org-level-5">=Alt=</span></span>

Alternative binding to go to a tag by number on all screens with <span class="org-verbatim">=Ctrl=</span> + <span class="org-verbatim">=Alt=</span>:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num-ctrl_alt</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">View tag for all screens.
</span></span><span class="org-block">        awful.key({ altkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
                  </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                        </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
                              </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[i]
                              </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                                 awful.tag.viewonly(tag)
                              </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Change tag on other screen</span>

Move the other screen to a specific tag number (assumes two screens) using
<span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=Alt=</span> and a tag number:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num-other</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">View tag for other screen.
</span></span><span class="org-block">        awful.key({ modkey, altkey }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
                  </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                     </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen_cur</span></span><span class="org-block"> = mouse.screen
                     </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
                        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s ~= screen_cur </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                           </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(s)[i]
                           </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                              awful.tag.viewonly(tag)
                           </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Move window to tag</span>

Move the current client (window) to tag by number:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num-move</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Move client to tag.
</span></span><span class="org-block">        awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
              </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                 </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(
                    client.focus.screen)[i]
                 </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                    awful.client.movetotag(tag)
                 </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
              </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Select tag</span>

Activate other tag on the current one:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num-select-from</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">

</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Toggle tag.
</span></span><span class="org-block">        awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
                  </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">screen</span></span><span class="org-block"> = mouse.screen
                      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(screen)[i]
                      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                         awful.tag.viewtoggle(tag)
                      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Show current tag on other tag</span>

Activate current tag on another one:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-num-select-to</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">i</span></span><span class="org-block"> = 1, 9 </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    globalkeys = awful.util.table.join(globalkeys,
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Toggle tag.
</span></span><span class="org-block">        awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"#"</span></span><span class="org-block"> .. i + 9,
           </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
              </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                 </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">tag</span></span><span class="org-block"> = awful.tag.gettags(client.focus.screen)[i]
                 </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> tag </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                    awful.client.toggletag(tag)
                 </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
              </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Go to other screen</span>

Move to previous / next screen with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=Ctrl=</span> + <span class="org-verbatim">=j=</span> / <span class="org-verbatim">=k=</span>:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-screen</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"j"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.screen.focus_relative( 1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"k"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.screen.focus_relative(-1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Go to other screen (alternative)</span>

Use <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=Ctrl=</span> + (<span class="org-verbatim">=Shift=</span>) <span class="org-verbatim">=TAB=</span>:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-tags-screen-tab</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Tab"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.screen.focus_relative( 1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Tab"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.screen.focus_relative(-1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Clients (windows)</span>

This section contains keybindings to operate on clients (windows).

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Go to previous / next window</span>

Move to the previous / next window on the current screen using <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=j=</span> /
<span class="org-verbatim">=k=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-clients-prevnext</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Clients
</span></span><span class="org-block">    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"j"</span></span><span class="org-block">,
        </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
            awful.client.focus.byidx( 1)
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> client.focus:raise() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"k"</span></span><span class="org-block">,
        </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
            awful.client.focus.byidx(-1)
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> client.focus:raise() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Jump to last window</span>

Go to the tag with the last focused window:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-clients-last</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"Escape"</span></span><span class="org-block">, awful.tag.history.restore)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Jump to urgent window</span>

Jump to window with urgent flag:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-clients-urgent</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"u"</span></span><span class="org-block">, awful.client.urgent.jumpto)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Browse window history</span>

Loop through window history on the current tag and screen (like <span class="org-verbatim">=Alt=</span> + <span class="org-verbatim">=TAB=</span>):

<span class="org-meta-line">#+NAME: src-bindings-keyboard-clients-history</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"Tab"</span></span><span class="org-block">,
        </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
            awful.client.focus.history.previous()
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> client.focus </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                client.focus:raise()
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Restore window</span>

Restore minimized window:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-clients-restore</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"n"</span></span><span class="org-block">, awful.client.restore)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Layout</span>

This sections contains keybindings related to layout manipulations.


<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Move window within layout</span>

Swap window with previous / next in current layout using <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=shift=</span> +
<span class="org-verbatim">=j=</span> / <span class="org-verbatim">=k=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-layout-move</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Layout manipulation
</span></span><span class="org-block">   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"j"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.client.swap.byidx(  1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"k"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.client.swap.byidx( -1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Resize layout</span>

Control client size within layout:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-layout-resize</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey,           }, </span><span class="string"><span class="org-block">"l"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incmwfact( 0.05) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey,           }, </span><span class="string"><span class="org-block">"h"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incmwfact(-0.05) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block">   }, </span><span class="string"><span class="org-block">"h"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incnmaster( 1)   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block">   }, </span><span class="string"><span class="org-block">"l"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incnmaster(-1)   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"h"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incncol( 1)      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"l"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.tag.incncol(-1)      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Change layout</span>

Cycle through available layouts using <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=space=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-layout-change</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey,         }, </span><span class="string"><span class="org-block">"space"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts,  1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"space"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts, -1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Application shortcuts</span>

Keybindings for frequently used <span class="org-link"><a href="nil:nil">[[#default_programs][applications]]</a></span>.


<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Toggle main menu</span>

Toggle <span class="org-link"><a href="nil:nil">[[#main_menu][main menu]]</a></span>:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-mainmenu</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"w"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () mymainmenu:show() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Terminal</span>

Open a terminal with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=return=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-terminal</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, }, </span><span class="string"><span class="org-block">"Return"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.util.spawn(terminal) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Internet browser</span>

Start the web browser with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=ctrl=</span> + <span class="org-verbatim">=return=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-web</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Return"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.util.spawn(internet_browser) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Conkeror</span>

Start conkeror, an alternative web browser using <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=ctrl=</span> + <span class="org-verbatim">=shift=</span> +
<span class="org-verbatim">=return=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-conkeror</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Return"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.util.spawn(</span><span class="string"><span class="org-block">"conkeror"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Emacs</span>

Start emacs with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=shift=</span> + <span class="org-verbatim">=return=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-emacs</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Return"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.util.spawn(emacs) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> File explorer</span>

Start the file explorer software with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=e=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-explorer</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(
   globalkeys,
   awful.key({ modkey, }, </span><span class="string"><span class="org-block">"e"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.util.spawn_with_shell(explorer .. </span><span class="string"><span class="org-block">" ~"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Awesome restart</span>

Restart awesome-wm (reload <span class="org-verbatim">=rc.lua=</span>) with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=ctrl=</span> + <span class="org-verbatim">=r=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-restart</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"r"</span></span><span class="org-block">, awesome.restart)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Logout</span>

Log out with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=shift=</span> + <span class="org-verbatim">=q=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-applications-logout</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"q"</span></span><span class="org-block">, awesome.quit)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Prompts</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">keybindings_prompts</span>
<span class="org-special-keyword">:END:</span>

This section contains keybindings for prompts.


<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Shell execution</span>

Execute arbitrary shell commands with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=r=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-prompts-exec</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Prompt
</span></span><span class="org-block">    awful.key({ modkey }, </span><span class="string"><span class="org-block">"r"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
          awful.prompt.run(
             { prompt = </span><span class="string"><span class="org-block">"Exec: "</span></span><span class="org-block"> },
             mypromptbox[mouse.screen].widget,
             awful.util.spawn,
             awful.completion.shell,
             awful.util.getdir(</span><span class="string"><span class="org-block">"cache"</span></span><span class="org-block">) .. </span><span class="string"><span class="org-block">"/history_eval"</span></span><span class="org-block">,
             50,
             </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
          </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Lua execution</span>

Execute lua code with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=x=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-prompts-lua</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey }, </span><span class="string"><span class="org-block">"x"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
          awful.prompt.run({ prompt = </span><span class="string"><span class="org-block">"Run Lua code: "</span></span><span class="org-block"> },
             mypromptbox[mouse.screen].widget,
             awful.util.eval, </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">,
             awful.util.getdir(</span><span class="string"><span class="org-block">"cache"</span></span><span class="org-block">) .. </span><span class="string"><span class="org-block">"/history_eval"</span></span><span class="org-block">,
             50,
             </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          )
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-5">***** </span><span class="org-done">DONE</span><span class="org-level-5"> Global prompt</span>

Toggle the custom <span class="org-link"><a href="nil:nil">[[#global_prompt][global prompt]]</a></span> with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=z=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-prompts-global</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey }, </span><span class="string"><span class="org-block">"z"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
          awful.prompt.run({ prompt = </span><span class="string"><span class="org-block">"&#9658; "</span></span><span class="org-block"> },
             mypromptbox[mouse.screen].widget,
             global_prompt.run, global_prompt.comp,
             awful.util.getdir(</span><span class="string"><span class="org-block">"cache"</span></span><span class="org-block">) .. </span><span class="string"><span class="org-block">"/history_global"</span></span><span class="org-block">,
             50,
             </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
                mywibox_prompt[mouse.screen].visible = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
             </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
          )
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Menubar</span>

Start the menubar with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=a=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-menubar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Menubar
</span></span><span class="org-block">globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey }, </span><span class="string"><span class="org-block">"a"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">() menubar.show() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Volume control</span>

Use special keyboard keys to control the audio volume:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-volume</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Volume
</span></span><span class="org-block">globalkeys = awful.util.table.join(globalkeys,
    awful.key({ }, </span><span class="string"><span class="org-block">"XF86AudioRaiseVolume"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          awful.util.spawn(awesome_paths.config_dir ..
                           </span><span class="string"><span class="org-block">"/scripts/osdvol.sh volup"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ }, </span><span class="string"><span class="org-block">"XF86AudioLowerVolume"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          awful.util.spawn(awesome_paths.config_dir ..
                           </span><span class="string"><span class="org-block">"/scripts/osdvol.sh voldown"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
    awful.key({ }, </span><span class="string"><span class="org-block">"XF86AudioMute"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          awful.util.spawn(awesome_paths.config_dir ..
                           </span><span class="string"><span class="org-block">"/scripts/osdvol.sh mute"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Screen lock</span>

Lock the screen using <span class="org-verbatim">=xscreensaver=</span> with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=ctrl=</span> + <span class="org-verbatim">=l=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-lock</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Screen lock
</span></span><span class="org-block">globalkeys = awful.util.table.join(globalkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"l"</span></span><span class="org-block">,
       </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
          awful.util.spawn(</span><span class="string"><span class="org-block">"xscreensaver-command -lock"</span></span><span class="org-block">)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Register keybindings</span>

Register the keybindings defined in the <span class="org-verbatim">=globalkeys=</span> table:

<span class="org-meta-line">#+NAME: src-bindings-keyboard-register</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Set keys
</span></span><span class="org-block">root.keys(globalkeys)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Client bindings</span>

The keybindings defined in this section control individual windows.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = {}
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Fullscreen</span>

Get the current window in fullscreen with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=f=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-fullscreen</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(
   clientkeys,
   awful.key({ modkey, }, </span><span class="string"><span class="org-block">"f"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c) c.fullscreen = </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.fullscreen  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Kill window</span>

Kill current window with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=shift=</span> + <span class="org-verbatim">=c=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-kill</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Shift"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"c"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c) c:kill() </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Toggle floating window mode</span>

Set window to floating mode (does not use layout) with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=ctrl=</span> +
<span class="org-verbatim">=space=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-floating</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"space"</span></span><span class="org-block">, awful.client.floating.toggle )
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Move window to master position</span>

Swap window with window in the current layout's master position with <span class="org-verbatim">=modkey=</span> +
<span class="org-verbatim">=ctrl=</span> + <span class="org-verbatim">=return=</span>.  Note that this is currently overridden by the web browser
shortcut.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-swap-master</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(
   clientkeys,
   awful.key({ modkey, </span><span class="string"><span class="org-block">"Control"</span></span><span class="org-block"> }, </span><span class="string"><span class="org-block">"Return"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c) c:swap(awful.client.getmaster()) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Move window to other screen</span>

Send current window to other screen with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=o=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-other-screen</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"o"</span></span><span class="org-block">, awful.client.movetoscreen )
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Toggle on-top property</span>

Toggle on-top flag (useful for floating windows) with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=t=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-ontop</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"t"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c) c.ontop = </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.ontop </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Minimize window</span>

Minimize the current window with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=n=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-minimize</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey, }, </span><span class="string"><span class="org-block">"n"</span></span><span class="org-block">,
        </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c)
            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">The client currently has the input focus, so it cannot be
</span></span><span class="org-block">            </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">minimized, since minimized clients can't have the focus.
</span></span><span class="org-block">            c.minimized = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Toggle maximized mode</span>

Toggle maximize property for the current window with <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=m=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-maximize</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey,           }, </span><span class="string"><span class="org-block">"m"</span></span><span class="org-block">,
        </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c)
            c.maximized_horizontal = </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.maximized_horizontal
            c.maximized_vertical   = </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.maximized_vertical
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Show window information</span>

Show a popup notification with information on the current window (class,
properties, etc.).  Triggered by pressing <span class="org-verbatim">=modkey=</span> + <span class="org-verbatim">=i=</span>.

<span class="org-meta-line">#+NAME: src-bindings-keyboard-client-info</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
clientkeys = awful.util.table.join(clientkeys,
    awful.key({ modkey,           }, </span><span class="string"><span class="org-block">"i"</span></span><span class="org-block">,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c)
        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">geom</span></span><span class="org-block"> = c:geometry()
        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">

        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.class </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Class: "</span></span><span class="org-block"> .. c.class .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.instance </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Instance: "</span></span><span class="org-block"> .. c.instance .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.role </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Role: "</span></span><span class="org-block"> .. c.role .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.name </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Name: "</span></span><span class="org-block"> .. c.name .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.type </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Type: "</span></span><span class="org-block"> .. c.type .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.fullscreen </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Fullscreen; yes\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.maximized_horizontal </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Maximized Horizontal: yes\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.maximized_vertical </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Maximized Vertical: yes\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c.above </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> t = t .. </span><span class="string"><span class="org-block">"Above: yes\n"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> geom.width </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> geom.height </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> geom.x </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> geom.y </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
           t = t .. </span><span class="string"><span class="org-block">"Dimensions: "</span></span><span class="org-block"> .. </span><span class="string"><span class="org-block">"x:"</span></span><span class="org-block"> .. geom.x .. </span><span class="string"><span class="org-block">" y:"</span></span><span class="org-block"> .. geom.y ..
              </span><span class="string"><span class="org-block">" w:"</span></span><span class="org-block"> .. geom.width .. </span><span class="string"><span class="org-block">" h:"</span></span><span class="org-block"> .. geom.height
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

        naughty.notify({
          text = t,
          timeout = 5,
        })
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
)

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Wibox </span><span class="org-checkbox-statistics-done">[21/21]</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">wibox</span>
<span class="org-special-keyword">:END:</span>

The wibox is the top bar shown on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop-main]]</a></span>.  It is populated
with widgets previously set up, including the <span class="org-link"><a href="nil:nil">[[#main_menu][main menu]]</a></span>, <span class="org-link"><a href="nil:nil">[[#tags][tag list]]</a></span>, task list and
the custom <span class="org-link"><a href="nil:nil">[[#cmus][music]]</a></span> / <span class="org-link"><a href="nil:nil">[[#email][email]]</a></span> / <span class="org-link"><a href="nil:nil">[[#ttrss][news]]</a></span> widgets.

A wibox is created on each screen; the only difference between the screens is
that only a single instance of the system tray widget can be added (it is added
on screen 1 for my configuration).

<span class="org-meta-line">#+NAME: src-wibox-start-loop</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{ Wibox
</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a wibox for each screen and add it
</span></span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>
In the following sections, <span class="org-verbatim">=s=</span> is the current screen index.


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Main prompt box</span>

The prompts defined in the <span class="org-link"><a href="nil:nil">[[#keybindings_prompts][key bindings section]]</a></span> toggle the visibility of a text
widget on the wibox for user input.  This text widget is defined here:

<span class="org-meta-line">#+NAME: src-wibox-prompt</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a promptbox for each screen
</span></span><span class="org-block">    mypromptbox[s] = awful.widget.prompt()
    mypromptbox[s].font = </span><span class="string"><span class="org-block">"Consolas 18"</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Wibox</span>

This section defines the main wibox, which can be seen at the top in
Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-desktop-main]]</a></span>.  It contains all the widgets and is defined as
follows:

<span class="org-meta-line">#+NAME: src-wibox-wibox</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create the wibox
</span></span><span class="org-block">    mywibox[s] = awful.wibox({ position = </span><span class="string"><span class="org-block">"top"</span></span><span class="org-block">, screen = s })
</span><span class="org-block-end-line">#+END_SRC
</span>


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Combine widgets</span>

The wibox is decomposed into three sections: left, center and right.  Widgets
are added to each section and then concatenated into a single layout which is in
turn added to the wibox.

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Left layout</span>

The <span class="org-verbatim">=left_layout=</span> contains the left-side widgets:

<span class="org-meta-line">#+NAME: src-wibox-left-start</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Widgets that are aligned to the left
</span></span><span class="org-block">    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">left_layout</span></span><span class="org-block"> = wibox.layout.fixed.horizontal()
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Confirmation prompt</span>

Several actions in this configuration use a <span class="org-link"><a href="nil:nil">[[#my_utility_confirm][confirmation prompt]]</a></span>.  This is done
via a common <span class="org-verbatim">=awful.widget.prompt=</span> object.  This prompt is visible only when
used.

<span class="org-meta-line">#+NAME: src-wibox-left-prompt_conf</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    mypromptbox_conf[s] = awful.widget.prompt()
    mywibox_prompt[s] = awful.wibox({ position = </span><span class="string"><span class="org-block">"bottom"</span></span><span class="org-block">, screen = s,
                                      font = </span><span class="string"><span class="org-block">"Consolas 18"</span></span><span class="org-block"> })
    mywibox_prompt[s].visible = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
    mywibox_prompt[s]:set_widget(mypromptbox[s])
    left_layout:add(mypromptbox_conf[s])
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Main menu</span>

The main menu defined <span class="org-link"><a href="nil:nil">[[#main_menu][earlier]]</a></span> is added at the beginning (left-most position) of
the wibox.

<span class="org-meta-line">#+NAME: src-wibox-launcher</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    left_layout:add(mylauncher)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Tag list</span>

The following creates a visual tag list, setting the mouse bindings defined in
the <span class="org-link"><a href="nil:nil">[[#bindings_mouse_taglist][mouse bindings section]]</a></span>.

<span class="org-meta-line">#+NAME: src-wibox-taglist</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a taglist widget
</span></span><span class="org-block">    mytaglist[s] = awful.widget.taglist(s, awful.widget.taglist.filter.all,
                                        mytaglist.buttons)
    left_layout:add(mytaglist[s])
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Launchbar</span>

Add the <span class="org-link"><a href="nil:nil">[[#launchbar][launchbar]]</a></span> widgets, which includes launchers (with icons) to selected
programs.

<span class="org-meta-line">#+NAME: src-wibox-launchbar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    left_layout:add(mylaunchbar)
</span><span class="org-block-end-line">#+END_SRC
</span>


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Right layout</span>

First, create the layout container:

<span class="org-meta-line">#+NAME: src-wibox-right-start</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Widgets that are aligned to the right
</span></span><span class="org-block">    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">right_layout</span></span><span class="org-block"> = wibox.layout.fixed.horizontal()
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> cmus widget</span>

Add the widget created to interact with <span class="org-link"><a href="nil:nil">[[#cmus][cmus]]</a></span>.

<span class="org-meta-line">#+NAME: src-wibox-cmus</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(tb_cmus)
    right_layout:add(separator)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Email widget</span>

Add the <span class="org-link"><a href="nil:nil">[[#email][email widget]]</a></span> to the wibox.

<span class="org-meta-line">#+NAME: src-wibox-email</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(mailicon)
    right_layout:add(separator)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> News widget</span>

Add the <span class="org-link"><a href="nil:nil">[[#ttrss][tt-rss]]</a></span> widget to the wibox.

<span class="org-meta-line">#+NAME: src-wibox-ttrss</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(tb_ttrss)
    right_layout:add(separator)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Memory widget</span>

Add the <span class="org-link"><a href="nil:nil">[[#memory][memory widget]]</a></span> to the wibox: combine the text and graph widgets.

<span class="org-meta-line">#+NAME: src-wibox-memory</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(memory_label)
    right_layout:add(memory_graph)
    right_layout:add(separator)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Volume widget</span>

Add the <span class="org-link"><a href="nil:nil">[[#volume][volume widget]]</a></span> (text and graph) to the wibox.

<span class="org-meta-line">#+NAME: src-wibox-volume</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(volume_text)
    right_layout:add(volume_master)
    right_layout:add(separator)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> System tray</span>

Add the system tray widget to the first screen.

<span class="org-meta-line">#+NAME: src-wibox-systray</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> s == 1 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block"> right_layout:add(wibox.widget.systray()) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Layout widget</span>

The following creates an icon indicating the current layout, and able to cycle
over enabled layouts with left / right clicks or the mouse wheel.

<span class="org-meta-line">#+NAME: src-wibox-layout</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create an imagebox widget which will contains an icon indicating which
</span></span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">layout we're using.
</span></span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">We need one layoutbox per screen.
</span></span><span class="org-block">    mylayoutbox[s] = awful.widget.layoutbox(s)
    mylayoutbox[s]:buttons(
       awful.util.table.join(
          awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts, 1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
          awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts, -1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
          awful.button({ }, 4, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts, 1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
          awful.button({ }, 5, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> () awful.layout.inc(layouts, -1) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)))
    right_layout:add(mylayoutbox[s])
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Calendar widget</span>

Add the <span class="org-link"><a href="nil:nil">[[#calendar][calendar widget]]</a></span> to the wibox.

<span class="org-meta-line">#+NAME: src-wibox-calendar</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(calendar)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Leave menu</span>

Add a <span class="org-link"><a href="nil:nil">[[#shutdown][leave menu]]</a></span> to the wibox.

<span class="org-meta-line">#+NAME: src-wibox-leave</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    right_layout:add(myleave_launcher)
</span><span class="org-block-end-line">#+END_SRC
</span>


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Task list</span>

The following creates a visual task list, setting the mouse bindings defined in
the <span class="org-link"><a href="nil:nil">[[#bindings_mouse_tasklist][mouse bindings section]]</a></span>.

<span class="org-meta-line">#+NAME: src-wibox-tasklist</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Create a tasklist widget
</span></span><span class="org-block">    mytasklist[s] = awful.widget.tasklist(
       s, awful.widget.tasklist.filter.currenttags, mytasklist.buttons)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> Combine layouts</span>

Combine the <span class="org-verbatim">=left_layout=</span>, <span class="org-verbatim">=right_layout=</span> and the task list into a single layout
for the main wibox.

<span class="org-meta-line">#+NAME: src-wibox-layout-lcr</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Now bring it all together (with the tasklist in the middle)
</span></span><span class="org-block">    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">layout</span></span><span class="org-block"> = wibox.layout.align.horizontal()
    layout:set_left(left_layout)
    layout:set_middle(mytasklist[s])
    layout:set_right(right_layout)

    mywibox[s]:set_widget(layout)
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Close screen for loop</span>

This code block closes the <span class="org-link"><a href="nil:nil">[[src-wibox-start-loop][for loop]]</a></span> creating a wibox on each screen.

<span class="org-meta-line">#+NAME: src-wibox-end-loop</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Rules</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">rules</span>
<span class="org-special-keyword">:END:</span>

Awesome allows the definition of rules for program window management based on
their class or instance name.  If the link is still up, <span class="org-link"><a href="https://awesome.naquadah.org/wiki/Understanding_Rules">[[https://awesome.naquadah.org/wiki/Understanding_Rules][this page]]</a></span> contains some
basic description of rules.

Only a few simple rules are defined here:
- Set of few programs as "floating": mplayer, pinentry, gimp.
- Fix cmus, newsbeuter on the second tag of the second screen.
- Icedove goes on the first tag of the second screen.
- I had issues with <span class="org-verbatim">=ristretto=</span> starting in a maximized state; I am not sure
  whether it is necessary, but I am explicitly disabling the "maximized" option
  here.

<span class="org-meta-line">#+NAME: src-rules</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Rules
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Rules to apply to new clients (through the "manage" signal).
</span></span><span class="org-block">awful.rules.rules = {
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">All clients will match this rule.
</span></span><span class="org-block">    { rule = { },
      properties = { border_width = beautiful.border_width,
                     border_color = beautiful.border_normal,
                     focus = awful.client.focus.filter,
                     raise = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">,
                     keys = clientkeys,
                     buttons = clientbuttons } },
    { rule = { class = </span><span class="string"><span class="org-block">"MPlayer"</span></span><span class="org-block"> },
      properties = { floating = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block"> } },
    { rule = { class = </span><span class="string"><span class="org-block">"pinentry"</span></span><span class="org-block"> },
      properties = { floating = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block"> } },
    { rule = { class = </span><span class="string"><span class="org-block">"gimp"</span></span><span class="org-block"> },
      properties = { floating = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block"> } },
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Set Firefox to always map on tags number 2 of screen 1.
</span></span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{ rule = { class = "Firefox" },
</span></span><span class="org-block">    </span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">properties = { tag = tags[1][2] } },
</span></span><span class="org-block">    { rule = { instance = </span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block"> },
      properties = { tag = tags[2][2] } },
    { rule = { instance = </span><span class="string"><span class="org-block">"tmplayer"</span></span><span class="org-block"> },
      properties = { tag = tags[2][2] } },
    { rule = { instance = </span><span class="string"><span class="org-block">"newsbeuter"</span></span><span class="org-block"> },
      properties = { tag = tags[2][2] } },
    { rule = { class = </span><span class="string"><span class="org-block">"Icedove"</span></span><span class="org-block"> },
      properties = { tag = tags[2][1] } },
    { rule = { instance = </span><span class="string"><span class="org-block">"plugin-container"</span></span><span class="org-block"> },
      properties = { floating = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block"> } },
    { rule = { instance = </span><span class="string"><span class="org-block">"ristretto"</span></span><span class="org-block"> },
      properties = { maximized = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block"> } },
}
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Signals</span>

This is default code setting up focus following the mouse, titlebars (which are
disabled) and border coloring.

<span class="org-meta-line">#+NAME: src-signals</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">{{{ Signals
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Signal function to execute when a new client appears.
</span></span><span class="org-block">client.connect_signal(</span><span class="string"><span class="org-block">"manage"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (c, startup)
    </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Enable sloppy focus
</span></span><span class="org-block">    c:connect_signal(</span><span class="string"><span class="org-block">"mouse::enter"</span></span><span class="org-block">, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(c)
        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> awful.layout.get(c.screen) ~= awful.layout.suit.magnifier
            </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> awful.client.focus.filter(c) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            client.focus = c
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)

    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> startup </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Set the windows at the slave,
</span></span><span class="org-block">        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">i.e. put it at the end of others instead of setting it master.
</span></span><span class="org-block">        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">awful.client.setslave(c)
</span></span><span class="org-block">
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Put windows in a smart way, only if they does not set an initial position.
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.size_hints.user_position </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.size_hints.program_position </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            awful.placement.no_overlap(c)
            awful.placement.no_offscreen(c)
        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.size_hints.user_position </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> c.size_hints.program_position </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Prevent clients from being unreachable after screen count change
</span></span><span class="org-block">        awful.placement.no_offscreen(c)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

    </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">titlebars_enabled</span></span><span class="org-block"> = </span><span class="constant"><span class="org-block">false</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> titlebars_enabled </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> (c.type == </span><span class="string"><span class="org-block">"normal"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> c.type == </span><span class="string"><span class="org-block">"dialog"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">buttons for the titlebar
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">buttons</span></span><span class="org-block"> = awful.util.table.join(
                awful.button({ }, 1, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
                    client.focus = c
                    c:raise()
                    awful.mouse.client.move(c)
                </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">),
                awful.button({ }, 3, </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
                    client.focus = c
                    c:raise()
                    awful.mouse.client.resize(c)
                </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)
                )

        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Widgets that are aligned to the left
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">left_layout</span></span><span class="org-block"> = wibox.layout.fixed.horizontal()
        left_layout:add(awful.titlebar.widget.iconwidget(c))
        left_layout:buttons(buttons)

        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Widgets that are aligned to the right
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">right_layout</span></span><span class="org-block"> = wibox.layout.fixed.horizontal()
        right_layout:add(awful.titlebar.widget.floatingbutton(c))
        right_layout:add(awful.titlebar.widget.maximizedbutton(c))
        right_layout:add(awful.titlebar.widget.stickybutton(c))
        right_layout:add(awful.titlebar.widget.ontopbutton(c))
        right_layout:add(awful.titlebar.widget.closebutton(c))

        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">The title goes in the middle
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">middle_layout</span></span><span class="org-block"> = wibox.layout.flex.horizontal()
        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">title</span></span><span class="org-block"> = awful.titlebar.widget.titlewidget(c)
        title:set_align(</span><span class="string"><span class="org-block">"center"</span></span><span class="org-block">)
        middle_layout:add(title)
        middle_layout:buttons(buttons)

        </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Now bring it all together
</span></span><span class="org-block">        </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">layout</span></span><span class="org-block"> = wibox.layout.align.horizontal()
        layout:set_left(left_layout)
        layout:set_right(right_layout)
        layout:set_middle(middle_layout)

        awful.titlebar(c):set_widget(layout)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">)

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">}}}
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Icon finder</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">icon_finder</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle icon_finder.lua</span>
<span class="org-special-keyword">:END:</span>

This is a module used to attempt to automatically find icons for programs.  It
is used by the <span class="org-link"><a href="nil:nil">[[#launchbar][launchbar]]</a></span> module, and menus (<span class="org-link"><a href="nil:nil">[[#main_menu][main menu]]</a></span> and <span class="org-link"><a href="nil:nil">[[#shutdown][shutdown menu]]</a></span>).  It
searches for icons in folders defined in the <span class="org-verbatim">=awesome_paths.iconapps_dir=</span>
variable (<span class="org-verbatim">=png=</span> and <span class="org-verbatim">=svg=</span> files).

<span class="org-meta-line">#+NAME: module-icon_finder</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">util</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.util"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">lfs</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"lfs"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">tonumber</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">tonumber</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">icon_finder</span></span><span class="org-block"> = {}
icon_finder.__index = icon_finder

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">icon_finder.new</span></span><span class="org-block">(icondirs_list)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">setmetatable</span></span><span class="org-block">({}, icon_finder)
   </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.icondirs_list = icondirs_list
   </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.subdir_list = {
      </span><span class="string"><span class="org-block">""</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"actions"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"animations"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"apps"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"categories"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"devices"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"emblems"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"emotes"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"mimetypes"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"places"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"special"</span></span><span class="org-block">,
      </span><span class="string"><span class="org-block">"status"</span></span><span class="org-block">
   }
   </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.ext_list = { </span><span class="string"><span class="org-block">"png"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"svg"</span></span><span class="org-block"> }
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">icon_finder:find</span></span><span class="org-block">(icon_name)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> icon_name == </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> icon_name </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> util.file_readable(icon_name) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> icon_name
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   wildcard = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sub</span></span><span class="org-block">(icon_name, 1, 1) == </span><span class="string"><span class="org-block">'*'</span></span><span class="org-block">

   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> wildcard </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      iname = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sub</span></span><span class="org-block">(icon_name, 2, -1)
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      iname = icon_name
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">ext</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.ext_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      iname = iname:gsub(</span><span class="string"><span class="org-block">"\."</span></span><span class="org-block"> .. ext .. </span><span class="string"><span class="org-block">"$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.icondirs_list </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v_base</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.icondirs_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v_sub</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.subdir_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            v = v_base .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. v_sub .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> wildcard </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> lfs.attributes(v, </span><span class="string"><span class="org-block">"mode"</span></span><span class="org-block">) == </span><span class="string"><span class="org-block">"directory"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">file</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> lfs.dir(v) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
                     f_attr = lfs.attributes(v .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. file, </span><span class="string"><span class="org-block">"mode"</span></span><span class="org-block">)
                     </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> f_attr </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> f_attr == </span><span class="string"><span class="org-block">"file"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                        i = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">find</span></span><span class="org-block">(file, iname)
                        </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> i </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                           </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> v .. </span><span class="string"><span class="org-block">'/'</span></span><span class="org-block"> .. file
                        </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">ext</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(</span><span class="builtin"><span class="org-block">self</span></span><span class="org-block">.ext_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(v .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. iname .. </span><span class="string"><span class="org-block">"."</span></span><span class="org-block"> .. ext) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                     </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> v .. </span><span class="string"><span class="org-block">'/'</span></span><span class="org-block"> .. iname .. </span><span class="string"><span class="org-block">"."</span></span><span class="org-block"> .. ext
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Return default icon if missing
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> beautiful.awesome_icon
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">setmetatable</span></span><span class="org-block">(icon_finder, { __call = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(cls, ...)
                                      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> cls.new(...) </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block"> })
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Global prompt </span><span class="org-checkbox-statistics-done">[13/13]</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">global_prompt</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle global_prompt.lua</span>
<span class="org-special-keyword">:END:</span>

The default awesome-wm configuration provides two prompts: one to execute shell
commands and one to execute lua code.  The <span class="org-verbatim">=global_prompt=</span> module is a custom
module aimed at simplifying the addition of prompts, similar to launchers such
as gnome-do, kupfer for instance.

A few prompts are also defined in this module, more can be added as needed.

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Imports</span>

This module requires basic awesome-wm libraries, and file system tools.

<span class="org-meta-line">#+NAME: module-global_prompt-setup</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">util</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful.util"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">lfs</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"lfs"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">runorraise</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"runorraise"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">capi</span></span><span class="org-block"> = {
  tag = tag,
  client = client,
  keygrabber = keygrabber,
  mouse = mouse,
  screen = screen
}
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">cmus</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"cmus"</span></span><span class="org-block">)

global_prompt = {}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Utilities</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">global_prompt_utils</span>
<span class="org-special-keyword">:END:</span>

First, define some helper functions:

- <span class="org-list-dt"><span class="org-verbatim">=generic_completion_wrapper=</span></span><span class="org-list-dt"> ::</span> build completion from a list of items.

- <span class="org-list-dt"><span class="org-verbatim">=table.val_to_str=</span></span><span class="org-list-dt"> ::</span> convert value to string.

- <span class="org-list-dt"><span class="org-verbatim">=table.key_to_str=</span></span><span class="org-list-dt"> ::</span> convert table key to string.

- <span class="org-list-dt"><span class="org-verbatim">=table.tostring=</span></span><span class="org-list-dt"> ::</span> convert table to string.

<span class="org-meta-line">#+NAME: module-global_prompt-utils</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">generic_completion_wrapper</span></span><span class="org-block">(kw, list, str, cur_pos, ncomp)
   out_str, out_pos = awful.completion.generic(str, cur_pos, ncomp, list)
   out_str = kw .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> .. out_str
   out_pos = out_pos + kw:len() + 1
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> out_str, out_pos
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.val_to_str ( v )
  </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"string"</span></span><span class="org-block"> == </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">( v ) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
    v = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">( v, </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"\\n"</span></span><span class="org-block"> )
    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">( </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(v,</span><span class="string"><span class="org-block">"[^'\"]"</span></span><span class="org-block">,</span><span class="string"><span class="org-block">""</span></span><span class="org-block">), </span><span class="string"><span class="org-block">'^"+$'</span></span><span class="org-block"> ) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"'"</span></span><span class="org-block"> .. v .. </span><span class="string"><span class="org-block">"'"</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">'"'</span></span><span class="org-block"> .. </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(v,</span><span class="string"><span class="org-block">'"'</span></span><span class="org-block">, </span><span class="string"><span class="org-block">'\\"'</span></span><span class="org-block"> ) .. </span><span class="string"><span class="org-block">'"'</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"table"</span></span><span class="org-block"> == </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">( v ) </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.tostring( v ) </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">tostring</span></span><span class="org-block">( v )
  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.key_to_str ( k )
  </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"string"</span></span><span class="org-block"> == </span><span class="builtin"><span class="org-block">type</span></span><span class="org-block">( k ) </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">match</span></span><span class="org-block">( k, </span><span class="string"><span class="org-block">"^[_%a][_%a%d]*$"</span></span><span class="org-block"> ) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> k
  </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"["</span></span><span class="org-block"> .. </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.val_to_str( k ) .. </span><span class="string"><span class="org-block">"]"</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.tostring( tbl )
  </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">result</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">done</span></span><span class="org-block"> = {}, {}
  </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">k</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">( tbl ) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">( result, </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.val_to_str( v ) )
    done[ k ] = </span><span class="constant"><span class="org-block">true</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">k</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">v</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">pairs</span></span><span class="org-block">( tbl ) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> done[ k ] </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">( result,
        </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.key_to_str( k ) .. </span><span class="string"><span class="org-block">"="</span></span><span class="org-block"> .. </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.val_to_str( v ) )
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
  </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"{"</span></span><span class="org-block"> .. </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">concat</span></span><span class="org-block">( result, </span><span class="string"><span class="org-block">","</span></span><span class="org-block"> ) .. </span><span class="string"><span class="org-block">"}"</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Prompts</span>

The prompts included in the module are listed here.  Prompts are called by
entering a keyword, followed by some arguments in the promptbox (i.e. the user
input is of the form <span class="org-verbatim">=KEYWORD ARGS=</span>).  A prompt is defined as follows:

<span class="org-meta-line">#+NAME: global_prompt_template</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua :tangle no :exports code
</span><span class="org-block">
global_prompt.prompt_TEMPLATE = {
   keyword={</span><span class="string"><span class="org-block">"?"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"h"</span></span><span class="org-block">}, </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">list of strings
</span></span><span class="org-block">   help=</span><span class="string"><span class="org-block">"Help message for prompt"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name)
      </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Execute code
</span></span><span class="org-block">   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">comp_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name, cur_pos, ncomp)
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(kw, { </span><span class="string"><span class="org-block">"AUTOCOMPLETE-WORD-1"</span></span><span class="org-block">,
                                              </span><span class="string"><span class="org-block">"AUTOCOMPLETE-WORD-2"</span></span><span class="org-block"> },
                                        name, cur_pos, ncomp)
}
</span><span class="org-block-end-line">#+END_SRC
</span>
A prompt is a table with the following entries:
- <span class="org-list-dt"><span class="org-verbatim">=keyword=</span></span><span class="org-list-dt"> ::</span> List of keywords for prompt.
- <span class="org-list-dt"><span class="org-verbatim">=help=</span></span><span class="org-list-dt"> ::</span> Help message (for use with <span class="org-link"><a href="nil:nil">[[#global_prompt_help][help prompt]]</a></span>).
- <span class="org-list-dt"><span class="org-verbatim">=run_function=</span></span><span class="org-list-dt"> ::</span> Function to run when calling the prompt.  The <span class="org-verbatim">=name=</span>
  parameter is the <span class="org-verbatim">=ARGS=</span> string passed from the prompt (the user input is
  <span class="org-verbatim">=KEYWORD ARGS=</span>).
- <span class="org-list-dt"><span class="org-verbatim">=comp_function=</span></span><span class="org-list-dt"> ::</span> Completion function which can be created using
  <span class="org-link"><a href="nil:nil">[[#global_prompt_utils][=generic_completion_wrapper=]]</a></span>.


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> help</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">global_prompt_help</span>
<span class="org-special-keyword">:END:</span>

The help prompt prints a list of the available prompts, along with the
corresponding help text as shown on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-global_prompt-help]]</a></span>.  The
keyword is <span class="org-verbatim">=h=</span> or <span class="org-verbatim">=?=</span>.

<span class="org-meta-line">#+NAME: module-global_prompt-help</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.prompt_help = {
   keyword={</span><span class="string"><span class="org-block">"?"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"h"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Show a list of available commands"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name)
      help_str = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">p</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(global_prompt.prompt_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         help_str = help_str .. </span><span class="string"><span class="org-block">"&lt;b&gt;["</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">ki</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">key</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(p[</span><span class="string"><span class="org-block">"keyword"</span></span><span class="org-block">]) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> ki &gt; 1 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               help_str = help_str .. </span><span class="string"><span class="org-block">", "</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            help_str = help_str .. key
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         help_str = help_str .. </span><span class="string"><span class="org-block">"]&lt;/b&gt;: "</span></span><span class="org-block"> .. p[</span><span class="string"><span class="org-block">"help"</span></span><span class="org-block">] .. </span><span class="string"><span class="org-block">"\n"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      naughty.notify( { text = </span><span class="string"><span class="org-block">"&lt;b&gt;&lt;u&gt;Command list&lt;/u&gt;&lt;/b&gt;\n"</span></span><span class="org-block"> .. help_str } )
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   comp_function = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>
The following script manually spawns the help box shown on
Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-global_prompt-help]]</a></span> and performs a screenshot.

<span class="org-meta-line">#+NAME: sh-scrot-global_prompt-help</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports code :tangle no :cache yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Could get these from xrandr
</span></span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block">=1920
</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block">=1080
</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block">=0 </span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">starts at 0
</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">req_str</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"local global_prompt = require(\"global_prompt\");"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">cmd_str</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"global_prompt.prompt_help.run_function()"</span></span><span class="org-block">

</span><span class="builtin"><span class="org-block">echo</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"$req_str $cmd_str"</span></span><span class="org-block"> | awesome-client

</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">=$(( 1 * $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> / 6 ))
</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">=160
</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> * $</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block"> + $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> - $</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block"> ))

sleep 0.5

scrot desktop.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">}+0 desktop-global_prompt-help.png
rm desktop.png -rf
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS[D64F1FDD8BA95C0EF4579B0F656F8047DC46F5F5]: sh-scrot-global_prompt-help</span>


<span class="org-meta-line">#+NAME: img-global_prompt-help</span>
<span class="org-meta-line">#+ATTR_HTML: :width 40%</span>
<span class="org-meta-line">#+CAPTION:</span> <span class="org-block">Help notification from global prompt.
</span><span class="org-link"><a href="file:../images/2016-10-05-Awesome-wm_configuration/desktop-global_prompt-help.png">[[file:../images/2016-10-05-Awesome-wm_configuration/desktop-global_prompt-help.png]]</a></span>



<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> session</span>

The session prompt offers session management commands (shutdown, restart,
logout, lock), similar to the <span class="org-link"><a href="nil:nil">[[#shutdown][shutdown menu]]</a></span>.  The keyword is <span class="org-verbatim">=s=</span>, so <span class="org-verbatim">=s
shutdown=</span> will trigger a shutdown (with confirmation prompt).

<span class="org-meta-line">#+NAME: module-global_prompt-session</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.prompt_session = {
   keyword={</span><span class="string"><span class="org-block">"s"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Session control (shutdown, restart, logout, lock)"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, cmd)
      </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">list of commands: mplayer -input cmdlist | more
</span></span><span class="org-block">      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"shutdown"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         my_utility.confirm_action(
            </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
               awful.util.spawn(</span><span class="string"><span class="org-block">'sudo /sbin/shutdown -h now'</span></span><span class="org-block">)
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Shutdown"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"restart"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         my_utility.confirm_action(
            </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
               awful.util.spawn(</span><span class="string"><span class="org-block">'sudo /sbin/shutdown -r now'</span></span><span class="org-block">)
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Restart"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"logout"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         my_utility.confirm_action(
            </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">()
               awesome.quit()
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"Logout"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"lock"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         awful.util.spawn(</span><span class="string"><span class="org-block">'xscreensaver-command -lock'</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">comp_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name, cur_pos, ncomp)
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(kw, { </span><span class="string"><span class="org-block">"shutdown"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"restart"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"logout"</span></span><span class="org-block">,
                                              </span><span class="string"><span class="org-block">"lock"</span></span><span class="org-block"> },
                                        name, cur_pos, ncomp)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> window</span>

The window prompt allows to quickly jump to an existing window.  It lists open
windows by their class and name and compares the argument to the listed
class / title pairs.  Tab completion is also implemented.

<span class="org-meta-line">#+NAME: module-global_prompt-window</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.prompt_window = {
   keyword={</span><span class="string"><span class="org-block">"j"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Jump to window"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, cmd)
      cmd_l = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(cmd)
      client_list = {}
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         client_list_s = capi.client.get(s)
         </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(client_list_s) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmd_l == </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(c.class .. </span><span class="string"><span class="org-block">": "</span></span><span class="org-block"> .. c.name) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               awful.client.jumpto(c)
               </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(client_list, {c, c.class .. </span><span class="string"><span class="org-block">": "</span></span><span class="org-block"> .. c.name})
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(client_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(c[1].name):find(cmd_l) </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(c[1].class):find(cmd_l) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            awful.client.jumpto(c[1])
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">comp_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name, cur_pos, ncomp)
      client_list = {}
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">s</span></span><span class="org-block"> = 1, screen.count() </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         client_list_s = capi.client.get(s)
         </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(client_list_s) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(client_list, </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(c.class .. </span><span class="string"><span class="org-block">": "</span></span><span class="org-block"> .. c.name))
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(kw, client_list,
                                        name, cur_pos, ncomp)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> calc</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">global_prompt_calc</span>
<span class="org-special-keyword">:END:</span>

The calculator prompt uses a python script to perform calculations.  It allows
simple math operations including common functions (e.g. trigonometric,
logarithmic etc.).

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Internal script</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle scripts/calc.py</span>
<span class="org-special-keyword">:END:</span>

The calculator script was adapted from <span class="org-link"><a href="http://www.peterbe.com/plog/calculator-in-python-for-dummies">[[http://www.peterbe.com/plog/calculator-in-python-for-dummies][this one]]</a></span>.

<span class="org-meta-line">#+NAME: script-calc-py</span>
<span class="org-block-begin-line">#+BEGIN_SRC python :mkdirp yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">#</span></span><span class="comment"><span class="org-block">!/usr/bin/python3
</span></span><span class="org-block">
</span><span class="string"><span class="org-block">""" A simple calculator """</span></span><span class="org-block">

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Imports</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> sys
</span><span class="keyword"><span class="org-block">import</span></span><span class="org-block"> math

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% Functions</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block"><a href="http://www.peterbe.com/plog/calculator-in-python-for-dummies">http://www.peterbe.com/plog/calculator-in-python-for-dummies</a>
</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">def</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">calc</span></span><span class="org-block">(expr, advanced=</span><span class="constant"><span class="org-block">True</span></span><span class="org-block">):
    </span><span class="keyword"><span class="org-block">def</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">safe_eval</span></span><span class="org-block">(expr, symbols={}):
       </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">eval</span></span><span class="org-block">(expr, </span><span class="builtin"><span class="org-block">dict</span></span><span class="org-block">(__builtins__=</span><span class="constant"><span class="org-block">None</span></span><span class="org-block">), symbols)
    </span><span class="keyword"><span class="org-block">def</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">whole_number_to_float</span></span><span class="org-block">(match):
       </span><span class="variable-name"><span class="org-block">group</span></span><span class="org-block"> = match.group()
       </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> group.find(</span><span class="string"><span class="org-block">'.'</span></span><span class="org-block">) == -1:
          </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> group + </span><span class="string"><span class="org-block">'.0'</span></span><span class="org-block">
       </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> group
    </span><span class="variable-name"><span class="org-block">expr</span></span><span class="org-block"> = expr.replace(</span><span class="string"><span class="org-block">'^'</span></span><span class="org-block">,</span><span class="string"><span class="org-block">'**'</span></span><span class="org-block">)
    </span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">expr = integers_regex.sub(whole_number_to_float, expr)
</span></span><span class="org-block">    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> advanced:
       </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> safe_eval(expr, </span><span class="builtin"><span class="org-block">vars</span></span><span class="org-block">(math))
    </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">:
       </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> safe_eval(expr)

</span><span class="python-cell-cellbreak"><span class="comment-delimiter"><span class="org-block"># </span></span></span><span class="python-cell-cellbreak"><span class="comment"><span class="org-block">%% main</span></span></span><span class="comment"><span class="org-block">
</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">__name__</span></span><span class="org-block"> == </span><span class="string"><span class="org-block">'__main__'</span></span><span class="org-block">:
    </span><span class="keyword"><span class="org-block">print</span></span><span class="org-block">(calc(</span><span class="string"><span class="org-block">' '</span></span><span class="org-block">.join(sys.argv[1:])))
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-4">**** </span><span class="org-done">DONE</span><span class="org-level-4"> Prompt definition</span>

The definition of the prompt is straightforward: the arguments are wrapped
around double quotes and passed to the <span class="org-verbatim">=calc.py=</span> script.  The result is shown in
a popup notification.

<span class="org-meta-line">#+NAME: module-global_prompt-calc</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.calc_cmd = </span><span class="string"><span class="org-block">"python3 "</span></span><span class="org-block"> .. awesome_paths.config_dir ..
   </span><span class="string"><span class="org-block">"/scripts/calc.py "</span></span><span class="org-block">
global_prompt.prompt_calc = {
   keyword={</span><span class="string"><span class="org-block">"c"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Calculator"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, expr)
      expr = expr:match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> expr.sub(1, 1) ~= </span><span class="string"><span class="org-block">"\""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         expr = </span><span class="string"><span class="org-block">"\""</span></span><span class="org-block"> .. expr
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> expr.sub(-1, 1) ~= </span><span class="string"><span class="org-block">"\""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         expr = expr .. </span><span class="string"><span class="org-block">"\""</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">err</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(global_prompt.calc_cmd .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> .. expr)
      </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">result</span></span><span class="org-block"> = c:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">):gsub(</span><span class="string"><span class="org-block">"\n$"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
      c:close()
      naughty.notify({ text = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sub</span></span><span class="org-block">(expr, 2, -2) .. </span><span class="string"><span class="org-block">" = "</span></span><span class="org-block"> .. result,
                       timeout = 10 })
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   comp_function = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> cmus</span>

The cmus prompt is an interface to the <span class="org-link"><a href="nil:nil">[[#cmus_play][cmus quick play command]]</a></span>.  The supported
arguments are:
- <span class="org-list-dt">play/pause/stop/next/prev ::</span> control playback,
- <span class="org-list-dt">info ::</span> spawn the <span class="org-link"><a href="nil:nil">[[#cmus_popup][cmus popup notification]]</a></span>,
- <span class="org-list-dt">random ::</span> play a random album,
- <span class="org-list-dt">album ::</span> play an album with title matching the remaining prompt arguments.


<span class="org-meta-line">#+NAME: module-global_prompt-cmus</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.prompt_cmus = {
   keyword={</span><span class="string"><span class="org-block">"cm"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"cmus remote"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, cmd)
      </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">list of commands: mplayer -input cmdlist | more
</span></span><span class="org-block">      mp_cmd = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
      mp_cmds = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"pause"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"p"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         mp_cmd = </span><span class="string"><span class="org-block">"--pause"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"play"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         mp_cmd = </span><span class="string"><span class="org-block">"--play"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"next"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         mp_cmd = </span><span class="string"><span class="org-block">"--next"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"prev"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         mp_cmd = </span><span class="string"><span class="org-block">"--prev"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"stop"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         mp_cmd = </span><span class="string"><span class="org-block">"--stop"</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"info"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"i"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         cmus_popup(5)
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> cmd == </span><span class="string"><span class="org-block">"random"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         cmus_play(</span><span class="string"><span class="org-block">"rand"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sub</span></span><span class="org-block">(cmd, 1, 5) == </span><span class="string"><span class="org-block">"album"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         album_name = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">sub</span></span><span class="org-block">(cmd, 6, -1):match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
         search_str = album_name
         search_str = search_str:gsub(</span><span class="string"><span class="org-block">"[ ]+"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">".*"</span></span><span class="org-block">)
         cmus_play(</span><span class="string"><span class="org-block">"album"</span></span><span class="org-block">, search_str)
      </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
         mp_cmd = cmd
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> mp_cmd </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         cmd = </span><span class="string"><span class="org-block">"cmus-remote "</span></span><span class="org-block"> .. mp_cmd
         awful.util.spawn_with_shell(cmd)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">comp_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name, cur_pos, ncomp)
      </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(kw, { </span><span class="string"><span class="org-block">"pause"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"play"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"next"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"prev"</span></span><span class="org-block">,
                                              </span><span class="string"><span class="org-block">"random"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"album"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"info"</span></span><span class="org-block"> },
                                        name, cur_pos, ncomp)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> music</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">global_prompt_music</span>
<span class="org-special-keyword">:END:</span>

The music prompt plays individual music files in <span class="org-verbatim">=mplayer=</span>, as opposed to the
cmus tools, which play albums using <span class="org-verbatim">=cmus=</span>.  The music folder is indexed into
the <span class="org-verbatim">=music.db=</span> file using the <span class="org-verbatim">=updatedb=</span> program, and song searches are
performed using the <span class="org-verbatim">=locate=</span> program (both parts of the <span class="org-verbatim">=findutils=</span> package).
The <span class="org-verbatim">=music.db=</span> file is updated on a schedule (daily) via <span class="org-verbatim">=crontab=</span>:

<span class="org-block-begin-line">#+BEGIN_SRC conf :tangle no
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Crontab entry for music database update
</span></span><span class="variable-name"><span class="org-block">0</span></span><span class="org-block"> 9 * * * updatedb --require-visibility 0 -U ~/data/music/ -o ~/data/music/music.db &gt; ~/log/update_musicdb.log
</span><span class="org-block-end-line">#+END_SRC
</span>
The music prompt defines two keywords:
- <span class="org-list-dt"><span class="org-verbatim">=m=</span></span><span class="org-list-dt"> ::</span> play an audio file (with file format in the list defined by
  <span class="org-verbatim">=global_prompt.music_ext_list=</span>).  The extra argument is either a full path
  to a file name in which case the file is played or a search string which is
  used to interrogate the <span class="org-verbatim">=music.db=</span> database and obtain a file to play.
- <span class="org-list-dt"><span class="org-verbatim">=mc=</span></span><span class="org-list-dt"> ::</span> control the existing mplayer instance via a named pipe constructed
  using <span class="org-verbatim">=mkfifo=</span>.  Available commands are <span class="org-verbatim">=pause=</span> (or <span class="org-verbatim">=p=</span>) and <span class="org-verbatim">=quit=</span> (or
  <span class="org-verbatim">=q=</span>).

Note that the spawned mplayer instance is given a custom class name (<span class="org-verbatim">=-c
tmplayer=</span>) to apply a custom <span class="org-link"><a href="nil:nil">[[#rules][rule]]</a></span> to it: it is placed on the same screen and
client as the main cmus instance.

The completion function for the <span class="org-verbatim">=m=</span> keyword performs a search on the argument
and returns the list of matching files in the <span class="org-verbatim">=music.db=</span> database.  Completion
for the <span class="org-verbatim">=mc=</span> keyword simply lists the available commands.

<span class="org-meta-line">#+NAME: module-global_prompt-mplayer</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.mplayer_pipe = </span><span class="string"><span class="org-block">"/tmp/awesome-mplayer.pipe"</span></span><span class="org-block">
global_prompt.music_folder = </span><span class="string"><span class="org-block">"/media/data/music/"</span></span><span class="org-block">
global_prompt.music_locate_db = global_prompt.music_folder .. </span><span class="string"><span class="org-block">"music.db"</span></span><span class="org-block">
global_prompt.music_ext_list = { </span><span class="string"><span class="org-block">".mp3"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">".flac"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">".ogg"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">".aac"</span></span><span class="org-block"> }
global_prompt.prompt_music = {
   keyword={</span><span class="string"><span class="org-block">"m"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"mc"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Open music files using locate db"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block">=</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> kw == </span><span class="string"><span class="org-block">"m"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         fname = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> name </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> util.file_readable(global_prompt.music_folder .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. name) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            fname = global_prompt.music_folder .. </span><span class="string"><span class="org-block">"/"</span></span><span class="org-block"> .. name
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            locate_file = global_prompt.music_locate_db
            search_str = name
            search_str = search_str:gsub(</span><span class="string"><span class="org-block">"['\"?!-:,]"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"\."</span></span><span class="org-block">)
            search_str = search_str:gsub(</span><span class="string"><span class="org-block">"[ ]+"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"\.*"</span></span><span class="org-block">)
            </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">ext</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(global_prompt.music_ext_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">m</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"locate -d "</span></span><span class="org-block"> .. locate_file ..
                  </span><span class="string"><span class="org-block">" -i --limit 1 -r \""</span></span><span class="org-block"> .. search_str .. </span><span class="string"><span class="org-block">".*\\"</span></span><span class="org-block"> ..
                  ext .. </span><span class="string"><span class="org-block">"$\""</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">err</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(m)
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mfile</span></span><span class="org-block"> = c:read(</span><span class="string"><span class="org-block">"*line"</span></span><span class="org-block">)
                  fname = mfile
                  c:close()
                  </span><span class="keyword"><span class="org-block">break</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> fname </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> music_player == </span><span class="string"><span class="org-block">"mplayer"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> lfs.attributes(global_prompt.mplayer_pipe, </span><span class="string"><span class="org-block">"mode"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  awful.util.spawn(</span><span class="string"><span class="org-block">"mkfifo "</span></span><span class="org-block"> .. global_prompt.mplayer_pipe)
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
               extra_args = </span><span class="string"><span class="org-block">" -slave -input file="</span></span><span class="org-block"> ..
                  global_prompt.mplayer_pipe .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
               extra_args = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            awful.util.spawn(termapps .. </span><span class="string"><span class="org-block">" -c tmplayer -e \""</span></span><span class="org-block"> ..
                                music_player .. extra_args .. </span><span class="string"><span class="org-block">" \\\""</span></span><span class="org-block"> ..
                                fname .. </span><span class="string"><span class="org-block">"\\\"\""</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            naughty.notify( {
                  text = name .. </span><span class="string"><span class="org-block">" not found ("</span></span><span class="org-block"> .. search_str .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block"> } )
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> kw == </span><span class="string"><span class="org-block">"mc"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">list of commands: mplayer -input cmdlist | more
</span></span><span class="org-block">         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> lfs.attributes(global_prompt.mplayer_pipe,
                           </span><span class="string"><span class="org-block">"mode"</span></span><span class="org-block">) == </span><span class="string"><span class="org-block">"named pipe"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> name == </span><span class="string"><span class="org-block">"pause"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> name == </span><span class="string"><span class="org-block">"p"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               mp_cmd = </span><span class="string"><span class="org-block">"pause"</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> name == </span><span class="string"><span class="org-block">"quit"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">or</span></span><span class="org-block"> name == </span><span class="string"><span class="org-block">"q"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
               mp_cmd = </span><span class="string"><span class="org-block">"quit"</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
               mp_cmd = name
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            cmd = </span><span class="string"><span class="org-block">"echo \""</span></span><span class="org-block"> .. mp_cmd .. </span><span class="string"><span class="org-block">"\" &gt; "</span></span><span class="org-block"> .. global_prompt.mplayer_pipe
            awful.util.spawn_with_shell(cmd)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">comp_function</span></span><span class="org-block">=</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, name, cur_pos, ncomp)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> #name == 0 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> name, cur_pos
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> kw == </span><span class="string"><span class="org-block">"m"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">file_list</span></span><span class="org-block"> = {}
         search_str = name
         search_str = search_str:gsub(</span><span class="string"><span class="org-block">"['\"?!-:,]"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"\."</span></span><span class="org-block">)
         search_str = search_str:gsub(</span><span class="string"><span class="org-block">"[ ]+"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"\.*"</span></span><span class="org-block">)
         </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">m</span></span><span class="org-block"> = </span><span class="string"><span class="org-block">"locate -d "</span></span><span class="org-block"> .. global_prompt.music_locate_db ..
                   </span><span class="string"><span class="org-block">" -i -r "</span></span><span class="org-block"> .. search_str
         </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">c</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">err</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">popen</span></span><span class="org-block">(m)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> c </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">mfiles</span></span><span class="org-block"> = c:read(</span><span class="string"><span class="org-block">"*all"</span></span><span class="org-block">)
            c:close()
            </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">line</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> mfiles:gmatch(</span><span class="string"><span class="org-block">"[^\r\n]+"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
               line_s = line:gsub(global_prompt.music_folder, </span><span class="string"><span class="org-block">""</span></span><span class="org-block">)
               </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> line_s </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">ext</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(global_prompt.music_ext_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
                     </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> line_s:find(</span><span class="string"><span class="org-block">"\."</span></span><span class="org-block"> .. ext .. </span><span class="string"><span class="org-block">"$"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
                        </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(file_list, line_s)
                     </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
                  </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
               </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
            </span><span class="builtin"><span class="org-block">io</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">stderr</span></span><span class="org-block">:write(err)
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> #file_list == 0 </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">while</span></span><span class="org-block"> ncomp &gt; #file_list </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
            ncomp = ncomp - #file_list
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"m "</span></span><span class="org-block"> .. file_list[ncomp], 3
      </span><span class="keyword"><span class="org-block">elseif</span></span><span class="org-block"> kw == </span><span class="string"><span class="org-block">"mc"</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(kw, { </span><span class="string"><span class="org-block">"pause"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"quit"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"volume"</span></span><span class="org-block"> },
                                           name, cur_pos, ncomp)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>


<span class="org-level-3">*** </span><span class="org-done">DONE</span><span class="org-level-3"> web                                                </span><span class="org-tag"><span class="org-level-3">:feature_request:</span></span>

The web prompt was originally aimed at handling questions where the answer would
be obtained from a web search (e.g. using <span class="org-link"><a href="https://duckduckgo.com/api">[[https://duckduckgo.com/api][duckduckgo]]</a></span> search API).  This is
currently not implemented and the web prompt simply spawns a web browser window,
and starts a duckduckgo search with the input arguments.

<span class="org-meta-line">#+NAME: module-global_prompt-web</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.search_url = </span><span class="string"><span class="org-block">"<a href="https://duckduckgo.com/?q=%s">https://duckduckgo.com/?q=%s</a>"</span></span><span class="org-block">
global_prompt.prompt_web = {
   keyword={</span><span class="string"><span class="org-block">"w"</span></span><span class="org-block">}, help=</span><span class="string"><span class="org-block">"Web search"</span></span><span class="org-block">,
   </span><span class="function-name"><span class="org-block">run_function</span></span><span class="org-block"> = </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block">(kw, expr)
      is_url = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">find</span></span><span class="org-block">(expr, </span><span class="string"><span class="org-block">"[.][0-9a-zA-Z]+$"</span></span><span class="org-block">)
      naughty.notify({text=is_url})
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> is_url == </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         expr_search = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">gsub</span></span><span class="org-block">(expr, </span><span class="string"><span class="org-block">"%s+"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"+"</span></span><span class="org-block">)
         expr_url = </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">format</span></span><span class="org-block">(global_prompt.search_url, expr_search)
      </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
         expr_url = expr
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      awful.util.spawn_with_shell(internet_browser .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> .. expr_url)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
   comp_function = </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">
}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Main prompt</span>

Once the prompts are defined they are added to the <span class="org-verbatim">=prompt_list=</span> table.  The
final part of the module defines the main hook handling user input.  The first
word in the user input is matched against known keywords, and, if a matching
prompt keyword is found, the remaining arguments are passed to the corresponding
<span class="org-verbatim">=run_function=</span> and <span class="org-verbatim">=comp_function=</span> to handle <span class="org-verbatim">=ENTER=</span> and <span class="org-verbatim">=TAB=</span> key presses
respectively.


<span class="org-meta-line">#+NAME: module-global_prompt-main</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
global_prompt.prompt_list = { global_prompt.prompt_help,
                              global_prompt.prompt_music,
                              global_prompt.prompt_calc,
                              global_prompt.prompt_cmus,
                              global_prompt.prompt_session,
                              global_prompt.prompt_window,
                              global_prompt.prompt_web }

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">global_prompt.run</span></span><span class="org-block">(str)
   str_stripped = str:match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> str_stripped:match(</span><span class="string"><span class="org-block">"%s"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      kw = str_stripped
      args = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      kw = str:match(</span><span class="string"><span class="org-block">"^%s*([^ ]+) .*$"</span></span><span class="org-block">)
      args = str:match(</span><span class="string"><span class="org-block">"^%s*[^ ]+ (.*)$"</span></span><span class="org-block">):match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">p</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(global_prompt.prompt_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">key</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(p[</span><span class="string"><span class="org-block">"keyword"</span></span><span class="org-block">]) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> key == kw </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> p[</span><span class="string"><span class="org-block">"run_function"</span></span><span class="org-block">](kw, args)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">global_prompt.comp</span></span><span class="org-block">(str, cur_pos, ncomp)
   str_stripped = str:match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
   </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> str_stripped:match(</span><span class="string"><span class="org-block">"%s"</span></span><span class="org-block">) </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
      kw = str_stripped
      args = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
      kw = str:match(</span><span class="string"><span class="org-block">"^%s*([^ ]+) .*$"</span></span><span class="org-block">)
      args = str:match(</span><span class="string"><span class="org-block">"^%s*[^ ]+ (.*)$"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> args </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
         args = args:match(</span><span class="string"><span class="org-block">"^%s*(.-)%s*$"</span></span><span class="org-block">)
      </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
         args = </span><span class="string"><span class="org-block">""</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">p</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(global_prompt.prompt_list) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">for</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">_</span></span><span class="org-block">, </span><span class="variable-name"><span class="org-block">key</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">in</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">ipairs</span></span><span class="org-block">(p[</span><span class="string"><span class="org-block">"keyword"</span></span><span class="org-block">]) </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block">
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> key == kw </span><span class="keyword"><span class="org-block">and</span></span><span class="org-block"> p[</span><span class="string"><span class="org-block">"comp_function"</span></span><span class="org-block">] </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> p[</span><span class="string"><span class="org-block">"comp_function"</span></span><span class="org-block">](kw, args, cur_pos, ncomp)
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> generic_completion_wrapper(</span><span class="string"><span class="org-block">""</span></span><span class="org-block">, {},
                                     str, cur_pos, ncomp)
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> global_prompt

</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">TODO:
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">X web search (parse answer / open in (text) browseer)
</span></span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">duckduckgo API
</span></span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">translator
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">X cmus control (random album?)
</span></span><span class="comment-delimiter"><span class="org-block">--   </span></span><span class="comment"><span class="org-block">mu4e control?
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">X Goto window
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">X mplayer: start in slave, control
</span></span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">(<a href="http://ubuntuforums.org/showthread.php?t=1629000">http://ubuntuforums.org/showthread.php?t=1629000</a>)
</span></span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Startup applications</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">startup_applications</span>
<span class="org-special-keyword">:END:</span>

The end of the <span class="org-verbatim">=rc.lua=</span> file contains a list of applications to run on startup.
Programs are spawned using the <span class="org-link"><a href="nil:nil">[[#my_utility_run_once][=run_once=]]</a></span> utility.  The applications launched on
startup are:
- <span class="org-verbatim">=dual_default.sh=</span> which is a <span class="org-verbatim">=xrandr=</span> script to setup my monitors
- <span class="org-verbatim">=numlock&amp;=</span> which switches the numlock key on
- the dropbox daemon
- the network-manager applet
- <span class="org-verbatim">=xscreensaver=</span> for screen locking
- the UPnP server <span class="org-link"><a href="https://wiki.gnome.org/Projects/Rygel">[[https://wiki.gnome.org/Projects/Rygel][=rygel=]]</a></span>
- the RSS reader <span class="org-verbatim">=newsbeuter=</span>
- the music player <span class="org-verbatim">=cmus=</span>

<span class="org-meta-line">#+NAME: src-startup-apps</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
my_utility.run_once(awesome_paths.config_dir .. </span><span class="string"><span class="org-block">"/scripts/dual_default.sh"</span></span><span class="org-block">)
my_utility.run_once(</span><span class="string"><span class="org-block">"numlockx&amp;"</span></span><span class="org-block">)
my_utility.run_once(awesome_paths.home_dir .. </span><span class="string"><span class="org-block">"/.dropbox-dist/dropboxd"</span></span><span class="org-block">) </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">dropbox
</span></span><span class="org-block">my_utility.run_once(</span><span class="string"><span class="org-block">"nm-applet"</span></span><span class="org-block">) </span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">networking
</span></span><span class="org-block">my_utility.run_once(</span><span class="string"><span class="org-block">"xscreensaver -nosplash"</span></span><span class="org-block">)
my_utility.run_once(</span><span class="string"><span class="org-block">"rygel"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">-- </span></span><span class="comment"><span class="org-block">Compositing (required for transparency)
</span></span><span class="comment-delimiter"><span class="org-block">--</span></span><span class="comment"><span class="org-block">my_utility.run_once("xcompmgr")
</span></span><span class="org-block">
my_utility.run_once(termapps .. </span><span class="string"><span class="org-block">" -c newsbeuter -e newsbeuter"</span></span><span class="org-block">)
my_utility.run_once(termapps .. </span><span class="string"><span class="org-block">" -c cmus -e cmus"</span></span><span class="org-block">)
</span><span class="comment-delimiter"><span class="org-block">--</span></span><span class="comment"><span class="org-block">run_or_raise(terminal)
</span></span><span class="comment-delimiter"><span class="org-block">--</span></span><span class="comment"><span class="org-block">my_utility.run_once("pidgin",nil,nil,2)
</span></span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Dual screen setup script</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle scripts/dual_default.sh</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=dual_default.sh=</span> script contains the following command (which should be
changed according to the monitor setup):

<span class="org-meta-line">#+NAME: script-dual_default-sh</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :mkdirp yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block">#</span></span><span class="comment"><span class="org-block">!/bin/sh
</span></span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Setup screens
</span></span><span class="org-block">xrandr --output HDMI-0 --mode 1920x1080 --pos 1920x0 --rotate normal </span><span class="sh-escaped-newline"><span class="org-block">\</span></span><span class="org-block">
       --output DP1 --off --output VGA-0 --mode 1920x1080 --pos 0x0 --rotate normal
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Utilities </span><span class="org-checkbox-statistics-done">[5/5]</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">my_utility</span>
<span class="org-special-keyword">:header-args+:</span> <span class="org-property-value">:tangle my_utility.lua</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=my_utility=</span> module contains some helper functions used throughout the
configuration.

<span class="org-meta-line">#+NAME: module-utility-imports</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">awful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"awful"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">naughty</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"naughty"</span></span><span class="org-block">)
</span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">beautiful</span></span><span class="org-block"> = </span><span class="builtin"><span class="org-block">require</span></span><span class="org-block">(</span><span class="string"><span class="org-block">"beautiful"</span></span><span class="org-block">)

my_utility = {}
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> String split</span>

The <span class="org-verbatim">=my_utility.lines=</span> function splits the input string by rows.  A table with
the lines is returned; it can be iterated over using <span class="org-verbatim">=for k, v in
pairs(lines_output)=</span>.  This was taken from <span class="org-link"><a href="http://lua-users.org/wiki/SplitJoin">[[http://lua-users.org/wiki/SplitJoin]]</a></span>.

<span class="org-meta-line">#+NAME: module-utility-lines</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">my_utility.lines</span></span><span class="org-block">(str)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block"> = {}
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">helper</span></span><span class="org-block">(line) </span><span class="builtin"><span class="org-block">table</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">insert</span></span><span class="org-block">(t, line) </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="string"><span class="org-block">""</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   helper((str:gsub(</span><span class="string"><span class="org-block">"(.-)\r?\n"</span></span><span class="org-block">, helper)))
   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> t
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> HTML escape</span>

Notifications in awesome-wm accept HTML inputs, but there is no built-in
function to cleanup strings.  The <span class="org-verbatim">=my_utility.html_escape=</span> function provides
some very basic escaping.

<span class="org-meta-line">#+NAME: module-utility-html_escape</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">my_utility.html_escape</span></span><span class="org-block">(str)
   </span><span class="keyword"><span class="org-block">local</span></span><span class="org-block"> </span><span class="variable-name"><span class="org-block">t</span></span><span class="org-block"> = str
   t = t:gsub(</span><span class="string"><span class="org-block">"&amp;"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"&amp;amp;"</span></span><span class="org-block">)
   t = t:gsub(</span><span class="string"><span class="org-block">"&lt;"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"&amp;lt;"</span></span><span class="org-block">)
   t = t:gsub(</span><span class="string"><span class="org-block">"&gt;"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"&amp;gt;"</span></span><span class="org-block">)
   t = t:gsub(</span><span class="string"><span class="org-block">"'"</span></span><span class="org-block">, </span><span class="string"><span class="org-block">"&amp;apos;"</span></span><span class="org-block">)

   </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> t
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Confirmation popup</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">my_utility_confirm</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=my_utility.confirm_action=</span> is used with the <span class="org-link"><a href="nil:nil">[[#shutdown][shutdown menu]]</a></span> to prompt for
confirmation before performing actions (e.g. shutdown).  It uses a promptbox
placed on each wibox and runs the function <span class="org-verbatim">=func=</span> when the "y" character is
entered in the promptbox.  Note that, since the promptbox is barely visible, the
color of the whole wibox (on the current screen) is temporarily set to
<span class="org-verbatim">=beautiful.bg_urgent=</span> / <span class="org-verbatim">=beautiful.fg_urgent=</span>.

<span class="org-meta-line">#+NAME: module-utility-confirm</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">my_utility.confirm_action</span></span><span class="org-block">(func, name)
   mywibox[mouse.screen]:set_bg(beautiful.bg_urgent)
   mywibox[mouse.screen]:set_fg(beautiful.fg_urgent)
   awful.prompt.run({prompt = name .. </span><span class="string"><span class="org-block">" [y/N] "</span></span><span class="org-block">},
      mypromptbox_conf[mouse.screen].widget,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> (t)
         </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="builtin"><span class="org-block">string</span></span><span class="org-block">.</span><span class="builtin"><span class="org-block">lower</span></span><span class="org-block">(t) == </span><span class="string"><span class="org-block">'y'</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
            func()
         </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">,
      </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">, </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block">, 0,
      </span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> ()
         mywibox[mouse.screen]:set_bg(beautiful.screen_highlight_bg_active)
         mywibox[mouse.screen]:set_fg(beautiful.screen_highlight_fg_active)
      </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
   )
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>
Here is an example of usage using <span class="org-verbatim">=awesome-client=</span>, with a screenshot of the
confirmation prompt on Fig.<span class="org-macro">{{{tt}}}</span><span class="org-link"><a href="nil:nil">[[img-confirm_action]]</a></span>.

<span class="org-meta-line">#+NAME: sh-scrot-confirm_action</span>
<span class="org-block-begin-line">#+BEGIN_SRC sh :exports code :tangle no :cache yes
</span><span class="org-block">
</span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">Could get these from xrandr
</span></span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block">=1920
</span><span class="variable-name"><span class="org-block">res_y</span></span><span class="org-block">=1080
</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block">=1 </span><span class="comment-delimiter"><span class="org-block"># </span></span><span class="comment"><span class="org-block">starts at 0
</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">req_str</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"local my_utility = require(\"my_utility\");"</span></span><span class="org-block">
</span><span class="variable-name"><span class="org-block">cmd_str</span></span><span class="org-block">=</span><span class="string"><span class="org-block">"my_utility.confirm_action(function () end, \"Shutdown\")"</span></span><span class="org-block">

</span><span class="builtin"><span class="org-block">echo</span></span><span class="org-block"> </span><span class="string"><span class="org-block">"$req_str $cmd_str"</span></span><span class="org-block"> | awesome-client

</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">=$(( 3 * $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> / 8 ))
</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">=25
</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">=$(( $</span><span class="variable-name"><span class="org-block">res_x</span></span><span class="org-block"> * $</span><span class="variable-name"><span class="org-block">screen_idx</span></span><span class="org-block"> ))

sleep 0.5

scrot desktop.png
convert desktop.png -crop ${</span><span class="variable-name"><span class="org-block">width</span></span><span class="org-block">}x${</span><span class="variable-name"><span class="org-block">height</span></span><span class="org-block">}+${</span><span class="variable-name"><span class="org-block">start_x</span></span><span class="org-block">}+0 desktop-confirm_action.png
rm desktop.png -rf
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS[697AAFE023955683CD8753808C2394DEF30198C0]: sh-scrot-confirm_action</span>

<span class="org-meta-line">#+NAME: img-confirm_action</span>
<span class="org-meta-line">#+ATTR_HTML: :width 60%</span>
<span class="org-meta-line">#+CAPTION:</span> <span class="org-block">Confirmation prompt before shutdown (left-most text).
</span><span class="org-link"><a href="file:../images/2016-10-05-Awesome-wm_configuration/desktop-confirm_action.png">[[file:../images/2016-10-05-Awesome-wm_configuration/desktop-confirm_action.png]]</a></span>


<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Run once</span>
<span class="org-special-keyword">:PROPERTIES:</span>
<span class="org-special-keyword">:CUSTOM_ID:</span> <span class="org-property-value">my_utility_run_once</span>
<span class="org-special-keyword">:END:</span>

The <span class="org-verbatim">=run_once=</span> utility is a commonly used lua function to spawn a program if is
not already running.  The code is from
<span class="org-link"><a href="https://awesome.naquadah.org/wiki/Autostart">[[https://awesome.naquadah.org/wiki/Autostart]]</a></span>.

<span class="org-meta-line">#+NAME: module-utility-run_once</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">function</span></span><span class="org-block"> </span><span class="function-name"><span class="org-block">my_utility.run_once</span></span><span class="org-block">(prg, arg_string, pname, screen)
    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> prg </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
        </span><span class="keyword"><span class="org-block">do</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> </span><span class="constant"><span class="org-block">nil</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> pname </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
       pname = prg
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">

    </span><span class="keyword"><span class="org-block">if</span></span><span class="org-block"> </span><span class="keyword"><span class="org-block">not</span></span><span class="org-block"> arg_string </span><span class="keyword"><span class="org-block">then</span></span><span class="org-block">
       awful.util.spawn_with_shell(</span><span class="string"><span class="org-block">"pgrep -f -u $USER -x '"</span></span><span class="org-block"> .. pname ..
                                      </span><span class="string"><span class="org-block">"' || ("</span></span><span class="org-block"> .. prg .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block">,screen)
    </span><span class="keyword"><span class="org-block">else</span></span><span class="org-block">
       awful.util.spawn_with_shell(</span><span class="string"><span class="org-block">"pgrep -f -u $USER -x '"</span></span><span class="org-block"> .. pname .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block">..
                                      arg_string ..</span><span class="string"><span class="org-block">"' || ("</span></span><span class="org-block"> .. prg .. </span><span class="string"><span class="org-block">" "</span></span><span class="org-block"> ..
                                      arg_string .. </span><span class="string"><span class="org-block">")"</span></span><span class="org-block">,screen)
    </span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="keyword"><span class="org-block">end</span></span><span class="org-block">
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-2">** </span><span class="org-done">DONE</span><span class="org-level-2"> Return object</span>

The module is instantiated by <span class="org-verbatim">=local my_utility = require("my_utility")=</span> and
functions are called using <span class="org-verbatim">=my_utility.function(...)=</span>.

<span class="org-meta-line">#+NAME: module-utility-close</span>
<span class="org-block-begin-line">#+BEGIN_SRC lua
</span><span class="org-block">
</span><span class="keyword"><span class="org-block">return</span></span><span class="org-block"> my_utility
</span><span class="org-block-end-line">#+END_SRC
</span>

<span class="org-level-1">* </span><span class="org-done">DONE</span><span class="org-level-1"> Resources</span>

- awesome wiki: <span class="org-link"><a href="https://awesome.naquadah.org/wiki">[[https://awesome.naquadah.org/wiki]]</a></span> (this may disappear in the
  future as described in <span class="org-link"><a href="https://github.com/awesomeWM/awesome-www/issues/7">[[https://github.com/awesomeWM/awesome-www/issues/7]]</a></span>)
- awesome-wm API: <span class="org-link"><a href="http://new.awesomewm.org/doc/api">[[http://new.awesomewm.org/doc/api]]</a></span>
- blingbling examples: <span class="org-link"><a href="https://github.com/cedlemo/blingbling">[[https://github.com/cedlemo/blingbling]]</a></span>
- Themes:
  - <span class="org-link"><a href="https://awesome.naquadah.org/wiki/Beautiful_themes">[[https://awesome.naquadah.org/wiki/Beautiful_themes]]</a></span>
  - <span class="org-link"><a href="https://github.com/copycat-killer/awesome-copycats">[[https://github.com/copycat-killer/awesome-copycats]]</a></span>



<span class="org-level-1">* Notes                                                            </span><span class="org-tag"><span class="org-level-1">:noexport:</span></span>

- <span class="org-checkbox">[X]</span> <span class="org-link"><a href="https://expoundite.net/guides/dotfile-management">[[https://expoundite.net/guides/dotfile-management]]</a></span>
  - <span class="org-checkbox">[X]</span> :tangle: property in subtree
  - <span class="org-checkbox">[X]</span> Get passwords from .authinfo.gpg
- <span class="org-checkbox">[-]</span> How to manage conditional tangling?
  - <span class="org-checkbox">[X]</span> Add a tag on subtree should work.
  - <span class="org-checkbox">[ ]</span> Add a tag to source block itself?  This may cause issues when multiple
    blocks update the same file and dependencies can be missed.
- <span class="org-checkbox">[ ]</span> How to add a label with the tangle filename on each exported source block?
- <span class="org-checkbox">[ ]</span> screensaver configuration
- <span class="org-checkbox">[X]</span> Use <span class="org-verbatim">=CUSTOM_ID=</span> for links
</pre>
  </body>
</html>
